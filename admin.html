<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Administraci√≥n - YA ME VI</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="assets/favicon-circle.svg?v=6">
  <link rel="apple-touch-icon" href="assets/apple-touch-icon.png">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="assets/apple-touch-icon.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2226536008153511"
     crossorigin="anonymous"></script>

  <style>
    body {
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #1e40af 100%);
      min-height: 100vh;
    }
    
    .admin-card {
      backdrop-filter: blur(10px);
      background: rgba(31, 41, 55, 0.8);
      border: 1px solid rgba(156, 163, 175, 0.2);
      transition: all 0.3s ease;
    }
    
    .admin-card:hover {
      background: rgba(31, 41, 55, 0.9);
      border-color: rgba(156, 163, 175, 0.4);
    }
    
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
      animation: pulse 2s infinite;
    }
    
    .status-online { background-color: #10b981; }
    .status-offline { background-color: #ef4444; }
    .status-warning { background-color: #f59e0b; }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body class="text-white">
  <div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
      <div>
        <h1 class="text-4xl font-bold text-white mb-2">üìä Panel de Administraci√≥n</h1>
        <p class="text-blue-200">YA ME VI - Sistema de Control</p>
      </div>
      <div class="flex items-center space-x-4">
        <div class="flex items-center">
          <span class="status-indicator status-warning" id="connection-indicator"></span>
          <div id="admin-status" class="text-yellow-400 font-medium">üîÑ Verificando...</div>
        </div>
        <button onclick="window.location.href='index.html'" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg">
          üè† Home
        </button>
      </div>
    </div>

    <!-- System Status -->
    <div class="admin-card p-4 rounded-lg mb-8">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <span class="status-indicator status-warning" id="system-status-indicator"></span>
          <span id="system-status" class="text-blue-200">üîÑ Inicializando...</span>
        </div>
        <div id="last-update" class="text-gray-400 text-sm">--</div>
      </div>
    </div>

    <!-- Metrics Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <!-- Total Users -->
      <div class="admin-card p-6 rounded-lg">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-400 text-sm">Usuarios Activos</p>
            <p id="total-users" class="text-3xl font-bold text-green-400">0</p>
          </div>
          <div class="bg-green-500 p-3 rounded-full">
            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path>
            </svg>
          </div>
        </div>
      </div>

      <!-- Daily Queries -->
      <div class="admin-card p-6 rounded-lg">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-400 text-sm">Consultas Hoy</p>
            <p id="daily-queries" class="text-3xl font-bold text-blue-400">0</p>
          </div>
          <div class="bg-blue-500 p-3 rounded-full">
            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
        </div>
      </div>

      <!-- Total Analysis -->
      <div class="admin-card p-6 rounded-lg">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-400 text-sm">An√°lisis Total</p>
            <p id="total-analysis" class="text-3xl font-bold text-yellow-400">0</p>
          </div>
          <div class="bg-yellow-500 p-3 rounded-full">
            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
              <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"></path>
            </svg>
          </div>
        </div>
      </div>

      <!-- Database Records -->
      <div class="admin-card p-6 rounded-lg">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-400 text-sm">Registros en DB</p>
            <p id="db-records" class="text-3xl font-bold text-purple-400">0</p>
          </div>
          <div class="bg-purple-500 p-3 rounded-full">
            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
              <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"></path>
            </svg>
          </div>
        </div>
      </div>
    </div>

    <!-- Notifications Section -->
    <div class="admin-card p-6 rounded-lg mb-8">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold">üîî Sistema de Notificaciones</h3>
        <span class="text-sm text-gray-400">Inicializando...</span>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-400 text-sm">Push Enviadas</p>
              <p id="push-sent" class="text-2xl font-bold text-blue-400">0</p>
            </div>
            <div class="text-blue-400">üìß</div>
          </div>
        </div>
        
        <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-400 text-sm">In-App Activas</p>
              <p id="inapp-active" class="text-2xl font-bold text-green-400">0</p>
            </div>
            <div class="text-green-400">üì±</div>
          </div>
        </div>
        
        <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-400 text-sm">Emails Enviados</p>
              <p id="emails-sent" class="text-2xl font-bold text-yellow-400">0</p>
            </div>
            <div class="text-yellow-400">‚úâÔ∏è</div>
          </div>
        </div>
      </div>
      
      <!-- Notification Creation -->
      <div class="border-t border-gray-600 pt-6">
        <h4 class="text-lg font-medium mb-4">‚úèÔ∏è Crear Nueva Notificaci√≥n</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-400 mb-2">T√≠tulo</label>
            <input type="text" id="notification-title" placeholder="Nuevas Predicciones Disponibles" 
                   class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:border-blue-500 focus:outline-none">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-400 mb-2">Tipo</label>
            <select id="notification-type" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:border-blue-500 focus:outline-none">
              <option value="general">üîî General</option>
              <option value="prediction">üéØ Predicci√≥n</option>
              <option value="maintenance">‚öôÔ∏è Mantenimiento</option>
            </select>
          </div>
        </div>
        <div class="mt-4">
          <label class="block text-sm font-medium text-gray-400 mb-2">Mensaje</label>
          <textarea id="notification-message" rows="3" placeholder="Escribe el mensaje..."
                    class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:border-blue-500 focus:outline-none"></textarea>
        </div>
        <div class="mt-4 flex justify-end">
          <button onclick="sendNotification()" class="bg-green-600 hover:bg-green-700 px-6 py-2 rounded-lg transition-colors">
            üì§ Enviar Notificaci√≥n
          </button>
        </div>
      </div>
    </div>

    <!-- Users Table -->
    <div class="admin-card p-6 rounded-lg mb-8">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-semibold">üë• Usuarios Recientes</h3>
        <div class="text-sm text-gray-400">
          <span id="users-count">0</span> usuarios registrados
        </div>
      </div>
      
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-gray-600">
              <th class="text-left py-3 px-4 font-medium text-gray-300">Email</th>
              <th class="text-left py-3 px-4 font-medium text-gray-300">Nombre</th>
              <th class="text-left py-3 px-4 font-medium text-gray-300">Registro</th>
              <th class="text-left py-3 px-4 font-medium text-gray-300">Estado</th>
            </tr>
          </thead>
          <tbody id="users-table-body">
            <tr>
              <td colspan="4" class="text-center py-8 text-gray-400">
                üîÑ Cargando usuarios...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="admin-card p-6 rounded-lg">
      <h3 class="text-xl font-semibold mb-6">‚ö° Acciones R√°pidas</h3>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <button onclick="refreshAllData()" class="bg-blue-600 hover:bg-blue-700 p-4 rounded-lg transition-colors text-center">
          <div class="text-2xl mb-2">üîÑ</div>
          <div class="font-medium">Actualizar</div>
        </button>
        
        <button onclick="exportData()" class="bg-green-600 hover:bg-green-700 p-4 rounded-lg transition-colors text-center">
          <div class="text-2xl mb-2">üìä</div>
          <div class="font-medium">Exportar</div>
        </button>
        
        <button onclick="viewLogs()" class="bg-orange-600 hover:bg-orange-700 p-4 rounded-lg transition-colors text-center">
          <div class="text-2xl mb-2">üìã</div>
          <div class="font-medium">Ver Logs</div>
        </button>
        
        <button onclick="manageDB()" class="bg-purple-600 hover:bg-purple-700 p-4 rounded-lg transition-colors text-center">
          <div class="text-2xl mb-2">üóÑÔ∏è</div>
          <div class="font-medium">Gestionar DB</div>
        </button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    // === CONFIGURACI√ìN FIREBASE ===
    const firebaseConfig = {
      apiKey: "AIzaSyB4bCGyyPuQo-3-ONMPFKtqPEJDFl8Cb54",
      authDomain: "ya-me-vi.firebaseapp.com",
      projectId: "ya-me-vi",
      storageBucket: "ya-me-vi.firebasestorage.app",
      messagingSenderId: "748876890843",
      appId: "1:748876890843:web:070d1eb476d38594d002fe"
    };

    // === ADMIN EMAILS AUTORIZADOS ===
    const ADMIN_EMAILS = [
      'gfigueroa.w@gmail.com',
      'eugenfw@gmail.com', 
      'admin@yamevi.com.mx',
      'guillermo.figueroaw@totalplay.com.mx'
    ];

    // === VARIABLES GLOBALES ===
    let currentUser = null;
    let isUserAdmin = false;
    let app = null;
    let auth = null;
    let db = null;

    // === FUNCIONES UTILIDAD ===
    function updateIndicator(id, status) {
      const indicator = document.getElementById(id);
      if (indicator) {
        indicator.className = `status-indicator status-${status}`;
      }
    }

    function formatDate(timestamp) {
      if (!timestamp) return 'N/A';
      try {
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        return date.toLocaleDateString('es-MX', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (error) {
        return 'N/A';
      }
    }

    function showError(message) {
      console.error('‚ùå Error:', message);
      document.getElementById('system-status').textContent = `‚ùå ${message}`;
      updateIndicator('system-status-indicator', 'offline');
    }

    function showSuccess(message) {
      console.log('‚úÖ', message);
      document.getElementById('system-status').textContent = `‚úÖ ${message}`;
      updateIndicator('system-status-indicator', 'online');
    }

    // === VERIFICACI√ìN DE ADMIN ===
    function isEmailAdmin(email) {
      if (!email) return false;
      const adminEmails = [
        'gfigueroa.w@gmail.com',
        'eugenfw@gmail.com', 
        'admin@yamevi.com.mx',
        'guillermo.figueroaw@totalplay.com.mx'
      ];
      const isAdmin = adminEmails.includes(email.toLowerCase());
      console.log(`üîç Verificando admin: ${email} -> ${isAdmin}`);
      return isAdmin;
    }
    
    // === CREAR DOCUMENTO ADMIN SI NO EXISTE ===
    async function ensureAdminDocument(user) {
      if (!db || !user) return false;
      
      try {
        const { doc, setDoc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
        
        console.log(`üîß Verificando documento admin para: ${user.email}`);
        
        // Verificar si ya existe el documento
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        
        if (!userDoc.exists() || !userDoc.data().isAdmin) {
          console.log('üìù Creando/actualizando documento admin...');
          
          await setDoc(doc(db, 'users', user.uid), {
            email: user.email,
            displayName: user.displayName || user.email.split('@')[0],
            isAdmin: true,
            adminLevel: 'superadmin',
            fechaRegistro: new Date().toISOString(),
            ultimoAcceso: new Date().toISOString(),
            createdBy: 'admin-panel'
          }, { merge: true });
          
          console.log('‚úÖ Documento admin creado/actualizado');
          return true;
        }
        
        console.log('‚úÖ Documento admin ya existe');
        return true;
        
      } catch (error) {
        console.error('‚ùå Error creando documento admin:', error);
        return false;
      }
    }

    // === INICIALIZACI√ìN ===
    async function initializeAdmin() {
      console.log('ÔøΩ Inicializando panel de administraci√≥n...');
      
      try {
        // Cargar Firebase din√°micamente
        const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js');
        const { getAuth, onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js');
        const { getFirestore, collection, getDocs, doc, getDoc, query, orderBy, limit, addDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
        
        // Inicializar Firebase
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        
        console.log('‚úÖ Firebase inicializado');
        
        // Escuchar cambios de autenticaci√≥n
        onAuthStateChanged(auth, async (user) => {
          const statusElement = document.getElementById('admin-status');
          
          if (user) {
            currentUser = user;
            console.log('üë§ Usuario conectado:', user.email, 'UID:', user.uid);
            
            // Verificar si es admin por email
            isUserAdmin = isEmailAdmin(user.email);
            
            if (isUserAdmin) {
              statusElement.textContent = `‚úÖ Admin: ${user.email}`;
              statusElement.className = 'text-green-400 font-medium';
              updateIndicator('connection-indicator', 'online');
              
              console.log('üëë Acceso de admin confirmado por email');
              
              // Crear documento admin si no existe
              console.log('üîß Asegurando documento admin...');
              await ensureAdminDocument(user);
              
              // Cargar datos con manejo de errores robusto
              try {
                console.log('üìä Iniciando carga de datos...');
                await loadAdminData();
                console.log('üîÑ Iniciando auto-refresh...');
                startAutoRefresh();
              } catch (loadError) {
                console.error('‚ùå Error cargando datos iniciales:', loadError);
                showError('Panel cargado - Algunos datos pueden tener restricciones');
                
                // A√∫n as√≠ iniciar auto-refresh para intentos posteriores
                startAutoRefresh();
              }
              
            } else {
              statusElement.textContent = `‚ùå Sin permisos: ${user.email}`;
              statusElement.className = 'text-red-400 font-medium';
              updateIndicator('connection-indicator', 'offline');
              
              alert(`‚ùå Acceso denegado\\n\\nUsuario: ${user.email}\\n\\nSolo administradores autorizados pueden acceder.`);
              window.location.href = 'home.html';
            }
            
          } else {
            console.log('‚ùå Usuario no autenticado');
            statusElement.textContent = 'üîí No autenticado - Redirigiendo...';
            statusElement.className = 'text-yellow-400 font-medium';
            updateIndicator('connection-indicator', 'warning');
            
            setTimeout(() => {
              window.location.href = 'login.html?redirect=admin';
            }, 2000);
          }
        });
        
        // Hacer funciones globales disponibles
        window.refreshAllData = refreshAllData;
        window.sendNotification = sendNotification;
        window.exportData = exportData;
        window.viewLogs = viewLogs;
        window.manageDB = manageDB;
        
      } catch (error) {
        console.error('‚ùå Error inicializando Firebase:', error);
        showError('Error de conexi√≥n con Firebase');
        document.getElementById('admin-status').textContent = '‚ùå Error de conexi√≥n';
        document.getElementById('admin-status').className = 'text-red-400 font-medium';
      }
    }

    // === CARGAR DATOS DEL ADMIN ===
    async function loadAdminData() {
      if (!isUserAdmin || !db) {
        console.warn('‚ö†Ô∏è No se puede cargar datos - Admin:', isUserAdmin, 'DB:', !!db);
        return;
      }
      
      console.log('üìä Iniciando carga de datos del admin...');
      
      try {
        // Cargar datos de manera secuencial para mejor debugging
        console.log('üîÑ Paso 1: Cargando usuarios...');
        await loadUsers();
        
        console.log('üîÑ Paso 2: Cargando estad√≠sticas...');
        await loadStats();
        
        // Solo mostrar √©xito si ambas funciones se ejecutaron
        showSuccess('Panel cargado - Firebase operativo');
        
        const now = new Date().toLocaleString('es-MX', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
        document.getElementById('last-update').textContent = `Actualizado: ${now}`;
        
        console.log('‚úÖ Carga completa de datos del admin finalizada');
        
      } catch (error) {
        console.error('‚ùå Error en la carga general de datos:', error);
        showError(`Error: ${error.message || 'Problema de conexi√≥n'}`);
        
        // A√∫n intentar mostrar algo en caso de error parcial
        const now = new Date().toLocaleString('es-MX');
        document.getElementById('last-update').textContent = `Error: ${now}`;
      }
    }

    // === CARGAR USUARIOS ===
    async function loadUsers() {
      if (!db) {
        console.warn('‚ö†Ô∏è Base de datos no disponible');
        return;
      }
      
      console.log('üìä === INICIANDO CARGA DE USUARIOS ===');
      console.log('ÔøΩ Usuario actual:', currentUser?.email, 'UID:', currentUser?.uid);
      
      try {
        const { collection, getDocs, query, orderBy, limit } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
        
        console.log('üì¶ M√≥dulos de Firestore importados correctamente');
        
        // Intentar acceso directo primero
        console.log('üéØ Intentando acceso directo a colecci√≥n users...');
        let snapshot;
        
        try {
          // Intentar obtener todos los usuarios sin ordenamiento primero
          console.log('üîç Paso 1: Acceso b√°sico a users...');
          snapshot = await getDocs(collection(db, 'users'));
          console.log(`‚úÖ Acceso b√°sico exitoso: ${snapshot.size} documentos`);
        } catch (basicError) {
          console.error('‚ùå Error en acceso b√°sico:', basicError.code, basicError.message);
          throw basicError;
        }
        
        // Si el acceso b√°sico funciona, intentar con ordenamiento
        if (snapshot.size > 0) {
          console.log('üîç Paso 2: Intentando con ordenamiento...');
          try {
            const usersQuery = query(collection(db, 'users'), orderBy('fechaRegistro', 'desc'), limit(50));
            snapshot = await getDocs(usersQuery);
            console.log(`‚úÖ Ordenamiento por fechaRegistro exitoso: ${snapshot.size} documentos`);
          } catch (orderError) {
            console.warn('‚ö†Ô∏è Error ordenando por fechaRegistro:', orderError.message);
            try {
              const usersQuery = query(collection(db, 'users'), orderBy('ultimoAcceso', 'desc'), limit(50));
              snapshot = await getDocs(usersQuery);
              console.log(`‚úÖ Ordenamiento por ultimoAcceso exitoso: ${snapshot.size} documentos`);
            } catch (orderError2) {
              console.warn('‚ö†Ô∏è Error ordenando por ultimoAcceso:', orderError2.message);
              // Usar snapshot b√°sico sin ordenamiento
              console.log('üìù Usando snapshot b√°sico sin ordenamiento');
            }
          }
        }
        
        const userCount = snapshot.size;
        console.log(`üìä Total usuarios obtenidos: ${userCount}`);
        
        document.getElementById('total-users').textContent = userCount;
        document.getElementById('users-count').textContent = userCount;
        
        const tbody = document.getElementById('users-table-body');
        tbody.innerHTML = '';
        
        if (snapshot.empty) {
          tbody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-gray-400">No hay usuarios registrados</td></tr>';
          console.log('üìä No hay usuarios en la base de datos');
          return;
        }
        
        let rowsAdded = 0;
        console.log('üîÑ Procesando documentos de usuarios...');
        
        snapshot.forEach((doc) => {
          try {
            const data = doc.data();
            console.log(`üë§ Procesando usuario: ${data.email || 'Sin email'} (${doc.id})`);
            
            const row = document.createElement('tr');
            row.className = 'border-b border-gray-700 hover:bg-gray-800';
            
            const email = data.email || 'Sin email';
            const isAdmin = isEmailAdmin(email) ? 
              ' <span class="ml-2 px-2 py-1 bg-yellow-600 text-xs rounded">ADMIN</span>' : '';
            
            row.innerHTML = `
              <td class="py-3 px-4">
                <div class="flex items-center">
                  <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm mr-3">
                    ${email.charAt(0).toUpperCase()}
                  </div>
                  <div>
                    <div class="font-medium">${email}${isAdmin}</div>
                    <div class="text-xs text-gray-400">${doc.id.substring(0, 8)}...</div>
                  </div>
                </div>
              </td>
              <td class="py-3 px-4">${data.displayName || 'N/A'}</td>
              <td class="py-3 px-4">${formatDate(data.fechaRegistro || data.ultimoAcceso || data.createdAt)}</td>
              <td class="py-3 px-4">
                <span class="px-2 py-1 rounded-full text-xs bg-green-600">Activo</span>
              </td>
            `;
            
            tbody.appendChild(row);
            rowsAdded++;
          } catch (rowError) {
            console.warn('‚ö†Ô∏è Error procesando usuario:', doc.id, rowError.message);
          }
        });
        
        console.log(`‚úÖ USUARIOS CARGADOS: ${rowsAdded} de ${userCount} procesados correctamente`);
        
      } catch (error) {
        console.error('‚ùå === ERROR CARGANDO USUARIOS ===');
        console.error('üî¥ C√≥digo:', error.code);
        console.error('üî¥ Mensaje:', error.message);
        console.error('üî¥ Stack:', error.stack);
        
        // Mostrar error espec√≠fico seg√∫n el tipo
        let errorMessage = 'Error cargando usuarios';
        if (error.code === 'permission-denied') {
          errorMessage = 'Sin permisos para leer usuarios - Verificar reglas Firestore';
          console.error('üö´ PERMISOS DENEGADOS - Posibles causas:');
          console.error('   1. Reglas de Firestore restrictivas');
          console.error('   2. Token de autenticaci√≥n inv√°lido');
          console.error('   3. Usuario no tiene flag isAdmin en Firestore');
        } else if (error.code === 'failed-precondition') {
          errorMessage = 'Error de √≠ndice - Verificar configuraci√≥n Firestore';
        }
        
        document.getElementById('total-users').textContent = 'Error';
        document.getElementById('users-table-body').innerHTML = 
          `<tr><td colspan="4" class="text-center py-8 text-red-400">${errorMessage}</td></tr>`;
      }
    }

    // === CARGAR ESTAD√çSTICAS ===
    async function loadStats() {
      if (!db) {
        console.warn('‚ö†Ô∏è Base de datos no disponible para estad√≠sticas');
        return;
      }
      
      console.log('üìà Cargando estad√≠sticas...');
      
      try {
        const { collection, getDocs } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
        
        // Objeto para almacenar estad√≠sticas
        const stats = {
          queries: 0,
          analysis: 0,
          dbRecords: 0,
          pushSent: 0,
          inappActive: 0,
          emailsSent: 0
        };
        
        // === CONSULTAS ===
        try {
          console.log('üìä Cargando consultas...');
          const queriesSnapshot = await getDocs(collection(db, 'queries'));
          stats.queries = queriesSnapshot.size;
          console.log(`‚úÖ Consultas: ${stats.queries}`);
        } catch (e) {
          console.warn('‚ö†Ô∏è No se pudo cargar queries:', e.code || e.message);
          stats.queries = 0;
        }
        
        // === AN√ÅLISIS ===
        try {
          console.log('üìä Cargando an√°lisis...');
          const analysisSnapshot = await getDocs(collection(db, 'analysis'));
          stats.analysis = analysisSnapshot.size;
          console.log(`‚úÖ An√°lisis: ${stats.analysis}`);
        } catch (e) {
          console.warn('‚ö†Ô∏è No se pudo cargar analysis:', e.code || e.message);
          stats.analysis = 0;
        }
        
        // === REGISTROS EN DB (USUARIOS) ===
        try {
          console.log('üìä Cargando registros de usuarios...');
          const usersSnapshot = await getDocs(collection(db, 'users'));
          stats.dbRecords = usersSnapshot.size;
          console.log(`‚úÖ Usuarios en DB: ${stats.dbRecords}`);
        } catch (e) {
          console.warn('‚ö†Ô∏è No se pudo cargar users para db records:', e.code || e.message);
          stats.dbRecords = 0;
        }
        
        // === NOTIFICACIONES PUSH ===
        try {
          console.log('üìä Cargando notificaciones...');
          const notificationsSnapshot = await getDocs(collection(db, 'notifications'));
          stats.pushSent = notificationsSnapshot.size;
          console.log(`‚úÖ Notificaciones: ${stats.pushSent}`);
        } catch (e) {
          console.warn('‚ö†Ô∏è No se pudo cargar notifications:', e.code || e.message);
          // Intentar con nombre alternativo
          try {
            const pushSnapshot = await getDocs(collection(db, 'pushNotifications'));
            stats.pushSent = pushSnapshot.size;
            console.log(`‚úÖ Push notifications (alt): ${stats.pushSent}`);
          } catch (e2) {
            console.warn('‚ö†Ô∏è No se pudo cargar pushNotifications:', e2.code || e2.message);
            stats.pushSent = 0;
          }
        }
        
        // === NOTIFICACIONES IN-APP (ESTIMACI√ìN) ===
        stats.inappActive = Math.floor(stats.pushSent * 0.7);
        console.log(`üì± In-app estimadas: ${stats.inappActive}`);
        
        // === EMAILS ENVIADOS (ESTIMACI√ìN) ===
        stats.emailsSent = Math.floor(stats.dbRecords * 0.3);
        console.log(`üìß Emails estimados: ${stats.emailsSent}`);
        
        // === ACTUALIZAR UI ===
        try {
          document.getElementById('daily-queries').textContent = stats.queries.toString();
          document.getElementById('total-analysis').textContent = stats.analysis.toString();
          document.getElementById('db-records').textContent = stats.dbRecords.toString();
          document.getElementById('push-sent').textContent = stats.pushSent.toString();
          document.getElementById('inapp-active').textContent = stats.inappActive.toString();
          document.getElementById('emails-sent').textContent = stats.emailsSent.toString();
          
          console.log('‚úÖ Estad√≠sticas actualizadas en UI:', stats);
        } catch (uiError) {
          console.error('‚ùå Error actualizando UI de estad√≠sticas:', uiError);
        }
        
      } catch (error) {
        console.error('‚ùå Error general cargando estad√≠sticas:', error.code || error.message);
        
        // Establecer valores por defecto en caso de error total
        const defaultValues = ['0', '0', '0', '0', '0', '0'];
        const ids = ['daily-queries', 'total-analysis', 'db-records', 'push-sent', 'inapp-active', 'emails-sent'];
        
        ids.forEach((id, index) => {
          try {
            const element = document.getElementById(id);
            if (element) {
              element.textContent = defaultValues[index];
            }
          } catch (e) {
            console.warn(`‚ö†Ô∏è No se pudo actualizar ${id}:`, e.message);
          }
        });
      }
    }

    // === AUTO REFRESH ===
    function startAutoRefresh() {
      console.log('üîÑ Iniciando auto-refresh cada 2 minutos...');
      
      setInterval(async () => {
        if (isUserAdmin && currentUser && db) {
          try {
            console.log('üîÑ Auto-refresh ejecut√°ndose...');
            await loadAdminData();
          } catch (refreshError) {
            console.warn('‚ö†Ô∏è Error en auto-refresh:', refreshError.message);
            // No hacer nada m√°s, seguir intentando en el pr√≥ximo ciclo
          }
        } else {
          console.warn('‚ö†Ô∏è Auto-refresh saltado - Condiciones no cumplidas');
        }
      }, 120000); // Cada 2 minutos (menos agresivo)
    }

    // === FUNCIONES GLOBALES ===
    async function refreshAllData() {
      if (!isUserAdmin) {
        alert('‚ùå Sin permisos de administrador');
        return;
      }
      
      console.log('üîÑ Refresh manual solicitado');
      await loadAdminData();
      alert('‚úÖ Datos actualizados correctamente');
    }

    async function sendNotification() {
      if (!isUserAdmin || !db) {
        alert('‚ùå Sin permisos o conexi√≥n');
        return;
      }
      
      const title = document.getElementById('notification-title').value.trim();
      const type = document.getElementById('notification-type').value;
      const message = document.getElementById('notification-message').value.trim();
      
      if (!title || !message) {
        alert('‚ö†Ô∏è Por favor completa el t√≠tulo y mensaje');
        return;
      }
      
      try {
        const { collection, addDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
        
        await addDoc(collection(db, 'notifications'), {
          title,
          message,
          type,
          createdAt: serverTimestamp(),
          createdBy: currentUser.email,
          status: 'sent'
        });
        
        // Limpiar formulario
        document.getElementById('notification-title').value = '';
        document.getElementById('notification-message').value = '';
        
        alert('‚úÖ Notificaci√≥n enviada correctamente');
        
        // Recargar estad√≠sticas
        loadStats();
        
      } catch (error) {
        console.error('‚ùå Error enviando notificaci√≥n:', error);
        alert('‚ùå Error al enviar la notificaci√≥n');
      }
    }

    function exportData() {
      if (!isUserAdmin) {
        alert('‚ùå Sin permisos de administrador');
        return;
      }
      alert('üöß Funci√≥n de exportaci√≥n en desarrollo');
    }

    function viewLogs() {
      if (!isUserAdmin) {
        alert('‚ùå Sin permisos de administrador');
        return;
      }
      alert('üöß Visor de logs en desarrollo');
    }

    function manageDB() {
      if (!isUserAdmin) {
        alert('‚ùå Sin permisos de administrador');
        return;
      }
      alert('üöß Gestor de base de datos en desarrollo');
    }

    // === INICIALIZAR CUANDO EL DOM EST√â LISTO ===
    document.addEventListener('DOMContentLoaded', initializeAdmin);
    
    console.log('üìã Script de administraci√≥n cargado');
  </script>
</body>
</html>
