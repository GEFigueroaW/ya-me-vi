<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diagn√≥stico APK - YA ME VI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .glass-effect {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .status-ok { color: #10B981; }
    .status-warning { color: #F59E0B; }
    .status-error { color: #EF4444; }
  </style>
</head>
<body class="p-4">
  
  <div class="max-w-4xl mx-auto">
    
    <!-- T√≠tulo -->
    <div class="glass-effect rounded-xl p-6 mb-6 text-center">
      <h1 class="text-3xl font-bold text-white mb-2">üîç Diagn√≥stico APK</h1>
      <p class="text-white/80">YA ME VI - An√°lisis de Compatibilidad</p>
    </div>
    
    <!-- Informaci√≥n del Entorno -->
    <div class="glass-effect rounded-xl p-6 mb-6">
      <h2 class="text-xl font-bold text-white mb-4">üì± Informaci√≥n del Entorno</h2>
      <div id="environmentInfo" class="space-y-2 text-sm">
        <div class="text-white/80">Cargando diagn√≥stico...</div>
      </div>
    </div>
    
    <!-- Estado de Firebase -->
    <div class="glass-effect rounded-xl p-6 mb-6">
      <h2 class="text-xl font-bold text-white mb-4">üî• Estado de Firebase</h2>
      <div id="firebaseInfo" class="space-y-2 text-sm">
        <div class="text-white/80">Verificando Firebase...</div>
      </div>
    </div>
    
    <!-- Test de Funcionalidades -->
    <div class="glass-effect rounded-xl p-6 mb-6">
      <h2 class="text-xl font-bold text-white mb-4">‚ö° Test de Funcionalidades</h2>
      <div id="functionalityTests" class="space-y-2 text-sm">
        <div class="text-white/80">Ejecutando tests...</div>
      </div>
    </div>
    
    <!-- Recomendaciones -->
    <div class="glass-effect rounded-xl p-6 mb-6">
      <h2 class="text-xl font-bold text-white mb-4">üí° Recomendaciones</h2>
      <div id="recommendations" class="space-y-2 text-sm">
        <div class="text-white/80">Analizando configuraci√≥n...</div>
      </div>
    </div>
    
    <!-- Botones de Acci√≥n -->
    <div class="glass-effect rounded-xl p-6 text-center space-y-4">
      <button id="runTestsBtn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-semibold">
        üîÑ Ejecutar Tests Nuevamente
      </button>
      <button id="exportResultsBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold ml-4">
        üìã Exportar Resultados
      </button>
    </div>
    
  </div>

  <script type="module">
    console.log('üîç Iniciando diagn√≥stico APK...');
    
    // Funci√≥n para detectar entorno
    function detectEnvironment() {
      const ua = navigator.userAgent.toLowerCase();
      const isWebView = !window.chrome || /wv|android.*version\/[.\d]+ chrome/.test(ua);
      const isApp = ua.includes('webintoapp') || ua.includes('app') || window.location.protocol === 'file:';
      const isMobile = /android|iphone|ipad|mobile/.test(ua);
      const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
      
      return {
        userAgent: ua,
        isWebView,
        isApp,
        isMobile,
        isLocalhost,
        protocol: window.location.protocol,
        hostname: window.location.hostname,
        href: window.location.href
      };
    }
    
    // Funci√≥n para test de almacenamiento
    function testStorage() {
      const results = {
        localStorage: false,
        sessionStorage: false,
        cookies: false,
        indexedDB: false
      };
      
      try {
        localStorage.setItem('test', 'test');
        localStorage.removeItem('test');
        results.localStorage = true;
      } catch (e) {
        console.warn('LocalStorage no disponible:', e);
      }
      
      try {
        sessionStorage.setItem('test', 'test');
        sessionStorage.removeItem('test');
        results.sessionStorage = true;
      } catch (e) {
        console.warn('SessionStorage no disponible:', e);
      }
      
      try {
        document.cookie = 'test=test';
        results.cookies = document.cookie.includes('test=test');
        document.cookie = 'test=; expires=Thu, 01 Jan 1970 00:00:00 UTC;';
      } catch (e) {
        console.warn('Cookies no disponibles:', e);
      }
      
      try {
        results.indexedDB = 'indexedDB' in window;
      } catch (e) {
        console.warn('IndexedDB no disponible:', e);
      }
      
      return results;
    }
    
    // Funci√≥n para test de Firebase
    async function testFirebase() {
      const results = {
        initialized: false,
        auth: false,
        firestore: false,
        network: false,
        error: null
      };
      
      try {
        // Test de inicializaci√≥n
        const { app, auth, db } = await import('./js/firebase-init.js');
        results.initialized = !!app;
        results.auth = !!auth;
        results.firestore = !!db;
        
        // Test de conectividad
        try {
          const testResponse = await fetch('https://ya-me-vi.firebaseapp.com');
          results.network = testResponse.status < 500;
        } catch (networkError) {
          console.warn('Error de red:', networkError);
          results.network = false;
        }
        
      } catch (error) {
        console.error('Error testing Firebase:', error);
        results.error = error.message;
      }
      
      return results;
    }
    
    // Funci√≥n para generar recomendaciones
    function generateRecommendations(env, storage, firebase) {
      const recommendations = [];
      
      if (env.isApp || env.isWebView) {
        recommendations.push({
          type: 'info',
          title: 'Entorno APK/WebView Detectado',
          message: 'Se recomienda usar archivos APK-compatible para mejor funcionamiento.'
        });
      }
      
      if (!storage.localStorage) {
        recommendations.push({
          type: 'error',
          title: 'LocalStorage No Disponible',
          message: 'Esto causar√° problemas con la persistencia de datos. Verificar configuraci√≥n WebView.'
        });
      }
      
      if (!firebase.initialized) {
        recommendations.push({
          type: 'error',
          title: 'Firebase No Inicializado',
          message: 'Error cr√≠tico. Verificar configuraci√≥n y conectividad.'
        });
      }
      
      if (!firebase.network) {
        recommendations.push({
          type: 'warning',
          title: 'Problemas de Conectividad',
          message: 'Verificar conexi√≥n a internet y dominios autorizados en Firebase.'
        });
      }
      
      if (env.protocol === 'file:') {
        recommendations.push({
          type: 'warning',
          title: 'Protocolo File:// Detectado',
          message: 'Agregar file:// a dominios autorizados en Firebase Console.'
        });
      }
      
      if (recommendations.length === 0) {
        recommendations.push({
          type: 'success',
          title: 'Configuraci√≥n Correcta',
          message: 'No se encontraron problemas cr√≠ticos en la configuraci√≥n.'
        });
      }
      
      return recommendations;
    }
    
    // Funci√≥n para mostrar resultados
    function displayResults(env, storage, firebase, recommendations) {
      // Informaci√≥n del entorno
      const envHtml = `
        <div class="grid grid-cols-2 gap-4">
          <div><span class="text-white/60">User Agent:</span> <span class="text-white text-xs">${env.userAgent.substring(0, 50)}...</span></div>
          <div><span class="text-white/60">Protocolo:</span> <span class="text-white">${env.protocol}</span></div>
          <div><span class="text-white/60">Hostname:</span> <span class="text-white">${env.hostname}</span></div>
          <div><span class="text-white/60">Es WebView:</span> <span class="${env.isWebView ? 'status-warning' : 'status-ok'}">${env.isWebView ? '‚úÖ S√≠' : '‚ùå No'}</span></div>
          <div><span class="text-white/60">Es Aplicaci√≥n:</span> <span class="${env.isApp ? 'status-ok' : 'status-warning'}">${env.isApp ? '‚úÖ S√≠' : '‚ùå No'}</span></div>
          <div><span class="text-white/60">Es M√≥vil:</span> <span class="${env.isMobile ? 'status-ok' : 'status-warning'}">${env.isMobile ? '‚úÖ S√≠' : '‚ùå No'}</span></div>
        </div>
      `;
      document.getElementById('environmentInfo').innerHTML = envHtml;
      
      // Estado de Firebase
      const firebaseHtml = `
        <div class="grid grid-cols-2 gap-4">
          <div><span class="text-white/60">Inicializado:</span> <span class="${firebase.initialized ? 'status-ok' : 'status-error'}">${firebase.initialized ? '‚úÖ S√≠' : '‚ùå No'}</span></div>
          <div><span class="text-white/60">Auth:</span> <span class="${firebase.auth ? 'status-ok' : 'status-error'}">${firebase.auth ? '‚úÖ Disponible' : '‚ùå Error'}</span></div>
          <div><span class="text-white/60">Firestore:</span> <span class="${firebase.firestore ? 'status-ok' : 'status-error'}">${firebase.firestore ? '‚úÖ Disponible' : '‚ùå Error'}</span></div>
          <div><span class="text-white/60">Red:</span> <span class="${firebase.network ? 'status-ok' : 'status-error'}">${firebase.network ? '‚úÖ Conectado' : '‚ùå Sin conexi√≥n'}</span></div>
          ${firebase.error ? `<div class="col-span-2"><span class="text-white/60">Error:</span> <span class="status-error">${firebase.error}</span></div>` : ''}
        </div>
      `;
      document.getElementById('firebaseInfo').innerHTML = firebaseHtml;
      
      // Tests de funcionalidad
      const functionalityHtml = `
        <div class="grid grid-cols-2 gap-4">
          <div><span class="text-white/60">LocalStorage:</span> <span class="${storage.localStorage ? 'status-ok' : 'status-error'}">${storage.localStorage ? '‚úÖ Disponible' : '‚ùå No disponible'}</span></div>
          <div><span class="text-white/60">SessionStorage:</span> <span class="${storage.sessionStorage ? 'status-ok' : 'status-error'}">${storage.sessionStorage ? '‚úÖ Disponible' : '‚ùå No disponible'}</span></div>
          <div><span class="text-white/60">Cookies:</span> <span class="${storage.cookies ? 'status-ok' : 'status-warning'}">${storage.cookies ? '‚úÖ Disponibles' : '‚ö†Ô∏è Limitadas'}</span></div>
          <div><span class="text-white/60">IndexedDB:</span> <span class="${storage.indexedDB ? 'status-ok' : 'status-warning'}">${storage.indexedDB ? '‚úÖ Disponible' : '‚ö†Ô∏è No disponible'}</span></div>
        </div>
      `;
      document.getElementById('functionalityTests').innerHTML = functionalityHtml;
      
      // Recomendaciones
      const recommendationsHtml = recommendations.map(rec => {
        const iconClass = rec.type === 'error' ? 'status-error' : rec.type === 'warning' ? 'status-warning' : 'status-ok';
        const icon = rec.type === 'error' ? '‚ùå' : rec.type === 'warning' ? '‚ö†Ô∏è' : '‚úÖ';
        return `
          <div class="border-l-4 border-${rec.type === 'error' ? 'red' : rec.type === 'warning' ? 'yellow' : 'green'}-500 pl-4 py-2">
            <div class="${iconClass} font-semibold">${icon} ${rec.title}</div>
            <div class="text-white/80 text-xs mt-1">${rec.message}</div>
          </div>
        `;
      }).join('');
      document.getElementById('recommendations').innerHTML = recommendationsHtml;
    }
    
    // Funci√≥n principal de diagn√≥stico
    async function runDiagnosis() {
      console.log('üîÑ Ejecutando diagn√≥stico completo...');
      
      // Obtener informaci√≥n del entorno
      const env = detectEnvironment();
      console.log('üîç Entorno:', env);
      
      // Test de almacenamiento
      const storage = testStorage();
      console.log('üíæ Almacenamiento:', storage);
      
      // Test de Firebase
      const firebase = await testFirebase();
      console.log('üî• Firebase:', firebase);
      
      // Generar recomendaciones
      const recommendations = generateRecommendations(env, storage, firebase);
      console.log('üí° Recomendaciones:', recommendations);
      
      // Mostrar resultados
      displayResults(env, storage, firebase, recommendations);
      
      console.log('‚úÖ Diagn√≥stico completado');
    }
    
    // Funci√≥n para exportar resultados
    function exportResults() {
      const timestamp = new Date().toISOString();
      const env = detectEnvironment();
      const storage = testStorage();
      
      const report = {
        timestamp,
        environment: env,
        storage,
        url: window.location.href,
        userAgent: navigator.userAgent
      };
      
      const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `yamevi-diagnostic-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }
    
    // Event listeners
    document.getElementById('runTestsBtn').addEventListener('click', runDiagnosis);
    document.getElementById('exportResultsBtn').addEventListener('click', exportResults);
    
    // Ejecutar diagn√≥stico inicial
    runDiagnosis();
    
  </script>
</body>
</html>
