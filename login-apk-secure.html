<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>YA ME VI - Ingreso APK</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="assets/favicon-circle.svg?v=6">
  <link rel="apple-touch-icon" href="assets/apple-touch-icon.png">
  
  <!-- Web App Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <!-- PWA Meta -->
  <meta name="theme-color" content="#00B44F">
  <meta name="mobile-web-app-capable" content="yes">
  
  <!-- iOS Safari Meta -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="YA ME VI">
  
  <!-- CARGAR INMEDIATAMENTE el script anti-OAuth para APK -->
  <script src="js/apk-oauth-killer.js"></script>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .glass-effect {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .loading-spinner {
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 2px solid white;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .apk-success {
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
      text-align: center;
      font-weight: bold;
      border: 2px solid #66BB6A;
    }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

  <div class="glass-effect rounded-3xl p-8 w-full max-w-md text-white text-center animate__animated animate__fadeInUp">
    
    <!-- Logo -->
    <div class="mb-6">
      <div class="text-6xl mb-4">üéØ</div>
      <h1 class="text-3xl font-bold mb-2">YA ME VI</h1>
      <p class="text-sm opacity-80">Aplicaci√≥n APK</p>
    </div>

    <!-- Mensaje de √©xito APK -->
    <div class="apk-success">
      <div class="text-2xl mb-2">üì±</div>
      <p><strong>¬°Versi√≥n APK Optimizada!</strong></p>
      <p class="text-sm mt-1">Autenticaci√≥n segura solo con email y contrase√±a</p>
    </div>

    <!-- SOLO Login con Email - SIN opciones OAuth -->
    <div class="space-y-4 mb-6">
      <input 
        type="email" 
        id="emailInput" 
        placeholder="üìß Correo electr√≥nico" 
        class="w-full px-4 py-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder:text-white/70 focus:bg-white/30 focus:border-white/50 focus:outline-none transition-all"
        autocomplete="email"
        required
      />
      <input 
        type="password" 
        id="passwordInput" 
        placeholder="üîí Contrase√±a" 
        class="w-full px-4 py-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder:text-white/70 focus:bg-white/30 focus:border-white/50 focus:outline-none transition-all"
        autocomplete="current-password"
        required
      />
      
      <button 
        id="loginWithEmail" 
        class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-lg"
      >
        <span class="btn-text">üîë Iniciar Sesi√≥n</span>
        <div class="loading-spinner hidden mx-auto"></div>
      </button>
    </div>

    <!-- Mensaje informativo -->
    <div class="bg-blue-500/20 border border-blue-400 text-blue-100 px-4 py-3 rounded-lg mb-4 text-sm">
      <div class="text-lg mb-1">‚ÑπÔ∏è</div>
      <p><strong>Nota:</strong> En la versi√≥n APK solo est√° disponible el login con email y contrase√±a para garantizar la m√°xima compatibilidad.</p>
    </div>

    <!-- Enlaces -->
    <div class="space-y-2 text-sm">
      <p>
        ¬øNo tienes cuenta? 
        <a href="register.html" class="text-green-300 hover:text-green-200 underline transition-colors">
          Crear cuenta nueva
        </a>
      </p>
      <p>
        <a href="recover.html" class="text-purple-300 hover:text-purple-200 underline transition-colors">
          ¬øOlvidaste tu contrase√±a?
        </a>
      </p>
      <p class="mt-4">
        <a href="index.html" class="text-gray-300 hover:text-white underline transition-colors text-xs">
          ‚Üê Volver al inicio
        </a>
      </p>
    </div>

    <!-- Mostrar errores -->
    <div id="errorDisplay" class="hidden bg-red-500/20 border border-red-400 text-red-100 px-4 py-3 rounded-lg mt-4">
      <div class="text-lg mb-1">‚ö†Ô∏è</div>
      <p id="errorMessage">Error desconocido</p>
      <button id="clearErrorBtn" class="mt-2 px-4 py-2 bg-white/20 rounded text-sm hover:bg-white/30 transition-colors">
        Reintentar
      </button>
    </div>

    <!-- Debug info (solo en desarrollo) -->
    <div id="debugInfo" class="hidden mt-4 p-3 bg-black/20 rounded-lg text-xs font-mono text-left"></div>
  </div>

  <!-- Firebase Authentication Script - SOLO email/password -->
  <script type="module">
    console.log('üöÄ [LOGIN-APK-SECURE] Iniciando login seguro para APK...');
    
    // Import Firebase functions b√°sicas
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
      getAuth, 
      signInWithEmailAndPassword, 
      onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyB4bCGyyPuQo-3-ONMPFKtqPEJDFl8Cb54",
      authDomain: "ya-me-vi.firebaseapp.com",
      projectId: "ya-me-vi",
      storageBucket: "ya-me-vi.firebasestorage.app",
      messagingSenderId: "748876890843",
      appId: "1:748876890843:web:07bd1eb476d38594d002fe",
      measurementId: "G-D7R797S5BC"
    };

    // Initialize Firebase
    console.log('üî• Inicializando Firebase para APK...');
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    let currentUser = null;

    // Admin emails
    const ADMIN_EMAILS = ['admin@yamevi.com', 'gfigueroa@yamevi.com'];

    // Utility functions
    function showLoading(buttonId, message = 'Procesando...') {
      const button = document.getElementById(buttonId);
      if (button) {
        const btnText = button.querySelector('.btn-text');
        const spinner = button.querySelector('.loading-spinner');
        if (btnText) btnText.classList.add('hidden');
        if (spinner) spinner.classList.remove('hidden');
        button.disabled = true;
      }
    }

    function hideLoading(buttonId) {
      const button = document.getElementById(buttonId);
      if (button) {
        const btnText = button.querySelector('.btn-text');
        const spinner = button.querySelector('.loading-spinner');
        if (btnText) btnText.classList.remove('hidden');
        if (spinner) spinner.classList.add('hidden');
        button.disabled = false;
      }
    }

    function showError(message) {
      const errorDisplay = document.getElementById('errorDisplay');
      const errorMessage = document.getElementById('errorMessage');
      if (errorDisplay && errorMessage) {
        errorMessage.textContent = message;
        errorDisplay.classList.remove('hidden');
      }
    }

    function hideError() {
      const errorDisplay = document.getElementById('errorDisplay');
      if (errorDisplay) {
        errorDisplay.classList.add('hidden');
      }
    }

    function showNotification(message, type = 'info') {
      console.log(`[${type.toUpperCase()}] ${message}`);
      // Puedes agregar notificaciones visuales aqu√≠ si es necesario
    }

    // Login con email y contrase√±a
    async function loginWithEmail() {
      const email = document.getElementById('emailInput').value.trim();
      const password = document.getElementById('passwordInput').value.trim();
      
      if (!email || !password) {
        showError('Por favor ingresa email y contrase√±a');
        return;
      }

      if (!email.includes('@')) {
        showError('Por favor ingresa un email v√°lido');
        return;
      }

      try {
        hideError();
        showLoading('loginWithEmail', 'Autenticando...');
        
        console.log('üîê Iniciando autenticaci√≥n con email para APK...');
        
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        if (user) {
          console.log('‚úÖ Autenticaci√≥n exitosa:', user.email);
          handleAuthSuccess(user);
        }
        
      } catch (error) {
        console.error('‚ùå Error en autenticaci√≥n:', error);
        hideLoading('loginWithEmail');
        
        let errorMessage = 'Error al iniciar sesi√≥n: ';
        
        switch (error.code) {
          case 'auth/user-not-found':
          case 'auth/wrong-password':
            errorMessage = 'Email o contrase√±a incorrectos';
            break;
          case 'auth/too-many-requests':
            errorMessage = 'Demasiados intentos. Espera unos minutos';
            break;
          case 'auth/network-request-failed':
            errorMessage = 'Error de conexi√≥n. Verifica tu internet';
            break;
          case 'auth/invalid-email':
            errorMessage = 'El email no es v√°lido';
            break;
          case 'auth/missing-password':
            errorMessage = 'Contrase√±a requerida';
            break;
          default:
            errorMessage = `Error: ${error.message}`;
        }
        
        showError(errorMessage);
        showNotification(errorMessage, 'error');
      }
    }

    // Handle Authentication Success
    function handleAuthSuccess(user) {
      console.log('‚úÖ Usuario autenticado exitosamente:', user.email || user.uid);
      
      hideLoading('loginWithEmail');
      hideError();
      
      showNotification('¬°Ingreso exitoso! Redirigiendo...', 'success');
      
      // Verificar si es admin
      const isAdminRedirect = new URLSearchParams(window.location.search).get('admin') === 'true';
      const isAdmin = ADMIN_EMAILS.includes(user.email);
      
      setTimeout(() => {
        if (isAdminRedirect && isAdmin) {
          window.location.href = 'admin.html';
        } else if (isAdminRedirect && !isAdmin) {
          showNotification('Sin permisos de administrador', 'error');
          setTimeout(() => window.location.href = 'index.html', 2000);
        } else {
          window.location.href = 'home.html';
        }
      }, 1500);
    }

    // Event Listeners
    document.getElementById('loginWithEmail').addEventListener('click', loginWithEmail);
    document.getElementById('clearErrorBtn').addEventListener('click', hideError);
    
    // Allow login with Enter
    document.getElementById('passwordInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') loginWithEmail();
    });
    
    document.getElementById('emailInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') document.getElementById('passwordInput').focus();
    });

    // Auth State Listener
    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      if (user) {
        console.log('‚úÖ Usuario ya autenticado detectado:', user.email || user.uid);
        // Mostrar opci√≥n de continuar sin redirigir autom√°ticamente
        showNotification(`Ya est√°s conectado como ${user.email}`, 'info');
      } else {
        console.log('üë§ No hay usuario autenticado');
      }
    });

    console.log('üì± App APK segura inicializada correctamente');
    
  </script>
</body>
</html>
