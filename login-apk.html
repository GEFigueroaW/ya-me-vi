<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>YA ME VI - Ingreso APK</title>
  
  <!-- Favicon -->
  <link rel="apple-touch-icon" href="assets/apple-touch-icon.png">
  
  <!-- Web App Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <!-- PWA Meta -->
  <meta name="theme-color" content="#00B44F">
  <meta name="mobile-web-app-capable" content="yes">
  
  <!-- iOS Safari Meta -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="YA ME VI">
  
  <!-- CSS y Fonts -->
  <link href="css/styles.css" rel="stylesheet">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .glass-effect {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .loading-spinner {
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 2px solid white;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .webview-warning {
      background: linear-gradient(135deg, #ff9800, #f57c00);
      color: white;
      padding: 15px;
      border-radius: 10px;
      margin: 10px 0;
      text-align: center;
      font-weight: bold;
    }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

  <!-- Fondo dinámico con casas -->
  <div id="background"></div>

  <div class="glass-effect rounded-3xl p-8 w-full max-w-md text-white text-center animate__animated animate__fadeInUp" style="position: relative; z-index: 10;">
    
    <!-- Logo -->
    <div class="mb-6">
      <div class="text-6xl mb-4">🎯</div>
      <h1 class="text-3xl font-bold mb-2">YA ME VI</h1>
      <p class="text-sm opacity-80">Predicciones inteligentes de lotería</p>
    </div>

    <!-- Detección de entorno -->
    <div id="environmentInfo" class="mb-4 text-sm opacity-75"></div>

    <!-- Warning para WebView -->
    <div id="webviewWarning" class="webview-warning hidden">
      <div class="text-2xl mb-2">⚠️</div>
      <p>Entorno WebView detectado</p>
      <p class="text-xs mt-1">Usando método de autenticación optimizado</p>
    </div>

    <!-- Login con Email -->
    <div class="space-y-4 mb-6">
      <input 
        type="email" 
        id="emailInput" 
        placeholder="📧 Correo electrónico" 
        class="w-full px-4 py-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder:text-white/70 focus:bg-white/30 focus:border-white/50 focus:outline-none transition-all"
        autocomplete="email"
      />
      <input 
        type="password" 
        id="passwordInput" 
        placeholder="🔒 Contraseña" 
        class="w-full px-4 py-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder:text-white/70 focus:bg-white/30 focus:border-white/50 focus:outline-none transition-all"
        autocomplete="current-password"
      />
      
      <button 
        id="loginWithEmail" 
        class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-lg"
      >
        <span class="btn-text">🔑 Iniciar Sesión</span>
        <div class="loading-spinner hidden mx-auto"></div>
      </button>
    </div>

    <!-- Separador -->
    <div class="flex items-center mb-6">
      <div class="flex-1 h-px bg-white/30"></div>
      <span class="px-4 text-sm opacity-70">versión APK</span>
      <div class="flex-1 h-px bg-white/30"></div>
    </div>

    <!-- Método alternativo para WebView -->
    <div id="alternativeAuth" class="hidden">
      <button 
        id="externalGoogleAuth" 
        class="w-full bg-orange-500 hover:bg-orange-600 text-white py-3 px-6 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-lg mb-4"
      >
        🌐 Autenticación Externa
      </button>
      <p class="text-xs opacity-70 mb-4">
        Este método abrirá un navegador externo para completar la autenticación de forma segura
      </p>
    </div>

    <!-- Enlaces -->
    <div class="space-y-2 text-sm">
      <p>
        ¿No tienes cuenta? 
        <a href="register.html" class="text-blue-300 hover:text-blue-200 underline transition-colors">
          Crear cuenta
        </a>
      </p>
      <p>
        <a href="recover.html" class="text-purple-300 hover:text-purple-200 underline transition-colors">
          ¿Olvidaste tu contraseña?
        </a>
      </p>
    </div>

    <!-- Debug info (solo en desarrollo) -->
    <div id="debugInfo" class="hidden mt-6 p-3 bg-black/20 rounded-lg text-xs font-mono text-left"></div>
    
    <!-- Info de versión APK -->
    <div class="mt-6 p-3 bg-black/20 rounded-lg text-xs opacity-70">
      <p><strong>🔒 Versión APK Simplificada</strong></p>
      <p>Solo autenticación por email</p>
    </div>
  </div>

  <!-- Modal de loading -->
  <div id="loadingModal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50">
    <div class="bg-white/90 backdrop-blur-lg rounded-xl p-8 text-center text-gray-800 max-w-sm mx-4">
      <div class="loading-spinner mx-auto mb-4" style="border-color: #3b82f6; border-top-color: transparent;"></div>
      <p id="loadingMessage" class="font-medium">Procesando...</p>
    </div>
  </div>

  <!-- Scripts -->
  <script src="js/shared.js"></script>
  
  <!-- Firebase and Auth Logic -->
  <script type="module">
    // Import Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
      getAuth, 
      signInWithEmailAndPassword, 
      onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // Firebase Config - CORREGIDA para que coincida con google-services.json
    const firebaseConfig = {
      apiKey: "AIzaSyB4bCGyyPuQo-3-ONMPFKtqPEJDFl8Cb54",
      authDomain: "ya-me-vi.firebaseapp.com",
      projectId: "ya-me-vi",
      storageBucket: "ya-me-vi.firebasestorage.app",
      messagingSenderId: "748876890843",
      appId: "1:748876890843:web:07bd1eb476d38594d002fe",
      measurementId: "G-D7R797S5BC"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    console.log('🔥 Firebase Auth inicializado para APK');

    // Variables globales
    let isWebView = false;
    let authRetryCount = 0;
    const MAX_RETRIES = 3;

    // Elementos del DOM
    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const loginWithEmailBtn = document.getElementById('loginWithEmail');
    const loadingModal = document.getElementById('loadingModal');
    const loadingMessage = document.getElementById('loadingMessage');
    const environmentInfo = document.getElementById('environmentInfo');
    const webviewWarning = document.getElementById('webviewWarning');
    const debugInfo = document.getElementById('debugInfo');

    // Función para mostrar loading modal
    function showLoadingModal(message = 'Procesando...') {
      loadingMessage.textContent = message;
      loadingModal.classList.remove('hidden');
    }

    // Función para ocultar loading modal
    function hideLoadingModal() {
      loadingModal.classList.add('hidden');
    }

    // Función para mostrar loading en botón
    function showLoading(buttonElement, loadingText = 'Cargando...') {
      if (!buttonElement) return;
      buttonElement.disabled = true;
      buttonElement.classList.add('opacity-75', 'cursor-not-allowed');
      const textElement = buttonElement.querySelector('.btn-text');
      const spinner = buttonElement.querySelector('.loading-spinner');
      if (textElement) textElement.textContent = loadingText;
      if (spinner) spinner.classList.remove('hidden');
    }

    // Función para ocultar loading en botón
    function hideLoading(buttonElement, originalText) {
      if (!buttonElement) return;
      buttonElement.disabled = false;
      buttonElement.classList.remove('opacity-75', 'cursor-not-allowed');
      const textElement = buttonElement.querySelector('.btn-text');
      const spinner = buttonElement.querySelector('.loading-spinner');
      if (textElement) textElement.textContent = originalText;
      if (spinner) spinner.classList.add('hidden');
    }

    // Función para mostrar mensajes
    function showMessage(message, type = 'info', duration = 5000) {
      // Crear elemento de mensaje
      const messageDiv = document.createElement('div');
      messageDiv.className = `fixed top-4 left-4 right-4 p-4 rounded-lg text-center font-medium z-50 animate__animated animate__fadeInDown`;
      
      switch(type) {
        case 'error':
          messageDiv.className += ' bg-red-500/90 text-white';
          break;
        case 'success':
          messageDiv.className += ' bg-green-500/90 text-white';
          break;
        case 'warning':
          messageDiv.className += ' bg-yellow-500/90 text-black';
          break;
        default:
          messageDiv.className += ' bg-blue-500/90 text-white';
      }
      
      messageDiv.textContent = message;
      document.body.appendChild(messageDiv);
      
      if (duration > 0) {
        setTimeout(() => {
          messageDiv.classList.add('animate__fadeOutUp');
          setTimeout(() => {
            if (messageDiv.parentNode) {
              messageDiv.remove();
            }
          }, 500);
        }, duration);
      }
    }

    // Email Authentication
    async function loginWithEmail() {
      const email = emailInput.value.trim();
      const password = passwordInput.value;

      if (!email || !password) {
        showMessage('Por favor ingresa email y contraseña', 'error');
        return;
      }

      try {
        showLoading(loginWithEmailBtn, 'Iniciando sesión...');
        showLoadingModal('Autenticando con Firebase...');

        console.log('🖥️ Usando signInWithEmailAndPassword');
        const result = await signInWithEmailAndPassword(auth, email, password);
        
        console.log('✅ Email login exitoso:', result.user);
        showMessage('¡Inicio de sesión exitoso!', 'success');
        
        // Redirigir después del éxito
        setTimeout(() => {
          window.location.href = 'home.html';
        }, 1000);

      } catch (error) {
        console.error('❌ Error en Email Auth:', error);
        hideLoading(loginWithEmailBtn, '🔑 Iniciar Sesión');
        hideLoadingModal();
        
        let errorMessage = 'Error al iniciar sesión';
        switch (error.code) {
          case 'auth/user-not-found':
            errorMessage = 'Usuario no encontrado. ¿Deseas crear una cuenta?';
            break;
          case 'auth/wrong-password':
            errorMessage = 'Contraseña incorrecta';
            break;
          case 'auth/invalid-email':
            errorMessage = 'Email inválido';
            break;
          case 'auth/user-disabled':
            errorMessage = 'Usuario deshabilitado';
            break;
          case 'auth/too-many-requests':
            errorMessage = 'Demasiados intentos. Intenta más tarde';
            break;
          default:
            errorMessage = error.message;
        }
        
        showMessage(errorMessage, 'error');
      } finally {
        hideLoading(loginWithEmailBtn, '🔑 Iniciar Sesión');
        hideLoadingModal();
      }
    }

    // Event Listeners
    loginWithEmailBtn.addEventListener('click', loginWithEmail);

    // Enter key support
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        if (document.activeElement === emailInput || document.activeElement === passwordInput) {
          loginWithEmail();
        }
      }
    });

    // Detección de entorno
    function detectEnvironment() {
      const userAgent = navigator.userAgent.toLowerCase();
      isWebView = userAgent.includes('webview') || 
                  userAgent.includes('wv') || 
                  window.AndroidInterface !== undefined ||
                  window.webkit?.messageHandlers !== undefined;

      if (isWebView) {
        environmentInfo.textContent = '📱 Entorno APK detectado';
        webviewWarning.classList.remove('hidden');
        console.log('📱 Entorno WebView/APK detectado');
      } else {
        environmentInfo.textContent = '🌐 Entorno web detectado';
        console.log('🌐 Entorno web normal detectado');
      }

      // Debug info
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        debugInfo.classList.remove('hidden');
        debugInfo.innerHTML = `
          <p><strong>Debug Info:</strong></p>
          <p>UserAgent: ${navigator.userAgent}</p>
          <p>WebView: ${isWebView}</p>
          <p>Location: ${window.location.href}</p>
        `;
      }
    }

    // Auth State Observer
    onAuthStateChanged(auth, (user) => {
      if (user) {
        console.log('👤 Usuario ya autenticado:', user.email);
        // Opcional: redirigir automáticamente si ya está logueado
        // window.location.href = 'home.html';
      } else {
        console.log('👤 No hay usuario autenticado');
      }
    });

    // Inicialización
    function init() {
      console.log('🚀 YA ME VI Login APK inicializado');
      detectEnvironment();
      
      // Auto-focus en email
      if (emailInput) {
        emailInput.focus();
      }

      console.log('✅ Inicialización completada - Solo autenticación por email');
    }

    // Esperar a que el DOM esté listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>