<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pruebas APK - YA ME VI</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-3xl font-bold mb-6 text-center">üß™ Pruebas de Configuraci√≥n APK</h1>
        
        <!-- Estado del Sistema -->
        <div class="mb-6 p-4 bg-blue-50 rounded-lg">
            <h2 class="text-xl font-semibold mb-4">üìä Estado del Sistema</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h3 class="font-medium mb-2">Entorno Detectado:</h3>
                    <div id="environmentInfo" class="text-sm bg-white p-2 rounded border"></div>
                </div>
                <div>
                    <h3 class="font-medium mb-2">Capacidades:</h3>
                    <div id="capabilities" class="text-sm bg-white p-2 rounded border"></div>
                </div>
            </div>
        </div>

        <!-- Pruebas de Funcionalidad -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
            
            <!-- Prueba 1: Detecci√≥n de Entorno -->
            <div class="p-4 border rounded-lg">
                <h3 class="font-semibold mb-2">üîç Detecci√≥n de Entorno</h3>
                <button onclick="testEnvironmentDetection()" class="w-full bg-blue-500 text-white px-4 py-2 rounded mb-2">
                    Ejecutar Prueba
                </button>
                <div id="envTestResult" class="text-xs bg-gray-50 p-2 rounded min-h-[100px]">
                    Haz clic para ejecutar la prueba
                </div>
            </div>

            <!-- Prueba 2: Almacenamiento -->
            <div class="p-4 border rounded-lg">
                <h3 class="font-semibold mb-2">üíæ Almacenamiento</h3>
                <button onclick="testStorage()" class="w-full bg-green-500 text-white px-4 py-2 rounded mb-2">
                    Probar Storage
                </button>
                <div id="storageTestResult" class="text-xs bg-gray-50 p-2 rounded min-h-[100px]">
                    Haz clic para probar almacenamiento
                </div>
            </div>

            <!-- Prueba 3: Firebase -->
            <div class="p-4 border rounded-lg">
                <h3 class="font-semibold mb-2">üî• Firebase</h3>
                <button onclick="testFirebaseConnection()" class="w-full bg-red-500 text-white px-4 py-2 rounded mb-2">
                    Probar Conexi√≥n
                </button>
                <div id="firebaseTestResult" class="text-xs bg-gray-50 p-2 rounded min-h-[100px]">
                    Haz clic para probar Firebase
                </div>
            </div>

            <!-- Prueba 4: Auth Externa -->
            <div class="p-4 border rounded-lg">
                <h3 class="font-semibold mb-2">üåê Auth Externa</h3>
                <button onclick="testExternalAuth()" class="w-full bg-purple-500 text-white px-4 py-2 rounded mb-2">
                    Probar Auth Externa
                </button>
                <div id="externalAuthResult" class="text-xs bg-gray-50 p-2 rounded min-h-[100px]">
                    Haz clic para probar autenticaci√≥n externa
                </div>
            </div>

            <!-- Prueba 5: URLs -->
            <div class="p-4 border rounded-lg">
                <h3 class="font-semibold mb-2">üîó URLs</h3>
                <button onclick="testUrls()" class="w-full bg-orange-500 text-white px-4 py-2 rounded mb-2">
                    Verificar URLs
                </button>
                <div id="urlTestResult" class="text-xs bg-gray-50 p-2 rounded min-h-[100px]">
                    Haz clic para verificar URLs
                </div>
            </div>

            <!-- Prueba 6: Configuraci√≥n -->
            <div class="p-4 border rounded-lg">
                <h3 class="font-semibold mb-2">‚öôÔ∏è Configuraci√≥n</h3>
                <button onclick="testConfiguration()" class="w-full bg-indigo-500 text-white px-4 py-2 rounded mb-2">
                    Verificar Config
                </button>
                <div id="configTestResult" class="text-xs bg-gray-50 p-2 rounded min-h-[100px]">
                    Haz clic para verificar configuraci√≥n
                </div>
            </div>
        </div>

        <!-- Navegaci√≥n -->
        <div class="mb-6 p-4 bg-green-50 rounded-lg">
            <h2 class="text-xl font-semibold mb-4">üöÄ Navegaci√≥n de Pruebas</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                <a href="login.html" class="bg-blue-500 text-white px-4 py-2 rounded text-center text-sm">
                    Login Principal
                </a>
                <a href="login-apk-fixed.html" class="bg-green-500 text-white px-4 py-2 rounded text-center text-sm">
                    Login APK Fixed
                </a>
                <a href="auth-external.html" class="bg-purple-500 text-white px-4 py-2 rounded text-center text-sm">
                    Auth Externa
                </a>
                <a href="diagnostico-apk-google-auth.html" class="bg-orange-500 text-white px-4 py-2 rounded text-center text-sm">
                    Diagn√≥stico APK
                </a>
            </div>
        </div>

        <!-- Checklist de Configuraci√≥n -->
        <div class="mb-6 p-4 bg-yellow-50 rounded-lg">
            <h2 class="text-xl font-semibold mb-4">üìã Checklist de Configuraci√≥n</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h3 class="font-medium mb-2">Archivos Requeridos:</h3>
                    <ul id="fileChecklist" class="text-sm space-y-1">
                        <li id="file1">‚ùì login-apk-fixed.html</li>
                        <li id="file2">‚ùì auth-external.html</li>
                        <li id="file3">‚ùì js/firebase-init-apk-v2.js</li>
                        <li id="file4">‚ùì webintoapp-config.json</li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-medium mb-2">Configuraciones Externas:</h3>
                    <ul class="text-sm space-y-1">
                        <li id="config1">‚ö†Ô∏è Dominios autorizados en Firebase</li>
                        <li id="config2">‚ö†Ô∏è OAuth URIs en Google Cloud</li>
                        <li id="config3">‚ö†Ô∏è Configuraci√≥n de WebIntoApp</li>
                        <li id="config4">‚ö†Ô∏è HTTPS habilitado</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Log de Pruebas -->
        <div class="p-4 bg-gray-50 rounded-lg">
            <h2 class="text-xl font-semibold mb-4">üìù Log de Pruebas</h2>
            <div id="testLog" class="bg-black text-green-400 p-4 rounded font-mono text-xs h-64 overflow-y-auto">
                [Sistema] Iniciando pruebas de configuraci√≥n APK...<br>
            </div>
            <button onclick="clearLog()" class="mt-2 bg-gray-500 text-white px-4 py-1 rounded text-sm">
                Limpiar Log
            </button>
        </div>
    </div>

    <script>
        // Funciones de logging
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: 'text-blue-400',
                success: 'text-green-400', 
                error: 'text-red-400',
                warning: 'text-yellow-400'
            };
            
            logDiv.innerHTML += `[${timestamp}] <span class="${colors[type]}">${message}</span><br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('testLog').innerHTML = '[Sistema] Log limpiado...<br>';
        }

        // Detecci√≥n de entorno
        function detectEnvironment() {
            const ua = navigator.userAgent.toLowerCase();
            const hostname = window.location.hostname;
            const protocol = window.location.protocol;
            
            const webIntoAppSignatures = [
                'webintoapp',
                'android.*wv',
                '; wv)',
                /android.*version\/[.\d]+.*chrome\/[.\d]+.*mobile.*safari/i.test(navigator.userAgent),
                !window.chrome && /android/i.test(ua)
            ];
            
            const isWebIntoApp = webIntoAppSignatures.some(signature => {
                if (typeof signature === 'string') {
                    return ua.includes(signature);
                }
                return signature;
            });
            
            const isWebView = isWebIntoApp || !window.chrome || ua.includes('wv');
            const isMobile = /android|iphone|ipad|mobile/i.test(ua);
            
            return {
                isWebIntoApp,
                isWebView,
                isMobile,
                userAgent: ua,
                hostname,
                protocol,
                hasLocalStorage: typeof Storage !== 'undefined',
                hasSessionStorage: typeof sessionStorage !== 'undefined',
                hasCookies: navigator.cookieEnabled,
                hasChrome: !!window.chrome
            };
        }

        // Pruebas espec√≠ficas
        function testEnvironmentDetection() {
            log('Iniciando detecci√≥n de entorno...', 'info');
            
            const env = detectEnvironment();
            
            let result = `
                <strong>Entorno:</strong> ${env.isWebIntoApp ? 'WebIntoApp' : env.isWebView ? 'WebView' : 'Navegador Normal'}<br>
                <strong>M√≥vil:</strong> ${env.isMobile ? 'S√≠' : 'No'}<br>
                <strong>Chrome:</strong> ${env.hasChrome ? 'Disponible' : 'No disponible'}<br>
                <strong>Protocolo:</strong> ${env.protocol}<br>
                <strong>Dominio:</strong> ${env.hostname}
            `;
            
            document.getElementById('envTestResult').innerHTML = result;
            
            if (env.isWebIntoApp) {
                log('‚úÖ WebIntoApp detectado correctamente', 'success');
            } else if (env.isWebView) {
                log('‚ö†Ô∏è WebView gen√©rico detectado', 'warning');
            } else {
                log('‚ÑπÔ∏è Navegador normal detectado', 'info');
            }
        }

        function testStorage() {
            log('Probando capacidades de almacenamiento...', 'info');
            
            let results = [];
            
            // Test localStorage
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                results.push('‚úÖ LocalStorage: Disponible');
                log('‚úÖ LocalStorage funciona correctamente', 'success');
            } catch(e) {
                results.push('‚ùå LocalStorage: No disponible');
                log('‚ùå LocalStorage no funciona: ' + e.message, 'error');
            }
            
            // Test sessionStorage
            try {
                sessionStorage.setItem('test', 'test');
                sessionStorage.removeItem('test');
                results.push('‚úÖ SessionStorage: Disponible');
                log('‚úÖ SessionStorage funciona correctamente', 'success');
            } catch(e) {
                results.push('‚ùå SessionStorage: No disponible');
                log('‚ùå SessionStorage no funciona: ' + e.message, 'error');
            }
            
            // Test cookies
            if (navigator.cookieEnabled) {
                results.push('‚úÖ Cookies: Habilitadas');
                log('‚úÖ Cookies est√°n habilitadas', 'success');
            } else {
                results.push('‚ùå Cookies: Deshabilitadas');
                log('‚ùå Cookies est√°n deshabilitadas', 'error');
            }
            
            document.getElementById('storageTestResult').innerHTML = results.join('<br>');
        }

        async function testFirebaseConnection() {
            log('Probando conexi√≥n con Firebase...', 'info');
            
            try {
                // Test b√°sico de conectividad
                const response = await fetch('https://ya-me-vi.firebaseapp.com');
                
                if (response.ok) {
                    document.getElementById('firebaseTestResult').innerHTML = `
                        ‚úÖ Conectividad: OK<br>
                        ‚úÖ Dominio Firebase: Accesible<br>
                        ‚úÖ HTTPS: Activo<br>
                        ‚ÑπÔ∏è Status: ${response.status}
                    `;
                    log('‚úÖ Conexi√≥n con Firebase exitosa', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                document.getElementById('firebaseTestResult').innerHTML = `
                    ‚ùå Error de conectividad<br>
                    ‚ùå No se puede acceder a Firebase<br>
                    ‚ÑπÔ∏è Error: ${error.message}
                `;
                log('‚ùå Error conectando con Firebase: ' + error.message, 'error');
            }
        }

        function testExternalAuth() {
            log('Probando autenticaci√≥n externa...', 'info');
            
            const env = detectEnvironment();
            const authUrl = `${window.location.origin}/auth-external.html?test=true`;
            
            document.getElementById('externalAuthResult').innerHTML = `
                <strong>URL Auth:</strong> ${authUrl}<br>
                <strong>M√©todo recomendado:</strong> ${env.isWebIntoApp ? 'Navegador externo' : 'Popup/Redirect'}<br>
                <strong>Compatibilidad:</strong> ${env.isWebIntoApp ? '‚úÖ √ìptimo' : '‚ö†Ô∏è Usar m√©todo normal'}<br>
                <a href="${authUrl}" target="_blank" class="text-blue-500 underline text-xs">üîó Probar en nueva ventana</a>
            `;
            
            log('‚ÑπÔ∏è URL de autenticaci√≥n externa generada', 'info');
            
            if (env.isWebIntoApp) {
                log('‚úÖ Configuraci√≥n √≥ptima para WebIntoApp', 'success');
            } else {
                log('‚ÑπÔ∏è No es WebIntoApp, usar m√©todos est√°ndar', 'info');
            }
        }

        async function testUrls() {
            log('Verificando URLs importantes...', 'info');
            
            const urls = [
                { name: 'Login Principal', url: 'login.html' },
                { name: 'Login APK', url: 'login-apk-fixed.html' },
                { name: 'Auth Externa', url: 'auth-external.html' },
                { name: 'Firebase Init APK', url: 'js/firebase-init-apk-v2.js' }
            ];
            
            let results = [];
            
            for (const urlObj of urls) {
                try {
                    const response = await fetch(urlObj.url);
                    if (response.ok) {
                        results.push(`‚úÖ ${urlObj.name}: OK`);
                        log(`‚úÖ ${urlObj.name} accesible`, 'success');
                    } else {
                        results.push(`‚ùå ${urlObj.name}: ${response.status}`);
                        log(`‚ùå ${urlObj.name} error ${response.status}`, 'error');
                    }
                } catch (error) {
                    results.push(`‚ùå ${urlObj.name}: Error`);
                    log(`‚ùå ${urlObj.name} no accesible: ${error.message}`, 'error');
                }
            }
            
            document.getElementById('urlTestResult').innerHTML = results.join('<br>');
        }

        async function testConfiguration() {
            log('Verificando configuraci√≥n del sistema...', 'info');
            
            const env = detectEnvironment();
            let score = 0;
            let checks = [];
            
            // Check 1: Entorno detectado correctamente
            if (env.isWebIntoApp || env.isWebView || !env.isMobile) {
                checks.push('‚úÖ Entorno detectado');
                score++;
            } else {
                checks.push('‚ùå Entorno no detectado');
            }
            
            // Check 2: Almacenamiento disponible
            if (env.hasLocalStorage || env.hasSessionStorage) {
                checks.push('‚úÖ Almacenamiento disponible');
                score++;
            } else {
                checks.push('‚ùå Sin almacenamiento');
            }
            
            // Check 3: HTTPS
            if (env.protocol === 'https:' || env.hostname === 'localhost') {
                checks.push('‚úÖ Protocolo seguro');
                score++;
            } else {
                checks.push('‚ùå Protocolo inseguro');
            }
            
            // Check 4: Capacidades de red
            if (navigator.onLine !== false) {
                checks.push('‚úÖ Conectividad de red');
                score++;
            } else {
                checks.push('‚ùå Sin conectividad');
            }
            
            const percentage = (score / 4) * 100;
            
            document.getElementById('configTestResult').innerHTML = `
                <strong>Puntuaci√≥n:</strong> ${score}/4 (${percentage}%)<br>
                ${checks.join('<br>')}
            `;
            
            log(`‚ÑπÔ∏è Configuraci√≥n evaluada: ${score}/4 puntos`, percentage >= 75 ? 'success' : 'warning');
        }

        // Inicializaci√≥n
        window.onload = function() {
            log('üöÄ Sistema de pruebas APK iniciado', 'success');
            
            const env = detectEnvironment();
            
            // Actualizar info del entorno
            document.getElementById('environmentInfo').innerHTML = `
                <strong>Tipo:</strong> ${env.isWebIntoApp ? 'WebIntoApp' : env.isWebView ? 'WebView' : 'Navegador'}<br>
                <strong>M√≥vil:</strong> ${env.isMobile ? 'S√≠' : 'No'}<br>
                <strong>Dominio:</strong> ${env.hostname}<br>
                <strong>Protocolo:</strong> ${env.protocol}
            `;
            
            // Actualizar capacidades
            document.getElementById('capabilities').innerHTML = `
                <strong>LocalStorage:</strong> ${env.hasLocalStorage ? '‚úÖ' : '‚ùå'}<br>
                <strong>SessionStorage:</strong> ${env.hasSessionStorage ? '‚úÖ' : '‚ùå'}<br>
                <strong>Cookies:</strong> ${env.hasCookies ? '‚úÖ' : '‚ùå'}<br>
                <strong>Chrome:</strong> ${env.hasChrome ? '‚úÖ' : '‚ùå'}
            `;
            
            // Verificar archivos
            const files = [
                { id: 'file1', url: 'login-apk-fixed.html' },
                { id: 'file2', url: 'auth-external.html' },
                { id: 'file3', url: 'js/firebase-init-apk-v2.js' },
                { id: 'file4', url: 'webintoapp-config.json' }
            ];
            
            files.forEach(file => {
                fetch(file.url)
                    .then(response => {
                        if (response.ok) {
                            document.getElementById(file.id).innerHTML = `‚úÖ ${file.url}`;
                            log(`‚úÖ Archivo encontrado: ${file.url}`, 'success');
                        } else {
                            document.getElementById(file.id).innerHTML = `‚ùå ${file.url}`;
                            log(`‚ùå Archivo no encontrado: ${file.url}`, 'error');
                        }
                    })
                    .catch(() => {
                        document.getElementById(file.id).innerHTML = `‚ùå ${file.url}`;
                        log(`‚ùå Error accediendo: ${file.url}`, 'error');
                    });
            });
            
            log('‚ÑπÔ∏è Verificaci√≥n de archivos completada', 'info');
            log('üìã Usa los botones para ejecutar pruebas espec√≠ficas', 'info');
        };
    </script>
</body>
</html>
