<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DiagnÃ³stico ConexiÃ³n Admin</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #1a1a1a; color: white; }
        .step { background: #333; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .success { background: #0f5132; }
        .error { background: #842029; }
        .warning { background: #664d03; }
        .info { background: #1f2937; }
        pre { background: #000; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
        .actions { margin: 10px 0; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .logout-btn { background: #dc3545; }
        .logout-btn:hover { background: #c82333; }
    </style>
</head>
<body>
    <h1>ğŸ” DiagnÃ³stico: Â¿Por quÃ© no verifica mi correo como admin?</h1>
    
    <div class="step info">
        <h3>ğŸ“§ Emails Admin Autorizados</h3>
        <ul>
            <li>gfigueroa.w@gmail.com</li>
            <li>admin@yamevi.com.mx</li>
            <li>eugenfw@gmail.com</li>
        </ul>
    </div>
    
    <div id="step1" class="step info">
        <h3>1ï¸âƒ£ Estado de Firebase</h3>
        <div id="firebase-status">ğŸ”„ Verificando...</div>
    </div>
    
    <div id="step2" class="step info">
        <h3>2ï¸âƒ£ Usuario Actual</h3>
        <div id="user-status">ğŸ”„ Verificando...</div>
        <div class="actions">
            <button onclick="checkCurrentUser()">ğŸ” Verificar Usuario</button>
            <button onclick="showLoginForm()" id="login-btn">ğŸ”‘ Login</button>
            <button onclick="forceLogout()" class="logout-btn">ğŸšª Logout</button>
        </div>
    </div>
    
    <div id="step3" class="step info">
        <h3>3ï¸âƒ£ VerificaciÃ³n Admin</h3>
        <div id="admin-check">â³ Esperando usuario...</div>
    </div>
    
    <div id="step4" class="step info">
        <h3>4ï¸âƒ£ Datos de Firestore</h3>
        <div id="firestore-check">â³ Esperando verificaciÃ³n admin...</div>
    </div>
    
    <div id="step5" class="step info">
        <h3>5ï¸âƒ£ Test AdminDataManager</h3>
        <div id="manager-test">â³ Esperando verificaciÃ³n admin...</div>
    </div>

    <!-- Login Form (hidden) -->
    <div id="login-form" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #333; padding: 20px; border-radius: 8px; z-index: 1000;">
        <h3>ğŸ”‘ Login Manual</h3>
        <div style="margin: 10px 0;">
            <label>Email:</label><br>
            <input type="email" id="login-email" style="width: 300px; padding: 8px; margin: 5px 0; color: black;">
        </div>
        <div style="margin: 10px 0;">
            <label>Password:</label><br>
            <input type="password" id="login-password" style="width: 300px; padding: 8px; margin: 5px 0; color: black;">
        </div>
        <div style="margin: 10px 0;">
            <button onclick="performLogin()">ğŸ”‘ Entrar</button>
            <button onclick="hideLoginForm()" class="logout-btn">âŒ Cancelar</button>
        </div>
    </div>

    <script type="module">
        let auth, db, currentUser, AdminDataManager;
        
        console.log('ğŸš€ Iniciando diagnÃ³stico de conexiÃ³n admin...');
        
        // Hacer funciones globales
        window.checkCurrentUser = checkCurrentUser;
        window.showLoginForm = showLoginForm;
        window.hideLoginForm = hideLoginForm;
        window.performLogin = performLogin;
        window.forceLogout = forceLogout;
        
        async function init() {
            try {
                // Paso 1: Cargar Firebase
                updateStatus('firebase-status', 'ğŸ“¦ Cargando Firebase...', 'info');
                
                const firebase = await import('./js/firebase-init.js');
                const { AdminDataManager: ADM } = await import('./js/adminDataManager.js');
                
                auth = firebase.auth;
                db = firebase.db;
                AdminDataManager = ADM;
                
                updateStatus('firebase-status', 'âœ… Firebase cargado correctamente', 'success');
                document.getElementById('step1').className = 'step success';
                
                // Configurar listener de autenticaciÃ³n
                firebase.onAuthStateChanged(auth, handleAuthChange);
                
            } catch (error) {
                console.error('âŒ Error inicializando:', error);
                updateStatus('firebase-status', `âŒ Error: ${error.message}`, 'error');
                document.getElementById('step1').className = 'step error';
            }
        }
        
        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = message;
            
            // Actualizar clase del step parent
            const step = element.closest('.step');
            if (step) {
                step.className = `step ${type}`;
            }
        }
        
        async function handleAuthChange(user) {
            currentUser = user;
            
            if (user) {
                // Paso 2: Usuario encontrado
                updateStatus('user-status', `
                    âœ… <strong>Usuario autenticado</strong><br>
                    ğŸ“§ Email: <strong>${user.email}</strong><br>
                    ğŸ†” UID: ${user.uid}<br>
                    âœ‰ï¸ Email verificado: ${user.emailVerified ? 'âœ… SÃ­' : 'âŒ No'}<br>
                    ğŸ• Ãšltimo login: ${user.metadata.lastSignInTime || 'N/A'}
                `, 'success');
                document.getElementById('step2').className = 'step success';
                
                // Paso 3: Verificar admin
                await checkAdminStatus(user);
                
            } else {
                updateStatus('user-status', 'âŒ <strong>No hay usuario autenticado</strong>', 'error');
                document.getElementById('step2').className = 'step error';
                
                updateStatus('admin-check', 'â¹ï¸ Cancelado - No hay usuario', 'warning');
                document.getElementById('step3').className = 'step warning';
                
                updateStatus('firestore-check', 'â¹ï¸ Cancelado - No hay usuario', 'warning');
                document.getElementById('step4').className = 'step warning';
                
                updateStatus('manager-test', 'â¹ï¸ Cancelado - No hay usuario', 'warning');
                document.getElementById('step5').className = 'step warning';
            }
        }
        
        async function checkAdminStatus(user) {
            updateStatus('admin-check', 'ğŸ” Verificando permisos admin...', 'info');
            
            const adminEmails = ['gfigueroa.w@gmail.com', 'admin@yamevi.com.mx', 'eugenfw@gmail.com'];
            const isAdminByEmail = adminEmails.includes(user.email);
            
            console.log('ğŸ” Verificando admin:', user.email, 'en', adminEmails, 'â†’', isAdminByEmail);
            
            let isAdminByFirestore = false;
            let firestoreData = null;
            
            // Verificar en Firestore
            try {
                updateStatus('firestore-check', 'ğŸ” Consultando Firestore...', 'info');
                
                const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
                const userDocRef = doc(db, 'users', user.uid);
                const userDoc = await getDoc(userDocRef);
                
                if (userDoc.exists()) {
                    firestoreData = userDoc.data();
                    isAdminByFirestore = firestoreData.isAdmin === true;
                    
                    updateStatus('firestore-check', `
                        âœ… <strong>Documento encontrado en Firestore</strong><br>
                        ğŸ“„ isAdmin: ${firestoreData.isAdmin ? 'âœ… true' : 'âŒ false'}<br>
                        ğŸ“§ Email en DB: ${firestoreData.email || 'N/A'}<br>
                        <pre>${JSON.stringify(firestoreData, null, 2)}</pre>
                    `, firestoreData.isAdmin ? 'success' : 'warning');
                    
                } else {
                    updateStatus('firestore-check', 'âš ï¸ No existe documento para este usuario en Firestore', 'warning');
                }
                
            } catch (firestoreError) {
                console.error('âŒ Error Firestore:', firestoreError);
                updateStatus('firestore-check', `âŒ Error consultando Firestore: ${firestoreError.message}`, 'error');
            }
            
            // Resultado final de verificaciÃ³n admin
            const isAdmin = isAdminByEmail || isAdminByFirestore;
            
            if (isAdmin) {
                updateStatus('admin-check', `
                    âœ… <strong>USUARIO ES ADMIN</strong><br>
                    ğŸ“§ Por email: ${isAdminByEmail ? 'âœ… SÃ' : 'âŒ NO'}<br>
                    ğŸ”¥ Por Firestore: ${isAdminByFirestore ? 'âœ… SÃ' : 'âŒ NO'}<br>
                    ğŸ‘¤ Usuario: ${user.email}
                `, 'success');
                document.getElementById('step3').className = 'step success';
                
                // Paso 5: Test AdminDataManager
                await testAdminDataManager();
                
            } else {
                updateStatus('admin-check', `
                    âŒ <strong>USUARIO NO ES ADMIN</strong><br>
                    ğŸ“§ Email actual: ${user.email}<br>
                    ğŸ“‹ Emails admin: ${adminEmails.join(', ')}<br>
                    ğŸ”¥ Firestore isAdmin: ${firestoreData?.isAdmin || 'false'}
                `, 'error');
                document.getElementById('step3').className = 'step error';
                
                updateStatus('manager-test', 'â¹ï¸ Cancelado - Usuario no es admin', 'warning');
                document.getElementById('step5').className = 'step warning';
            }
        }
        
        async function testAdminDataManager() {
            updateStatus('manager-test', 'ğŸ§ª Probando AdminDataManager...', 'info');
            
            try {
                const startTime = Date.now();
                const stats = await AdminDataManager.getAllStats();
                const loadTime = Date.now() - startTime;
                
                updateStatus('manager-test', `
                    âœ… <strong>AdminDataManager funcionando</strong><br>
                    â±ï¸ Tiempo: ${loadTime}ms<br>
                    ğŸ“Š Datos obtenidos:<br>
                    <pre>${JSON.stringify(stats, null, 2)}</pre>
                `, 'success');
                document.getElementById('step5').className = 'step success';
                
            } catch (error) {
                console.error('âŒ Error AdminDataManager:', error);
                updateStatus('manager-test', `
                    âŒ <strong>Error en AdminDataManager</strong><br>
                    ğŸ’¥ Error: ${error.message}<br>
                    ğŸ“š Stack: <pre>${error.stack}</pre>
                `, 'error');
                document.getElementById('step5').className = 'step error';
            }
        }
        
        function checkCurrentUser() {
            if (currentUser) {
                alert(`Usuario actual: ${currentUser.email}\nUID: ${currentUser.uid}`);
            } else {
                alert('No hay usuario autenticado');
            }
        }
        
        function showLoginForm() {
            document.getElementById('login-form').style.display = 'block';
        }
        
        function hideLoginForm() {
            document.getElementById('login-form').style.display = 'none';
        }
        
        async function performLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                alert('Por favor ingresa email y password');
                return;
            }
            
            try {
                const { signInWithEmailAndPassword } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js");
                await signInWithEmailAndPassword(auth, email, password);
                hideLoginForm();
                alert('âœ… Login exitoso');
            } catch (error) {
                alert(`âŒ Error login: ${error.message}`);
            }
        }
        
        async function forceLogout() {
            try {
                await auth.signOut();
                alert('âœ… SesiÃ³n cerrada');
            } catch (error) {
                alert(`âŒ Error logout: ${error.message}`);
            }
        }
        
        // Inicializar
        init();
    </script>
</body>
</html>
