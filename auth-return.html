<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YA ME VI - Procesando Autenticaci√≥n</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4285f4;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>

<body class="flex items-center justify-center min-h-screen p-4">
  <div class="text-center">
    
    <!-- Loading Spinner -->
    <div class="spinner mx-auto mb-6"></div>
    
    <!-- Loading Message -->
    <h1 class="text-2xl font-bold text-white mb-4">Procesando Autenticaci√≥n</h1>
    <p id="status-message" class="text-purple-100 mb-6">Validando credenciales...</p>
    
    <!-- Progress Steps -->
    <div class="bg-white bg-opacity-10 rounded-lg p-6 max-w-md mx-auto">
      <div class="space-y-3 text-left">
        <div id="step-1" class="flex items-center text-yellow-300">
          <span class="mr-2">‚è≥</span>
          <span>Verificando autenticaci√≥n...</span>
        </div>
        <div id="step-2" class="flex items-center text-gray-300">
          <span class="mr-2">‚è∏Ô∏è</span>
          <span>Registrando usuario...</span>
        </div>
        <div id="step-3" class="flex items-center text-gray-300">
          <span class="mr-2">‚è∏Ô∏è</span>
          <span>Configurando sesi√≥n...</span>
        </div>
        <div id="step-4" class="flex items-center text-gray-300">
          <span class="mr-2">‚è∏Ô∏è</span>
          <span>Redirigiendo a la aplicaci√≥n...</span>
        </div>
      </div>
    </div>
    
    <!-- Debug Info -->
    <div id="debug-info" class="mt-6 text-xs text-purple-200 hidden">
      <div>URL: <span id="current-url"></span></div>
      <div>Par√°metros: <span id="url-params"></span></div>
    </div>
    
    <!-- Error Display -->
    <div id="error-display" class="hidden mt-6 bg-red-500 bg-opacity-20 border border-red-500 rounded-lg p-4 max-w-md mx-auto">
      <h3 class="text-red-300 font-semibold mb-2">Error de Autenticaci√≥n</h3>
      <p id="error-message" class="text-red-200 text-sm"></p>
      <button 
        onclick="retryAuth()" 
        class="mt-3 bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition-colors"
      >
        Reintentar
      </button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
      getAuth, 
      onAuthStateChanged,
      signInWithCustomToken
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { 
      getFirestore, 
      doc, 
      setDoc, 
      serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAJYWSNUMj5aej7O9u5BwJQts7L2F6Poqw",
      authDomain: "ya-me-vi.firebaseapp.com",
      projectId: "ya-me-vi",
      storageBucket: "ya-me-vi.firebasestorage.app",
      messagingSenderId: "748876890843",
      appId: "1:748876890843:web:07bd1eb476d38594d002fe"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Elementos DOM
    const statusMessage = document.getElementById('status-message');
    const debugInfo = document.getElementById('debug-info');
    const errorDisplay = document.getElementById('error-display');
    const errorMessage = document.getElementById('error-message');

    // Funciones de UI
    function updateStep(stepNum, status, text) {
      const step = document.getElementById(`step-${stepNum}`);
      const icon = step.querySelector('span');
      
      switch(status) {
        case 'progress':
          icon.textContent = '‚è≥';
          step.className = 'flex items-center text-yellow-300';
          break;
        case 'success':
          icon.textContent = '‚úÖ';
          step.className = 'flex items-center text-green-300';
          break;
        case 'error':
          icon.textContent = '‚ùå';
          step.className = 'flex items-center text-red-300';
          break;
      }
      
      if (text) {
        step.querySelector('span:last-child').textContent = text;
      }
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorDisplay.classList.remove('hidden');
      updateStep(1, 'error');
    }

    function updateStatus(message) {
      statusMessage.textContent = message;
      console.log('üì± Status:', message);
    }

    // Funci√≥n principal de procesamiento
    async function processAuthentication() {
      try {
        console.log('üîÑ Iniciando procesamiento de autenticaci√≥n...');
        
        // Mostrar debug info si estamos en desarrollo
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
          debugInfo.classList.remove('hidden');
          document.getElementById('current-url').textContent = window.location.href;
          document.getElementById('url-params').textContent = window.location.search || 'Ninguno';
        }

        // Paso 1: Verificar par√°metros de URL
        updateStep(1, 'progress');
        updateStatus('Verificando par√°metros de autenticaci√≥n...');
        
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        const code = urlParams.get('code');
        const error = urlParams.get('error');
        const state = urlParams.get('state');
        
        console.log('üîç Par√°metros URL:', { token, code, error, state });

        if (error) {
          throw new Error(`Error de OAuth: ${error}`);
        }

        // Simular proceso de autenticaci√≥n (sin token real por ahora)
        updateStep(1, 'success');
        
        // Paso 2: Simular registro de usuario
        updateStep(2, 'progress');
        updateStatus('Registrando usuario en el sistema...');
        
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        // Crear usuario simulado
        const simulatedUser = {
          uid: 'google-user-' + Date.now(),
          email: 'usuario@gmail.com',
          displayName: 'Usuario Google',
          photoURL: 'https://via.placeholder.com/150',
          provider: 'google.com'
        };
        
        updateStep(2, 'success');
        
        // Paso 3: Configurar sesi√≥n
        updateStep(3, 'progress');
        updateStatus('Configurando sesi√≥n de usuario...');
        
        // Guardar en storage
        try {
          localStorage.setItem('auth_state', JSON.stringify('authenticated'));
          localStorage.setItem('user_data', JSON.stringify(simulatedUser));
          
          // Tambi√©n intentar sessionStorage como backup
          sessionStorage.setItem('auth_state', JSON.stringify('authenticated'));
          sessionStorage.setItem('user_data', JSON.stringify(simulatedUser));
          
          console.log('‚úÖ Usuario guardado en storage:', simulatedUser);
        } catch (storageError) {
          console.warn('‚ö†Ô∏è Error guardando en storage:', storageError);
        }
        
        updateStep(3, 'success');
        
        // Paso 4: Redireccionar
        updateStep(4, 'progress');
        updateStatus('Redirigiendo a la aplicaci√≥n...');
        
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        updateStep(4, 'success');
        updateStatus('¬°Autenticaci√≥n completada! Redirigiendo...');
        
        // Redireccionar a home
        setTimeout(() => {
          window.location.href = './home.html';
        }, 1500);

      } catch (error) {
        console.error('‚ùå Error en procesamiento:', error);
        showError(error.message);
        updateStatus('Error en la autenticaci√≥n');
      }
    }

    // Funci√≥n de reintentar
    window.retryAuth = function() {
      errorDisplay.classList.add('hidden');
      
      // Resetear steps
      for (let i = 1; i <= 4; i++) {
        updateStep(i, 'progress');
        document.getElementById(`step-${i}`).className = 'flex items-center text-gray-300';
        document.getElementById(`step-${i}`).querySelector('span').textContent = '‚è∏Ô∏è';
      }
      
      // Reiniciar proceso
      setTimeout(processAuthentication, 500);
    };

    // Inicializaci√≥n
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Auth Return Handler cargado');
      
      // Esperar un momento para mostrar la UI, luego procesar
      setTimeout(processAuthentication, 1000);
    });

    console.log('‚úÖ Auth Return Handler inicializado');
  </script>
</body>
</html>