<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>YA ME VI - Iniciar Sesi√≥n</title>
  
  <!-- DETECCI√ìN TEMPRANA DE WEBVIEW -->
  <script>
    // Detecci√≥n inmediata de WebView antes de que se cargue cualquier otra cosa
    (function() {
      console.log('üîç [LOGIN-EMAIL] Detecci√≥n temprana de WebView iniciada...');
      
      const ua = navigator.userAgent.toLowerCase();
      
      // VERIFICAR SI EL USUARIO FORZ√ì MODO NORMAL
      const forceNormalMode = localStorage.getItem('force_normal_browser') === 'true';
      if (forceNormalMode) {
        console.log('üîß [LOGIN-EMAIL] Modo normal forzado por usuario - saltando detecci√≥n WebView');
        return;
      }
      
      const isWebView = 
        // Detecci√≥n espec√≠fica de WebIntoApp y otros WebViews
        ua.includes('webintoapp') ||
        ua.includes('webview') ||
        // Detecci√≥n m√°s espec√≠fica de WebView (no Chrome normal)
        (/android.*version.*chrome/i.test(ua) && !ua.includes('chrome/') && !ua.includes('cros')) ||
        /crios|fxios/i.test(ua) ||
        // Detecci√≥n por caracter√≠sticas de entorno (solo iOS)
        (window.navigator.standalone === false && /iPhone|iPad/.test(ua) && !ua.includes('crios') && !ua.includes('safari')) ||
        // Solo si expl√≠citamente viene de webintoapp
        (window.location.href.includes('webintoapp'));
      
      console.log('üîç [LOGIN-EMAIL] WebView detectado:', isWebView);
      console.log('üì± [LOGIN-EMAIL] User Agent:', ua.slice(0, 100));
      console.log('üîß [LOGIN-EMAIL] Force Normal Mode:', forceNormalMode);
      console.log('üîç [LOGIN-EMAIL] Detalles de detecci√≥n:', {
        webintoapp: ua.includes('webintoapp'),
        webview: ua.includes('webview'), 
        androidChrome: /android.*version.*chrome/i.test(ua),
        hasChrome: ua.includes('chrome/'),
        hasCros: ua.includes('cros'),
        androidChromeSpecific: (/android.*version.*chrome/i.test(ua) && !ua.includes('chrome/') && !ua.includes('cros')),
        isWebView: isWebView
      });
      
      if (isWebView) {
        console.log('üö® [LOGIN-EMAIL] WebView detectado - redirigiendo a navegador externo INMEDIATAMENTE');
        
        // Crear URL de login externo
        const baseUrl = window.location.origin;
        const returnUrl = encodeURIComponent(window.location.href);
        const externalUrl = `${baseUrl}/external-login.html?type=email&return=${returnUrl}&webview=true&immediate=true`;
        
        console.log('üîó [LOGIN-EMAIL] Redirigiendo a:', externalUrl);
        
        // Mostrar mensaje inmediato al usuario
        document.write(`
          <div style="
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
          ">
            <div style="
              background: rgba(255, 255, 255, 0.1);
              backdrop-filter: blur(10px);
              border-radius: 20px;
              padding: 30px;
              max-width: 400px;
              width: 100%;
            ">
              <div style="font-size: 3em; margin: 20px 0;">üìß</div>
              <h2 style="margin: 20px 0;">Abriendo Login de Email</h2>
              <p style="margin: 15px 0; opacity: 0.8;">
                Se detect√≥ un entorno WebView. Abriendo navegador externo para login con email...
              </p>
              <div style="
                margin: 20px 0;
                padding: 10px;
                background: rgba(0,0,0,0.2);
                border-radius: 10px;
                font-size: 0.9em;
              ">
                Si no se abre autom√°ticamente, toca el enlace de abajo
              </div>
              <a href="${externalUrl}" style="
                display: inline-block;
                background: #4CAF50;
                color: white;
                text-decoration: none;
                padding: 15px 25px;
                border-radius: 10px;
                margin: 10px;
                font-weight: bold;
              ">üìß Abrir Login Email</a>
            </div>
          </div>
        `);
        
        // Intentar redirecci√≥n autom√°tica despu√©s de un breve delay
        setTimeout(() => {
          try {
            // M√©todo 1: window.open
            const popup = window.open(externalUrl, '_blank', 'width=400,height=600');
            if (!popup || popup.closed) {
              throw new Error('Popup bloqueado');
            }
          } catch (error) {
            // M√©todo 2: redirecci√≥n directa
            window.location.href = externalUrl;
          }
        }, 1500);
        
        // Detener la carga del resto de la p√°gina
        return;
      }
      
      console.log('üñ•Ô∏è [LOGIN-EMAIL] Navegador normal detectado - continuando con carga normal');
    })();
  </script>
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="assets/favicon-circle.svg?v=6">
  <link rel="apple-touch-icon" href="assets/apple-touch-icon.png">
  
  <!-- Web App Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <!-- PWA Meta -->
  <meta name="theme-color" content="#00B44F">
  <meta name="mobile-web-app-capable" content="yes">
  
  <!-- iOS Safari Meta -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="YA ME VI">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  <link rel="stylesheet" href="css/styles.css" />
  
  <!-- Custom styles for floating animation and logo -->
  <style>
    .floating-animation {
      animation: float 6s ease-in-out infinite;
    }
    
    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
      100% { transform: translateY(0px); }
    }
    
    .logo-redondo {
      border-radius: 50% !important;
      object-fit: cover !important;
    }
    
    .logo-hero {
      width: 96px !important;
      height: 96px !important;
    }
    
    /* Anti-autofill styles */
    input:-webkit-autofill,
    input:-webkit-autofill:hover,
    input:-webkit-autofill:focus,
    input:-webkit-autofill:active {
      -webkit-background-clip: text !important;
      -webkit-text-fill-color: white !important;
      transition: background-color 5000s ease-in-out 0s !important;
      background-color: transparent !important;
    }
    
    /* Force empty state */
    #emailInput,
    #passwordInput {
      background-color: rgba(255, 255, 255, 0.2) !important;
    }
  </style>
</head>

<body class="min-h-screen text-white bg-cover bg-center bg-no-repeat relative" style="background-image: url('assets/vg1.jpg');">

  <!-- Overlay oscuro para mejor legibilidad -->
  <div class="absolute inset-0 bg-black bg-opacity-50"></div>

  <!-- Contenido principal -->
  <div class="relative z-10 flex flex-col items-center justify-center min-h-screen p-4">
    
    <!-- Logo -->
    <div class="mb-8">
      <div class="floating-animation">
        <img src="assets/apple-touch-icon.png" alt="YA ME VI Logo" class="logo-redondo logo-hero rounded-full shadow-2xl object-cover mx-auto" style="width: 96px !important; height: 96px !important; border-radius: 50% !important; object-fit: cover !important;">
      </div>
    </div>

    <!-- T√≠tulo -->
    <h1 class="text-3xl font-bold mb-2 text-center">Iniciar Sesi√≥n</h1>
    <p class="text-white text-opacity-80 mb-8 text-center">Ingresa con tu cuenta</p>

    <!-- Formulario de login -->
    <div class="w-full max-w-sm">
      
      <!-- Google Login Button -->
      <button id="googleLoginBtn" class="w-full mb-4 bg-white text-gray-700 py-3 px-4 rounded-lg flex items-center justify-center space-x-3 hover:bg-gray-100 transition duration-300 shadow-lg">
        <svg class="w-5 h-5" viewBox="0 0 24 24">
          <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
          <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
          <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
          <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
        </svg>
        <span class="font-medium">Continuar con Google</span>
      </button>

      <!-- Biometric Login Button -->
      <button id="biometricLoginBtn" class="w-full mb-4 bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg flex items-center justify-center space-x-3 transition duration-300 shadow-lg" style="display: none;">
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
          <path d="M17.81 4.47c-.08 0-.16-.02-.23-.06C15.66 3.42 14 3 12.01 3c-1.98 0-3.86.47-5.57 1.41-.24.13-.54.04-.68-.2-.13-.24-.04-.55.2-.68C7.82 2.52 9.86 2 12.01 2c2.13 0 3.99.47 6.03 1.52.25.13.34.43.21.67-.09.18-.26.28-.44.28zM3.5 9.72c-.1 0-.2-.03-.29-.09-.23-.16-.28-.47-.12-.7.99-1.4 2.25-2.5 3.75-3.27C9.98 4.04 14 4.03 17.15 5.65c1.5.77 2.76 1.86 3.75 3.25.16.22.11.54-.12.7-.23.16-.54.11-.7-.12-.9-1.26-2.04-2.25-3.39-2.94-2.87-1.47-6.54-1.47-9.4.01-1.36.69-2.5 1.68-3.4 2.94-.08.14-.23.21-.39.21zm6.25 12.07c-.13 0-.26-.05-.35-.15-.87-.87-1.34-2.04-1.34-3.28 0-2.54 2.07-4.61 4.61-4.61s4.61 2.07 4.61 4.61c0 1.24-.47 2.41-1.34 3.28-.19.19-.49.19-.68 0-.19-.19-.19-.49 0-.68.68-.68 1.02-1.58 1.02-2.6 0-2.02-1.64-3.61-3.61-3.61s-3.61 1.59-3.61 3.61c0 1.02.34 1.92 1.02 2.6.19.19.19.49 0 .68-.09.1-.22.15-.35.15z"/>
          <path d="M12 18.72c-.7 0-1.26-.56-1.26-1.26s.56-1.26 1.26-1.26 1.26.56 1.26 1.26-.56 1.26-1.26 1.26z"/>
        </svg>
        <span class="font-medium">Iniciar con Biometr√≠a</span>
      </button>

      <!-- Divider -->
      <div class="relative my-6">
        <div class="absolute inset-0 flex items-center">
          <div class="w-full border-t border-white border-opacity-30"></div>
        </div>
        <div class="relative flex justify-center text-sm">
          <span class="px-2 bg-transparent text-white text-opacity-80">o</span>
        </div>
      </div>

      <!-- Email Input -->
      <div class="mb-4">
        <input 
          type="email" 
          id="emailInput" 
          name="email"
          autocomplete="email"
          placeholder="Email" 
          value=""
          class="w-full px-4 py-3 bg-white bg-opacity-20 backdrop-blur-lg border border-white border-opacity-30 rounded-lg text-white placeholder-white placeholder-opacity-70 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          required
        />
      </div>

      <!-- Password Input -->
      <div class="mb-6">
        <input 
          type="password" 
          id="passwordInput" 
          name="password"
          autocomplete="current-password"
          placeholder="Contrase√±a" 
          value=""
          class="w-full px-4 py-3 bg-white bg-opacity-20 backdrop-blur-lg border border-white border-opacity-30 rounded-lg text-white placeholder-white placeholder-opacity-70 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          required
        />
      </div>

      <!-- Login Button -->
      <button id="loginBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-300 shadow-lg">
        Iniciar Sesi√≥n
      </button>

      <!-- Error Message -->
      <div id="errorMessage" class="hidden mt-4 p-3 bg-red-600 bg-opacity-80 backdrop-blur-lg rounded-lg text-white text-sm text-center"></div>

      <!-- Loading State -->
      <div id="loadingState" class="hidden mt-4 p-3 bg-blue-600 bg-opacity-80 backdrop-blur-lg rounded-lg text-white text-sm text-center">
        <div class="flex items-center justify-center space-x-2">
          <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
          <span>Iniciando sesi√≥n...</span>
        </div>
      </div>
    </div>

    <!-- Footer Links -->
    <div class="mt-8 text-center space-y-3">
      <a href="recover.html" class="block text-white text-opacity-80 hover:text-opacity-100 transition duration-300">
        ¬øOlvidaste tu contrase√±a?
      </a>
      <div class="text-white text-opacity-60">
        ¬øNo tienes cuenta? 
        <a href="register.html" class="text-blue-300 hover:text-blue-200 transition duration-300">
          Reg√≠strate
        </a>
      </div>
      <a href="index.html" class="block text-white text-opacity-60 hover:text-opacity-80 transition duration-300">
        ‚Üê Volver al inicio
      </a>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module">
    import { auth } from './js/firebase-init.js';
    import { signInWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // Check if redirecting from admin panel
    const urlParams = new URLSearchParams(window.location.search);
    const isAdminRedirect = urlParams.get('redirect') === 'admin';
    const isRegistrationSuccess = urlParams.get('registered') === 'true';

    // Show registration success message if redirected from registration
    if (isRegistrationSuccess) {
      setTimeout(() => {
        const successDiv = document.createElement('div');
        successDiv.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-500 bg-opacity-90 backdrop-blur-lg text-white px-6 py-4 rounded-lg shadow-lg z-50 animate__animated animate__fadeInDown';
        successDiv.innerHTML = `
          <div class="flex items-center">
            <div class="mr-3">‚úÖ</div>
            <div>
              <p class="font-semibold">¬°Cuenta creada exitosamente!</p>
              <p class="text-sm opacity-90">Ahora puedes iniciar sesi√≥n con tu email y contrase√±a</p>
            </div>
          </div>
        `;
        document.body.appendChild(successDiv);
        
        // Auto-hide after 8 seconds
        setTimeout(() => {
          if (successDiv.parentNode) {
            successDiv.classList.remove('animate__fadeInDown');
            successDiv.classList.add('animate__fadeOutUp');
            setTimeout(() => {
              successDiv.remove();
            }, 500);
          }
        }, 8000);
        
        // Clean URL without reloading
        const cleanUrl = new URL(window.location);
        cleanUrl.searchParams.delete('registered');
        window.history.replaceState({}, document.title, cleanUrl);
      }, 500);
    }

    // Elements
    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const loginBtn = document.getElementById('loginBtn');
    const googleLoginBtn = document.getElementById('googleLoginBtn');
    const biometricLoginBtn = document.getElementById('biometricLoginBtn');
    const errorMessage = document.getElementById('errorMessage');
    const loadingState = document.getElementById('loadingState');

    // Clear form fields on page load - AGGRESSIVE CLEARING
    function clearFormFields() {
      if (emailInput && passwordInput) {
        // Limpiar valores m√∫ltiples veces
        emailInput.value = '';
        passwordInput.value = '';
        emailInput.defaultValue = '';
        passwordInput.defaultValue = '';
        
        // Remover atributos que puedan mantener valores
        emailInput.removeAttribute('value');
        passwordInput.removeAttribute('value');
        
        // Resetear estilos que pudieran indicar pre-llenado
        emailInput.style.backgroundColor = '';
        passwordInput.style.backgroundColor = '';
        emailInput.style.removeProperty('background-color');
        passwordInput.style.removeProperty('background-color');
        
        // Forzar re-renderizado de placeholders
        emailInput.setAttribute('placeholder', 'Email');
        passwordInput.setAttribute('placeholder', 'Contrase√±a');
        
        // Forzar blur y focus para resetear estado interno
        emailInput.blur();
        passwordInput.blur();
        
        // Usar setTimeout para limpiar despu√©s del autofill del navegador
        setTimeout(() => {
          emailInput.value = '';
          passwordInput.value = '';
        }, 100);
        
        setTimeout(() => {
          emailInput.value = '';
          passwordInput.value = '';
        }, 500);
        
        setTimeout(() => {
          emailInput.value = '';
          passwordInput.value = '';
        }, 1000);
        
        console.log('‚úÖ [LOGIN-EMAIL] Campos de formulario limpiados agresivamente');
      }
    }

    // Initialize form clearing IMMEDIATELY and repeatedly
    clearFormFields();
    
    // Clear again after a short delay
    setTimeout(clearFormFields, 50);
    setTimeout(clearFormFields, 100);
    setTimeout(clearFormFields, 200);
    setTimeout(clearFormFields, 500);
    setTimeout(clearFormFields, 1000);

    // Check for biometric authentication support
    function checkBiometricSupport() {
      if (window.PublicKeyCredential && navigator.credentials && navigator.credentials.create) {
        // Check if WebAuthn is supported
        PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable()
          .then(available => {
            if (available) {
              console.log('‚úÖ [LOGIN-EMAIL] Biometr√≠a disponible');
              biometricLoginBtn.style.display = 'block';
            } else {
              console.log('‚ÑπÔ∏è [LOGIN-EMAIL] Biometr√≠a no disponible en este dispositivo');
            }
          })
          .catch(err => {
            console.log('‚ö†Ô∏è [LOGIN-EMAIL] Error verificando biometr√≠a:', err);
          });
      } else {
        console.log('‚ÑπÔ∏è [LOGIN-EMAIL] WebAuthn no soportado');
      }
    }

    // Initialize biometric check
    checkBiometricSupport();

    // Register biometric credentials
    async function registerBiometricCredentials(email) {
      // Check if already registered
      const storedCredentials = localStorage.getItem('biometric_user_credentials');
      if (storedCredentials) {
        const credentials = JSON.parse(storedCredentials);
        if (credentials.email === email) {
          console.log('‚úÖ [LOGIN-EMAIL] Credenciales biom√©tricas ya registradas para:', email);
          return;
        }
      }

      try {
        console.log('üîê [LOGIN-EMAIL] Registrando credenciales biom√©tricas para:', email);
        
        const challenge = new Uint8Array(32);
        crypto.getRandomValues(challenge);
        
        const userId = new TextEncoder().encode(email);
        
        const publicKeyCredentialCreationOptions = {
          challenge: challenge,
          rp: {
            name: "YA ME VI",
            id: window.location.hostname
          },
          user: {
            id: userId,
            name: email,
            displayName: email
          },
          pubKeyCredParams: [{alg: -7, type: "public-key"}],
          authenticatorSelection: {
            authenticatorAttachment: "platform",
            userVerification: "preferred"
          },
          timeout: 60000,
          attestation: "direct"
        };

        const credential = await navigator.credentials.create({
          publicKey: publicKeyCredentialCreationOptions
        });

        if (credential) {
          // Store credential info
          const credentialData = {
            email: email,
            credentialId: Array.from(new Uint8Array(credential.rawId)),
            publicKey: Array.from(new Uint8Array(credential.response.publicKey || [])),
            registeredAt: new Date().toISOString()
          };
          
          localStorage.setItem('biometric_user_credentials', JSON.stringify(credentialData));
          console.log('‚úÖ [LOGIN-EMAIL] Credenciales biom√©tricas registradas exitosamente');
          
          // Show success message
          setTimeout(() => {
            const biometricSuccessDiv = document.createElement('div');
            biometricSuccessDiv.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-green-600 bg-opacity-90 backdrop-blur-lg text-white px-4 py-3 rounded-lg shadow-lg z-50 animate__animated animate__fadeInDown';
            biometricSuccessDiv.innerHTML = `
              <div class="flex items-center">
                <div class="mr-2">üîê</div>
                <div class="text-sm">
                  <p class="font-semibold">¬°Biometr√≠a activada!</p>
                  <p class="opacity-90">Ahora puedes usar tu huella digital</p>
                </div>
              </div>
            `;
            document.body.appendChild(biometricSuccessDiv);
            
            setTimeout(() => {
              if (biometricSuccessDiv.parentNode) {
                biometricSuccessDiv.classList.remove('animate__fadeInDown');
                biometricSuccessDiv.classList.add('animate__fadeOutUp');
                setTimeout(() => {
                  biometricSuccessDiv.remove();
                }, 500);
              }
            }, 4000);
          }, 1000);
        }
      } catch (error) {
        console.log('‚ÑπÔ∏è [LOGIN-EMAIL] Usuario rechaz√≥ registro biom√©trico o no est√° disponible:', error.message);
        // No mostrar error, es opcional
      }
    }

    // Show error message
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.classList.remove('hidden');
      loadingState.classList.add('hidden');
    }

    // Show loading state
    function showLoading(message = 'Iniciando sesi√≥n...') {
      loadingState.querySelector('span').textContent = message;
      loadingState.classList.remove('hidden');
      errorMessage.classList.add('hidden');
    }

    // Hide loading state
    function hideLoading() {
      loadingState.classList.add('hidden');
    }

    // Function to handle successful authentication redirect
    async function handleSuccessfulAuth(user) {
      console.log('üéØ [LOGIN-EMAIL] Procesando autenticaci√≥n exitosa para:', user.email);
      
      // Intentar registrar credenciales biom√©tricas si tiene email
      if (user.email) {
        try {
          await registerBiometricCredentials(user.email);
          console.log('‚úÖ [LOGIN-EMAIL] Registro biom√©trico completado para:', user.email);
        } catch (error) {
          console.log('‚ÑπÔ∏è [LOGIN-EMAIL] No se pudo registrar biometr√≠a (opcional):', error.message);
        }
      }
      
      // Lista completa de admins
      const adminEmails = [
        'gfigueroa.w@gmail.com', 
        'admin@yamevi.com.mx', 
        'eugenfw@gmail.com',
        'guillermo.figueroaw@totalplay.com.mx'
      ];
      
      // Verificaci√≥n por email
      let isAdmin = user.email && adminEmails.includes(user.email.toLowerCase());
      
      if (isAdminRedirect && isAdmin) {
        console.log('üîÑ Redirigiendo a admin panel...');
        localStorage.setItem('admin_verified', 'true');
        window.location.href = "admin.html";
      } else if (isAdminRedirect && !isAdmin) {
        console.log('‚ùå Usuario sin permisos de admin:', user.email || user.uid);
        showError(`Sin permisos de administrador. Usuario: ${user.email || user.uid}`);
      } else {
        console.log('‚úÖ Redirecci√≥n confirmada a home.html');
        window.location.href = "home.html";
      }
    }

    // Check if user is already authenticated
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        console.log('‚úÖ Usuario ya autenticado detectado:', user.email || user.uid);
        
        // IMPORTANTE: No redirigir autom√°ticamente - requerir confirmaci√≥n expl√≠cita
        console.log('üîê Usuario debe confirmar su identidad antes de continuar');
        
        // Mostrar mensaje de usuario ya autenticado
        const authNotificationDiv = document.createElement('div');
        authNotificationDiv.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-blue-600 bg-opacity-90 backdrop-blur-lg text-white px-6 py-4 rounded-lg shadow-lg z-50 animate__animated animate__fadeInDown';
        authNotificationDiv.innerHTML = `
          <div class="flex items-center">
            <div class="mr-3">‚ÑπÔ∏è</div>
            <div>
              <p class="font-semibold">Sesi√≥n activa detectada</p>
              <p class="text-sm opacity-90">Confirma tu identidad para continuar como: ${user.email || user.displayName || 'Usuario'}</p>
            </div>
          </div>
        `;
        document.body.appendChild(authNotificationDiv);
        
        // Auto-hide notification after 10 seconds
        setTimeout(() => {
          if (authNotificationDiv.parentNode) {
            authNotificationDiv.classList.remove('animate__fadeInDown');
            authNotificationDiv.classList.add('animate__fadeOutUp');
            setTimeout(() => {
              authNotificationDiv.remove();
            }, 500);
          }
        }, 10000);
        
        // Pre-fill email if available - DESHABILITADO para mantener campos vac√≠os
        /*
        if (user.email && emailInput) {
          emailInput.value = user.email;
          emailInput.style.backgroundColor = 'rgba(59, 130, 246, 0.2)'; // Blue tint to indicate it's pre-filled
          // Focus on password field
          setTimeout(() => {
            passwordInput.focus();
          }, 500);
        }
        */
        
        // Check admin redirect after explicit login, not automatically
        return; // No automatic redirect
      }
    });

    // Biometric Login
    biometricLoginBtn.addEventListener('click', async () => {
      console.log('üîê [LOGIN-EMAIL] Iniciando autenticaci√≥n biom√©trica...');
      
      try {
        showLoading('Verificando biometr√≠a...');
        
        // Check if there are stored credentials
        const storedCredentials = localStorage.getItem('biometric_user_credentials');
        if (!storedCredentials) {
          showError('No hay credenciales biom√©tricas registradas. Inicia sesi√≥n primero con email/contrase√±a para registrar tu huella.');
          return;
        }

        const credentials = JSON.parse(storedCredentials);
        
        // Create authentication challenge
        const challenge = new Uint8Array(32);
        crypto.getRandomValues(challenge);
        
        const publicKeyCredentialRequestOptions = {
          challenge: challenge,
          allowCredentials: [{
            id: new Uint8Array(credentials.credentialId),
            type: 'public-key',
            transports: ['internal']
          }],
          userVerification: 'preferred',
          timeout: 60000
        };

        // Request biometric authentication
        const assertion = await navigator.credentials.get({
          publicKey: publicKeyCredentialRequestOptions
        });

        if (assertion) {
          console.log('‚úÖ [LOGIN-EMAIL] Autenticaci√≥n biom√©trica exitosa');
          
          // Simulate Firebase auth with stored email
          const userEmail = credentials.email;
          console.log('‚úÖ [LOGIN-EMAIL] Login biom√©trico exitoso para:', userEmail);
          
          hideLoading();
          
          // Check admin status
          const adminEmails = ['gfigueroa.w@gmail.com', 'admin@yamevi.com.mx', 'eugenfw@gmail.com'];
          const isAdmin = adminEmails.includes(userEmail.toLowerCase());
          
          if (isAdminRedirect && isAdmin) {
            localStorage.setItem('admin_verified', 'true');
            window.location.href = "admin.html";
          } else if (isAdminRedirect && !isAdmin) {
            showError(`Sin permisos de administrador. Usuario: ${userEmail}`);
          } else {
            // Store biometric login flag
            localStorage.setItem('biometric_login', 'true');
            localStorage.setItem('user_email', userEmail);
            handleSuccessfulAuth({ email: userEmail });
          }
        }
        
      } catch (error) {
        console.error('‚ùå [LOGIN-EMAIL] Error en autenticaci√≥n biom√©trica:', error);
        
        let errorMsg = 'Error en autenticaci√≥n biom√©trica';
        if (error.name === 'NotAllowedError') {
          errorMsg = 'Autenticaci√≥n biom√©trica cancelada o no autorizada';
        } else if (error.name === 'NotSupportedError') {
          errorMsg = 'Autenticaci√≥n biom√©trica no soportada en este dispositivo';
        } else if (error.name === 'SecurityError') {
          errorMsg = 'Error de seguridad en autenticaci√≥n biom√©trica';
        }
        
        showError(errorMsg);
      }
    });

    // Email/Password Login
    loginBtn.addEventListener('click', async () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();

      if (!email || !password) {
        showError('Por favor ingresa email y contrase√±a');
        return;
      }

      try {
        showLoading('Iniciando sesi√≥n...');
        
        const result = await signInWithEmailAndPassword(auth, email, password);
        console.log('‚úÖ Login exitoso:', result.user.email);
        
        // Register biometric credentials if supported
        if (window.PublicKeyCredential && navigator.credentials && navigator.credentials.create) {
          try {
            await registerBiometricCredentials(result.user.email);
          } catch (bioError) {
            console.log('‚ÑπÔ∏è [LOGIN-EMAIL] No se pudo registrar biometr√≠a:', bioError.message);
          }
        }
        
        hideLoading();
        
        // Redirect using new function
        handleSuccessfulAuth(result.user);
        
      } catch (error) {
        console.error('‚ùå Error en login:', error);
        
        let errorMsg = 'Error al iniciar sesi√≥n';
        if (error.code === 'auth/user-not-found') {
          errorMsg = 'Usuario no encontrado';
        } else if (error.code === 'auth/wrong-password') {
          errorMsg = 'Contrase√±a incorrecta';
        } else if (error.code === 'auth/invalid-email') {
          errorMsg = 'Email inv√°lido';
        } else if (error.code === 'auth/too-many-requests') {
          errorMsg = 'Demasiados intentos. Espera un momento';
        }
        
        showError(errorMsg);
      }
    });

    // Google Login
    googleLoginBtn.addEventListener('click', async () => {
      console.log('üîç [LOGIN-EMAIL] Iniciando autenticaci√≥n Google...');
      
      // VERIFICAR SI EL USUARIO FORZ√ì MODO NORMAL
      const forceNormalMode = localStorage.getItem('force_normal_browser') === 'true';
      if (forceNormalMode) {
        console.log('üîß [LOGIN-EMAIL] Modo normal forzado - usando popup est√°ndar');
      }
      
      // Detectar WebView de manera m√°s agresiva
      const ua = navigator.userAgent.toLowerCase();
      const isWebView = !forceNormalMode && (
        ua.includes('webintoapp') ||
        ua.includes('webview') ||
        ua.includes('wv') ||
        // Detecci√≥n m√°s espec√≠fica de WebView (no Chrome normal)
        (/android.*version.*chrome/i.test(ua) && !ua.includes('chrome/') && !ua.includes('cros')) ||
        /crios|fxios/i.test(ua) ||
        // Solo iOS WebViews espec√≠ficos
        (window.navigator.standalone === false && /iPhone|iPad/.test(ua) && !ua.includes('crios') && !ua.includes('safari')) ||
        // Apps espec√≠ficas conocidas
        (/Android|iPhone/i.test(ua) && (ua.includes('inapp') || ua.includes('fbav') || ua.includes('instagram'))) ||
        window.WEBVIEW_MODE || 
        localStorage.getItem('webview_detected') === 'true'
      );
      
      // FORCE WebView detection for debugging
      console.log('üîç [LOGIN-EMAIL] User Agent Check:', {
        userAgent: ua.slice(0, 100),
        isWebView: isWebView,
        hasWebIntoApp: ua.includes('webintoapp'),
        hasWebView: ua.includes('webview'),
        windowSize: `${window.innerWidth}x${window.innerHeight}`,
        screenSize: `${window.screen.width}x${window.screen.height}`
      });
      
      // ALWAYS use external login for mobile devices to avoid popup issues
      const isMobileDevice = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      
      // NUEVA L√ìGICA: Si es m√≥vil o WebView, usar siempre external login
      if (isWebView || isMobileDevice) {
        console.log('üîç [LOGIN-EMAIL] Usando autenticaci√≥n externa (WebView o m√≥vil detectado)');
        
        // Crear URL de login externo
        const baseUrl = window.location.origin;
        const returnUrl = encodeURIComponent(window.location.href);
        const externalUrl = `${baseUrl}/external-login.html?type=google&return=${returnUrl}&webview=${isWebView}&mobile=${isMobileDevice}&from=login-email`;
        
        console.log('üîó [LOGIN-EMAIL] Redirigiendo a:', externalUrl);
        
        try {
          // Clear any existing auth state to prevent conflicts
          try {
            await auth.signOut();
            console.log('üßπ [LOGIN-EMAIL] Estado de auth limpiado antes de redirecci√≥n');
          } catch (signOutError) {
            console.log('‚ÑπÔ∏è [LOGIN-EMAIL] No hab√≠a estado previo que limpiar');
          }
          
          // Set flags for external auth
          localStorage.setItem('external_auth_in_progress', 'true');
          localStorage.setItem('external_auth_type', 'google');
          localStorage.setItem('external_auth_return', window.location.href);
          localStorage.setItem('external_auth_timestamp', Date.now().toString());
          
          // Mostrar mensaje al usuario antes de redirigir
          showLoading('Redirigiendo para autenticaci√≥n con Google...');
          
          // Always use direct redirect for better compatibility in mobile/WebView
          console.log('üîÑ [LOGIN-EMAIL] Usando redirecci√≥n directa para m√°xima compatibilidad');
          setTimeout(() => {
            window.location.href = externalUrl;
          }, 1000);
          
        } catch (error) {
          console.error('‚ùå [LOGIN-EMAIL] Error configurando auth externa:', error);
          showError('Error preparando autenticaci√≥n externa. Int√©ntalo de nuevo.');
        }
        
        return;
      }

      // Desktop browser - try popup with enhanced error handling
      try {
        showLoading('Conectando con Google...');
        
        // Clear any existing state first (critical for avoiding "missing initial state")
        try {
          await auth.signOut();
          console.log('üßπ [LOGIN-EMAIL] Estado de auth limpiado antes de popup');
        } catch (signOutError) {
          console.log('‚ÑπÔ∏è [LOGIN-EMAIL] No hab√≠a estado previo que limpiar');
        }
        
        // Clear localStorage that might interfere
        const keysToRemove = [
          'firebase:authUser',
          'firebase:host',
          'external_auth_in_progress',
          'external_login_success'
        ];
        keysToRemove.forEach(key => {
          try {
            localStorage.removeItem(key);
          } catch (e) {
            // Ignore errors
          }
        });
        
        // Wait a moment for cleanup to complete
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        const provider = new GoogleAuthProvider();
        
        // Enhanced provider configuration to avoid state issues
        provider.setCustomParameters({
          prompt: 'select_account',
          access_type: 'online',
          include_granted_scopes: 'true',
          // Add state parameter to avoid missing initial state error
          state: btoa(JSON.stringify({
            timestamp: Date.now(),
            origin: window.location.origin,
            page: 'login-email'
          }))
        });
        
        // Add required scopes
        provider.addScope('email');
        provider.addScope('profile');
        
        console.log('üöÄ [LOGIN-EMAIL] Iniciando popup de Google con configuraci√≥n mejorada...');
        
        const result = await signInWithPopup(auth, provider);
        
        console.log('‚úÖ Google login exitoso:', result.user.email);
        console.log('üìä Credential info:', {
          providerId: result.providerId,
          operationType: result.operationType,
          user: {
            uid: result.user.uid,
            email: result.user.email,
            displayName: result.user.displayName,
            emailVerified: result.user.emailVerified
          }
        });
        
        hideLoading();
        
        // Redirect using new function with biometric registration
        await handleSuccessfulAuth(result.user);
        
      } catch (error) {
        console.error('‚ùå Error en Google login:', error);
        console.error('‚ùå Error details:', {
          code: error.code,
          message: error.message,
          stack: error.stack
        });
        
        hideLoading();
        
        let errorMsg = 'Error al conectar con Google';
        let shouldRetryWithExternal = false;
        
        if (error.code === 'auth/popup-closed-by-user') {
          errorMsg = 'Ventana cerrada. Int√©ntalo de nuevo';
        } else if (error.code === 'auth/popup-blocked') {
          errorMsg = 'Popup bloqueado. Intentando alternativa...';
          shouldRetryWithExternal = true;
        } else if (error.code === 'auth/cancelled-popup-request') {
          errorMsg = 'Solicitud cancelada. Int√©ntalo de nuevo';
        } else if (error.code === 'auth/web-storage-unsupported') {
          errorMsg = 'Almacenamiento no soportado. Usando navegador externo...';
          shouldRetryWithExternal = true;
        } else if (error.code === 'auth/unauthorized-domain') {
          errorMsg = 'Dominio no autorizado para autenticaci√≥n';
        } else if (error.code === 'auth/operation-not-allowed') {
          errorMsg = 'Autenticaci√≥n con Google no habilitada';
        } else if (error.message.includes('missing initial state') || 
                   error.message.includes('storage-partitioned') ||
                   error.message.includes('third-party') ||
                   error.code === 'auth/invalid-api-key' ||
                   error.code === 'auth/network-request-failed') {
          errorMsg = 'Error de configuraci√≥n. Usando navegador externo...';
          shouldRetryWithExternal = true;
        }
        
        // Auto-fallback to external login for problematic cases
        if (shouldRetryWithExternal) {
          console.log('üîÑ [LOGIN-EMAIL] Fallback autom√°tico a autenticaci√≥n externa');
          showLoading('Intentando con navegador externo...');
          
          setTimeout(() => {
            const baseUrl = window.location.origin;
            const returnUrl = encodeURIComponent(window.location.href);
            const externalUrl = `${baseUrl}/external-login.html?type=google&return=${returnUrl}&webview=false&fallback=true&from=login-email&error=${encodeURIComponent(error.code || 'unknown')}`;
            
            // Set fallback flags
            localStorage.setItem('external_auth_in_progress', 'true');
            localStorage.setItem('external_auth_type', 'google');
            localStorage.setItem('external_auth_fallback', 'true');
            localStorage.setItem('external_auth_original_error', error.code || 'unknown');
            
            window.location.href = externalUrl;
          }, 2000);
        } else {
          showError(errorMsg);
        }
      }
    });

    // Allow login with Enter key
    passwordInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        loginBtn.click();
      }
    });

    emailInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        passwordInput.focus();
      }
    });

    // Additional form clearing events - AGGRESSIVE CLEARING
    window.addEventListener('focus', clearFormFields);
    window.addEventListener('pageshow', (event) => {
      clearFormFields();
      if (event.persisted) {
        clearFormFields();
      }
    });

    // Clear on browser back/forward
    window.addEventListener('popstate', clearFormFields);
    
    // Clear on load events
    window.addEventListener('load', clearFormFields);
    document.addEventListener('DOMContentLoaded', clearFormFields);
    
    // Clear with intervals to fight aggressive autofill
    const clearingInterval = setInterval(() => {
      if (emailInput && passwordInput) {
        if (emailInput.value !== '' || passwordInput.value !== '') {
          console.log('üßπ [LOGIN-EMAIL] Detectado autofill - limpiando campos...');
          emailInput.value = '';
          passwordInput.value = '';
        }
      }
    }, 100);
    
    // Stop clearing after 5 seconds
    setTimeout(() => {
      clearInterval(clearingInterval);
      console.log('‚úÖ [LOGIN-EMAIL] Limpieza autom√°tica finalizada');
    }, 5000);

    // Verificar si regresamos de autenticaci√≥n externa
    function checkExternalAuthReturn() {
      console.log('üîç [LOGIN-EMAIL] Verificando retorno de auth externa...');
      
      // Verificar flags de autenticaci√≥n externa
      const externalAuthInProgress = localStorage.getItem('external_auth_in_progress');
      const externalAuthData = localStorage.getItem('external_login_success');
      
      console.log('üìã [LOGIN-EMAIL] Estado external auth:', {
        inProgress: externalAuthInProgress,
        hasData: !!externalAuthData,
        currentUrl: window.location.href
      });
      
      if (externalAuthData) {
        try {
          const userData = JSON.parse(externalAuthData);
          console.log('‚úÖ [LOGIN-EMAIL] Datos de auth externa encontrados:', userData);
          
          // Limpiar localStorage
          localStorage.removeItem('external_login_success');
          localStorage.removeItem('external_auth_in_progress');
          localStorage.removeItem('external_auth_type');
          localStorage.removeItem('external_auth_return');
          
          // Mostrar mensaje de √©xito y redirigir
          showNotification('Autenticaci√≥n exitosa. Redirigiendo...', 'success');
          
          setTimeout(() => {
            // Redirigir basado en los datos del usuario
            if (userData.email && userData.email.includes('admin@')) {
              console.log('üîß [LOGIN-EMAIL] Usuario admin detectado, redirigiendo a admin');
              window.location.href = 'admin.html';
            } else {
              console.log('üè† [LOGIN-EMAIL] Usuario normal, redirigiendo a home');
              window.location.href = 'home.html';
            }
          }, 1500);
          
          return true;
        } catch (error) {
          console.error('‚ùå [LOGIN-EMAIL] Error procesando datos externos:', error);
          localStorage.removeItem('external_login_success');
        }
      }
      
      // Limpiar flags si no hay datos pero s√≠ progreso
      if (externalAuthInProgress && !externalAuthData) {
        console.log('üßπ [LOGIN-EMAIL] Limpiando flags de auth externa sin datos');
        localStorage.removeItem('external_auth_in_progress');
        localStorage.removeItem('external_auth_type');
        localStorage.removeItem('external_auth_return');
      }
      
      return false;
    }

    // Function to show success/error notifications
    function showNotification(message, type = 'info') {
      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500'
      };
      
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-4 py-2 rounded-lg shadow-lg z-50 animate__animated animate__fadeInRight`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.classList.remove('animate__fadeInRight');
        notification.classList.add('animate__fadeOutRight');
        setTimeout(() => {
          notification.remove();
        }, 500);
      }, 3000);
    }

    // Initialize biometric authentication system
    async function initBiometricAuth() {
      try {
        // Import biometric login system
        const { initBiometricLogin } = await import('./js/biometric-login.js');
        
        // Initialize biometric login
        await initBiometricLogin('biometricLoginBtn');
        console.log('‚úÖ [LOGIN-EMAIL] Sistema biom√©trico inicializado');
        
      } catch (error) {
        console.log('‚ÑπÔ∏è [LOGIN-EMAIL] Sistema biom√©trico no disponible:', error.message);
        // Hide biometric button if import fails
        if (biometricLoginBtn) {
          biometricLoginBtn.style.display = 'none';
        }
      }
    }

    // Check external auth return on page load
    checkExternalAuthReturn();
    
    // Initialize biometric authentication
    document.addEventListener('DOMContentLoaded', () => {
      initBiometricAuth();
    });

    console.log('‚úÖ [LOGIN-EMAIL] Sistema de login mejorado inicializado');
  </script>
</body>
</html>
