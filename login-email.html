<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>YA ME VI - Iniciar Sesi√≥n</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="assets/favicon-circle.svg?v=6">
  <link rel="apple-touch-icon" href="assets/apple-touch-icon.png">
  
  <!-- Web App Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <!-- PWA Meta -->
  <meta name="theme-color" content="#00B44F">
  <meta name="mobile-web-app-capable" content="yes">
  
  <!-- iOS Safari Meta -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="YA ME VI">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  <link rel="stylesheet" href="css/styles.css" />
  
  <!-- Custom styles for floating animation and logo -->
  <style>
    .floating-animation {
      animation: float 6s ease-in-out infinite;
    }
    
    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
      100% { transform: translateY(0px); }
    }
    
    .logo-redondo {
      border-radius: 50% !important;
      object-fit: cover !important;
    }
    
    .logo-hero {
      width: 96px !important;
      height: 96px !important;
    }
  </style>
</head>

<body class="overflow-hidden">

  <div id="background" class="fixed inset-0 z-0 bg-cover bg-center transition-opacity duration-1000"></div>

  <div class="relative z-10 flex flex-col items-center justify-center min-h-screen text-white text-center px-4">
    
    <!-- Logo -->
    <div class="mb-8">
      <div class="floating-animation">
        <img src="assets/apple-touch-icon.png" alt="YA ME VI Logo" class="logo-redondo logo-hero rounded-full shadow-2xl object-cover mx-auto" style="width: 96px !important; height: 96px !important; border-radius: 50% !important; object-fit: cover !important;">
      </div>
    </div>

    <!-- T√≠tulo -->
    <h1 class="text-3xl font-bold mb-2 text-center">Iniciar Sesi√≥n</h1>
    <p class="text-white text-opacity-80 mb-8 text-center">Ingresa con tu cuenta</p>

    <!-- Formulario de login -->
    <div class="w-full max-w-sm">
      
      <!-- Google Login Button -->
      <button id="googleLoginBtn" class="w-full mb-4 bg-white text-gray-700 py-3 px-4 rounded-lg flex items-center justify-center space-x-3 hover:bg-gray-100 transition duration-300 shadow-lg">
        <svg class="w-5 h-5" viewBox="0 0 24 24">
          <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
          <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
          <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
          <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
        </svg>
        <span class="font-medium">Continuar con Google</span>
      </button>

      <!-- Divider -->
      <div class="relative my-6">
        <div class="absolute inset-0 flex items-center">
          <div class="w-full border-t border-white border-opacity-30"></div>
        </div>
        <div class="relative flex justify-center text-sm">
          <span class="px-2 bg-transparent text-white text-opacity-80">o</span>
        </div>
      </div>

      <!-- Email Input -->
      <div class="mb-4">
        <input 
          type="email" 
          id="emailInput" 
          name="email"
          autocomplete="email"
          placeholder="Email" 
          class="w-full px-4 py-3 bg-white bg-opacity-20 backdrop-blur-lg border border-white border-opacity-30 rounded-lg text-white placeholder-white placeholder-opacity-70 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          required
        />
      </div>

      <!-- Password Input -->
      <div class="mb-6">
        <input 
          type="password" 
          id="passwordInput" 
          name="password"
          autocomplete="current-password"
          placeholder="Contrase√±a" 
          class="w-full px-4 py-3 bg-white bg-opacity-20 backdrop-blur-lg border border-white border-opacity-30 rounded-lg text-white placeholder-white placeholder-opacity-70 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          required
        />
      </div>

      <!-- Login Button -->
      <button id="loginBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-300 shadow-lg">
        Iniciar Sesi√≥n
      </button>

      <!-- Error Message -->
      <div id="errorMessage" class="hidden mt-4 p-3 bg-red-600 bg-opacity-80 backdrop-blur-lg rounded-lg text-white text-sm text-center"></div>

      <!-- Loading State -->
      <div id="loadingState" class="hidden mt-4 p-3 bg-blue-600 bg-opacity-80 backdrop-blur-lg rounded-lg text-white text-sm text-center">
        <div class="flex items-center justify-center space-x-2">
          <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
          <span>Iniciando sesi√≥n...</span>
        </div>
      </div>
    </div>

    <!-- Footer Links -->
    <div class="mt-8 text-center space-y-3">
      <a href="recover.html" class="block text-white text-opacity-80 hover:text-opacity-100 transition duration-300">
        ¬øOlvidaste tu contrase√±a?
      </a>
      <div class="text-white text-opacity-60">
        ¬øNo tienes cuenta? 
        <a href="register.html" class="text-blue-300 hover:text-blue-200 transition duration-300">
          Reg√≠strate
        </a>
      </div>
      <a href="index.html" class="block text-white text-opacity-60 hover:text-opacity-80 transition duration-300">
        ‚Üê Volver al inicio
      </a>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module">
    console.log('üöÄ [LOGIN-CLEAN] Iniciando sistema de login limpio...');
    
    // Import APK OAuth Fix PRIMERO
    import { fixOAuthAPK } from './js/fixOAuthAPK.js';
    
    // Import Firebase modules
    import { auth } from './js/firebase-init.js';
    import { signInWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, getRedirectResult } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // Aplicar fix OAuth APK inmediatamente
    console.log('üîß Aplicando fix OAuth APK en login-email.html...');
    const oauthFix = fixOAuthAPK();

    // Wait for DOM to be ready
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('‚úÖ [LOGIN-CLEAN] DOM ready, inicializando...');
      
      // Get DOM elements
      const emailInput = document.getElementById('emailInput');
      const passwordInput = document.getElementById('passwordInput');
      const loginBtn = document.getElementById('loginBtn');
      const googleLoginBtn = document.getElementById('googleLoginBtn');
      const errorMessage = document.getElementById('errorMessage');
      const loadingState = document.getElementById('loadingState');
      
      // Verify elements exist
      console.log('üîç [LOGIN-CLEAN] Verificando elementos:');
      console.log('- emailInput:', !!emailInput ? '‚úÖ' : '‚ùå');
      console.log('- passwordInput:', !!passwordInput ? '‚úÖ' : '‚ùå');
      console.log('- loginBtn:', !!loginBtn ? '‚úÖ' : '‚ùå');
      console.log('- googleLoginBtn:', !!googleLoginBtn ? '‚úÖ' : '‚ùå');
      
      // Utility functions
      function showError(message) {
        console.log('‚ùå [LOGIN-CLEAN] Error:', message);
        if (errorMessage && loadingState) {
          errorMessage.textContent = message;
          errorMessage.classList.remove('hidden');
          loadingState.classList.add('hidden');
        }
      }

      function showLoading(message = 'Iniciando sesi√≥n...') {
        console.log('‚è≥ [LOGIN-CLEAN] Loading:', message);
        if (loadingState && errorMessage) {
          const span = loadingState.querySelector('span');
          if (span) span.textContent = message;
          loadingState.classList.remove('hidden');
          errorMessage.classList.add('hidden');
        }
      }

      function hideLoading() {
        console.log('‚úÖ [LOGIN-CLEAN] Hide loading');
        if (loadingState) {
          loadingState.classList.add('hidden');
        }
      }

      function handleSuccessfulAuth(user) {
        console.log('‚úÖ [LOGIN-CLEAN] Auth success:', user.email);
        
        const urlParams = new URLSearchParams(window.location.search);
        const isAdminRedirect = urlParams.get('redirect') === 'admin';
        const adminEmails = ['gfigueroa.w@gmail.com', 'admin@yamevi.com.mx', 'eugenfw@gmail.com'];
        const isAdmin = adminEmails.includes(user.email.toLowerCase());
        
        if (isAdminRedirect && isAdmin) {
          localStorage.setItem('admin_verified', 'true');
          window.location.href = "admin.html";
        } else if (isAdminRedirect && !isAdmin) {
          showError(`‚ùå Sin permisos de administrador para: ${user.email}`);
        } else {
          localStorage.setItem('user_email', user.email);
          window.location.href = "home.html";
        }
      }

      // Email/Password Login
      if (loginBtn) {
        loginBtn.addEventListener('click', async () => {
          console.log('üîë [LOGIN-CLEAN] Email login clicked');
          
          const email = emailInput?.value.trim();
          const password = passwordInput?.value.trim();

          if (!email || !password) {
            showError('Por favor ingresa email y contrase√±a');
            return;
          }

          try {
            showLoading('Iniciando sesi√≥n...');
            
            const result = await signInWithEmailAndPassword(auth, email, password);
            console.log('‚úÖ [LOGIN-CLEAN] Email login successful:', result.user.email);
            
            hideLoading();
            handleSuccessfulAuth(result.user);
            
          } catch (error) {
            console.error('‚ùå [LOGIN-CLEAN] Email login error:', error);
            hideLoading();
            
            let errorMsg = 'Error al iniciar sesi√≥n';
            if (error.code === 'auth/user-not-found') {
              errorMsg = 'Usuario no encontrado';
            } else if (error.code === 'auth/wrong-password') {
              errorMsg = 'Contrase√±a incorrecta';
            } else if (error.code === 'auth/invalid-email') {
              errorMsg = 'Email inv√°lido';
            } else if (error.code === 'auth/too-many-requests') {
              errorMsg = 'Demasiados intentos. Espera un momento';
            }
            
            showError(errorMsg);
          }
        });
      }

      // Google Login
      if (googleLoginBtn) {
        googleLoginBtn.addEventListener('click', async () => {
          console.log('üîç [LOGIN-CLEAN] Google login clicked');
          
          try {
            showLoading('Iniciando sesi√≥n con Google...');
            
            const provider = new GoogleAuthProvider();
            provider.setCustomParameters({
              prompt: 'select_account'
            });
            
            const result = await signInWithPopup(auth, provider);
            
            if (result && result.user) {
              console.log('‚úÖ [LOGIN-CLEAN] Google login successful:', result.user.email);
              hideLoading();
              handleSuccessfulAuth(result.user);
            }
            
          } catch (error) {
            console.error('‚ùå [LOGIN-CLEAN] Google login error:', error);
            hideLoading();
            
            let errorMessage = "Error al iniciar sesi√≥n con Google";
            if (error.code === 'auth/popup-closed-by-user') {
              errorMessage = "Proceso cancelado. Int√©ntalo de nuevo.";
            } else if (error.code === 'auth/popup-blocked') {
              errorMessage = "Popup bloqueado. Permite popups para este sitio.";
            } else if (error.code === 'auth/account-exists-with-different-credential') {
              errorMessage = "Ya existe una cuenta con este email.";
            }
            
            showError(errorMessage);
          }
        });
      }

      // Enter key support
      if (passwordInput) {
        passwordInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && loginBtn) {
            loginBtn.click();
          }
        });
      }

      if (emailInput) {
        emailInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && passwordInput) {
            passwordInput.focus();
          }
        });
      }

      // Check for redirect result on page load
      try {
        const result = await getRedirectResult(auth);
        if (result && result.user) {
          console.log('‚úÖ [LOGIN-CLEAN] Redirect result:', result.user.email);
          handleSuccessfulAuth(result.user);
        }
      } catch (error) {
        console.error('‚ùå [LOGIN-CLEAN] Redirect result error:', error);
      }

      console.log('‚úÖ [LOGIN-CLEAN] Sistema inicializado correctamente');
    });
  </script>

  <!-- Background script -->
  <script src="js/shared.js"></script>
</body>
</html>
