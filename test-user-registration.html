<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test - Registro de Usuarios</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      padding: 20px; 
      background: #1a1a1a; 
      color: white;
      max-width: 800px;
      margin: 0 auto;
    }
    .info { 
      background: #333; 
      padding: 15px; 
      margin: 10px 0; 
      border-radius: 8px; 
    }
    .success { background: #0f5132; }
    .warning { background: #664d03; }
    .error { background: #842029; }
    button {
      background: #0066cc;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover { background: #0052a3; }
    #log {
      background: #222;
      padding: 10px;
      border-radius: 5px;
      height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>üîç Test - Registro Autom√°tico de Usuarios</h1>
  
  <div class="info">
    <h3>Estado Actual:</h3>
    <div id="auth-status">Verificando autenticaci√≥n...</div>
  </div>
  
  <div class="info">
    <h3>Acciones:</h3>
    <button onclick="forceRegisterCurrentUser()">üîÑ Forzar Registro de Usuario Actual</button>
    <button onclick="checkUsersCollection()">üë• Verificar Colecci√≥n de Usuarios</button>
    <button onclick="clearLog()">üóëÔ∏è Limpiar Log</button>
  </div>
  
  <div class="info">
    <h3>Log de Actividad:</h3>
    <div id="log"></div>
  </div>

  <script type="module">
    import { auth, db } from './js/firebase-init.js';
    import { registerUserInFirestore } from './js/firebase-init.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { collection, getDocs, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    let currentUser = null;

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const className = type === 'error' ? 'color: #ff6b6b' : type === 'success' ? 'color: #51cf66' : 'color: #74c0fc';
      logDiv.innerHTML += `<div style="${className}">[${timestamp}] ${message}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    }

    // Verificar autenticaci√≥n
    onAuthStateChanged(auth, async (user) => {
      const authStatus = document.getElementById('auth-status');
      
      if (user) {
        currentUser = user;
        authStatus.innerHTML = `‚úÖ <strong>Autenticado como:</strong> ${user.email}`;
        authStatus.parentElement.className = 'info success';
        
        log(`‚úÖ Usuario autenticado: ${user.email}`, 'success');
        
        // Autom√°ticamente intentar registrar el usuario
        await forceRegisterCurrentUser();
        
      } else {
        authStatus.innerHTML = `‚ùå <strong>No autenticado</strong>`;
        authStatus.parentElement.className = 'info error';
        log('‚ùå Usuario no autenticado', 'error');
      }
    });

    // Funci√≥n para forzar registro del usuario actual
    window.forceRegisterCurrentUser = async function() {
      if (!currentUser) {
        log('‚ùå No hay usuario autenticado', 'error');
        return;
      }

      try {
        log(`üîÑ Iniciando registro forzado para: ${currentUser.email}`);
        
        const userRef = doc(db, 'users', currentUser.uid);
        
        // Detectar informaci√≥n del dispositivo
        const userAgent = navigator.userAgent;
        let deviceInfo = 'Desktop';
        if (/Mobile|Android|iPhone|iPad/.test(userAgent)) {
          deviceInfo = 'Mobile';
        } else if (/Tablet/.test(userAgent)) {
          deviceInfo = 'Tablet';
        }
        
        // Detectar navegador
        let browser = 'Unknown';
        if (userAgent.includes('Chrome')) browser = 'Chrome';
        else if (userAgent.includes('Firefox')) browser = 'Firefox';
        else if (userAgent.includes('Safari')) browser = 'Safari';
        else if (userAgent.includes('Edge')) browser = 'Edge';
        
        const userData = {
          email: currentUser.email,
          displayName: currentUser.displayName || null,
          photoURL: currentUser.photoURL || null,
          lastAccess: serverTimestamp(),
          device: `${browser} ${deviceInfo}`,
          isOnline: true,
          loginCount: 1,
          createdAt: serverTimestamp(),
          isAdmin: ['gfigueroa.w@gmail.com', 'admin@yamevi.com.mx', 'eugenfw@gmail.com'].includes(currentUser.email),
          totalAnalysis: 0,
          totalQueries: 0,
          // Informaci√≥n adicional para debug
          registeredFrom: 'test-page',
          userAgent: userAgent
        };
        
        await setDoc(userRef, userData, { merge: true });
        
        log(`‚úÖ Usuario registrado exitosamente en Firestore`, 'success');
        log(`üì± Dispositivo: ${browser} ${deviceInfo}`, 'info');
        log(`üëë Es admin: ${userData.isAdmin}`, userData.isAdmin ? 'success' : 'info');
        
      } catch (error) {
        log(`‚ùå Error registrando usuario: ${error.message}`, 'error');
        console.error('Error completo:', error);
      }
    };

    // Funci√≥n para verificar la colecci√≥n de usuarios
    window.checkUsersCollection = async function() {
      try {
        log('üîç Verificando colecci√≥n de usuarios...');
        
        const usersCollection = collection(db, 'users');
        const snapshot = await getDocs(usersCollection);
        
        log(`üìä Total de usuarios en Firestore: ${snapshot.size}`, 'success');
        
        if (snapshot.size > 0) {
          log('üë• Usuarios encontrados:', 'info');
          snapshot.forEach((doc) => {
            const userData = doc.data();
            log(`  ‚Ä¢ ${userData.email} (${userData.device}) - ${userData.isOnline ? 'Online' : 'Offline'}`, 'info');
          });
        } else {
          log('üì≠ No hay usuarios registrados en Firestore', 'warning');
        }
        
      } catch (error) {
        log(`‚ùå Error verificando usuarios: ${error.message}`, 'error');
      }
    };

    // Funci√≥n para limpiar el log
    window.clearLog = function() {
      document.getElementById('log').innerHTML = '';
    };

    log('üöÄ Sistema de test inicializado');
  </script>
</body>
</html>
