<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🧪 Test OAuth Directo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .test-box {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        .btn {
            background: #4CAF50;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
            width: 100%;
        }
        .btn:hover {
            background: #45a049;
        }
        .log {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
            font-size: 12px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }
        .success { background: rgba(76, 175, 80, 0.3); }
        .error { background: rgba(244, 67, 54, 0.3); }
        .info { background: rgba(33, 150, 243, 0.3); }
    </style>
</head>
<body>
    <h1>🧪 Test OAuth Directo - YA-ME-VI</h1>

    <div class="test-box">
        <h2>🔐 Prueba de Autenticación Google</h2>
        <div id="authStatus" class="status info">No autenticado</div>
        <button class="btn" onclick="testGoogleAuth()">🚀 Probar Google OAuth</button>
        <button class="btn" onclick="signOutUser()" style="background: #f44336;">🚪 Cerrar Sesión</button>
    </div>

    <div class="test-box">
        <h2>📋 Log de Actividad</h2>
        <div id="logArea" class="log">Iniciando test directo...\n</div>
        <button class="btn" onclick="clearLog()" style="background: #FF9800;">🗑️ Limpiar Log</button>
    </div>

    <script type="module">
        // Configuración Firebase directa
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { 
            getAuth, 
            GoogleAuthProvider,
            signInWithPopup,
            signInWithRedirect,
            getRedirectResult,
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyAJYWSNUMj5aej7O9u5BwJQts7L2F6Poqw",
            authDomain: "ya-me-vi.firebaseapp.com",
            projectId: "ya-me-vi",
            storageBucket: "ya-me-vi.firebasestorage.app",
            messagingSenderId: "748876890843",
            appId: "1:748876890843:web:07bd1eb476d38594d002fe",
            measurementId: "G-D7R797S5BC"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        let logArea = document.getElementById('logArea');

        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            logArea.textContent += `[${timestamp}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
            console.log(message);
        }

        function updateAuthStatus(user, error = null) {
            const authStatus = document.getElementById('authStatus');
            if (user) {
                authStatus.innerHTML = `✅ Autenticado: ${user.email}`;
                authStatus.className = 'status success';
            } else if (error) {
                authStatus.innerHTML = `❌ Error: ${error.code || error.message}`;
                authStatus.className = 'status error';
            } else {
                authStatus.innerHTML = '🔐 No autenticado';
                authStatus.className = 'status info';
            }
        }

        // Test Google Authentication
        window.testGoogleAuth = async function() {
            addLog('🚀 Iniciando test directo de Google OAuth...');
            addLog(`📍 Dominio actual: ${window.location.origin}`);
            addLog(`🔧 Firebase Project: ${firebaseConfig.projectId}`);
            addLog(`🔧 Auth Domain: ${firebaseConfig.authDomain}`);
            
            try {
                const provider = new GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');
                
                addLog('🔄 Intentando signInWithPopup...');
                const result = await signInWithPopup(auth, provider);
                
                if (result.user) {
                    addLog(`✅ OAuth exitoso: ${result.user.email}`);
                    addLog(`👤 Nombre: ${result.user.displayName}`);
                    addLog(`🆔 UID: ${result.user.uid}`);
                    updateAuthStatus(result.user);
                }
                
            } catch (error) {
                addLog(`❌ Error OAuth: ${error.code}`);
                addLog(`📝 Mensaje: ${error.message}`);
                updateAuthStatus(null, error);
                
                // Analizar errores específicos
                if (error.code === 'auth/popup-blocked') {
                    addLog('🔄 Popup bloqueado, intentando redirect...');
                    try {
                        const provider = new GoogleAuthProvider();
                        await signInWithRedirect(auth, provider);
                        addLog('📤 Redirect iniciado, recargue la página...');
                    } catch (redirectError) {
                        addLog(`❌ Redirect también falló: ${redirectError.code}`);
                    }
                } else if (error.code === 'auth/unauthorized-domain') {
                    addLog('🚨 PROBLEMA: Dominio no autorizado');
                    addLog(`📋 Verificar que ${window.location.origin} esté en Google Cloud Console`);
                } else if (error.code === 'auth/configuration-not-found') {
                    addLog('🚨 PROBLEMA: Configuración no encontrada');
                } else if (error.code === 'auth/popup-closed-by-user') {
                    addLog('ℹ️ Usuario cerró ventana - comportamiento normal');
                }
            }
        };

        // Sign Out
        window.signOutUser = async function() {
            try {
                await signOut(auth);
                addLog('✅ Sesión cerrada');
                updateAuthStatus(null);
            } catch (error) {
                addLog(`❌ Error cerrando sesión: ${error.message}`);
            }
        };

        // Clear Log
        window.clearLog = function() {
            logArea.textContent = 'Log limpiado...\n';
        };

        // Auth state listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                addLog(`👤 Usuario detectado automáticamente: ${user.email}`);
                updateAuthStatus(user);
            } else {
                addLog('👤 No hay usuario autenticado');
                updateAuthStatus(null);
            }
        });

        // Check for redirect result on load
        getRedirectResult(auth).then((result) => {
            if (result) {
                addLog(`✅ Resultado de redirect: ${result.user.email}`);
                updateAuthStatus(result.user);
            }
        }).catch((error) => {
            if (error.code !== 'auth/null-user') {
                addLog(`❌ Error en redirect result: ${error.code}`);
            }
        });

        addLog('🚀 Test OAuth directo inicializado');
        addLog(`📍 Probando desde: ${window.location.origin}`);

    </script>
</body>
</html>
