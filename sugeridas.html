<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>YA ME VI - Combinaciones Sugeridas</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <link rel="stylesheet" href="css/styles.css" />
</head>
<body class="overflow-x-hidden">

  <!-- Fondo -->
  <div id="background" class="fixed inset-0 z-0 bg-cover bg-center transition-opacity duration-1000"></div>

  <!-- Contenido -->
  <div class="relative z-10 min-h-screen text-white text-center p-4 md:p-10">

    <!-- Botón de regreso -->
    <button id="btn-back" class="btn-back-improved">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
      </svg>
      <span class="btn-text">Volver</span>
    </button>

    <!-- Espaciador para evitar solapamiento en móviles -->
    <div class="mobile-spacer"></div>

    <h1 class="text-3xl font-bold mb-4 animate__animated animate__fadeInDown">Combinaciones Sugeridas</h1>

    <!-- Sección de combinaciones aleatorias -->
    <div id="aleatorias-container" class="analisis-transparente rounded-xl p-6 max-w-4xl mx-auto mb-8 hover:shadow-xl transition-all duration-300">
      <!-- Botón del acordeón -->
      <div class="text-center cursor-pointer" onclick="toggleAleatorias()">
        <p class="text-lg text-white mb-2">
          Genera TUS combinaciones completamente al azar
        </p>
        
        <!-- Indicador de expansión -->
        <div class="flex justify-center items-center">
          <span class="text-sm text-gray-300 mr-2">Haz clic para ver</span>
          <svg id="arrow-icon-aleatorias" class="w-5 h-5 text-gray-300 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </div>
      </div>

      <!-- Contenido expandible (oculto por defecto) -->
      <div id="contenido-aleatorias" class="hidden mt-6">
        <!-- Descripción -->
        <div class="text-center mb-8">
          <p class="text-sm text-gray-300">
            Números aleatorios del 1 al 56 • Sin análisis • Sin patrones • Solo suerte
          </p>
        </div>

        <!-- Selector de cantidad -->
        <div class="mb-6">
          <p class="text-white text-sm mb-3">¿Cuántas combinaciones deseas?</p>
          <div class="flex justify-center gap-3">
            <button id="btn-1" class="cantidad-btn active" data-cantidad="1">1</button>
            <button id="btn-3" class="cantidad-btn" data-cantidad="3">3</button>
            <button id="btn-5" class="cantidad-btn" data-cantidad="5">5</button>
          </div>
        </div>

        <!-- Botón para generar combinaciones -->
        <div class="text-center">
          <button id="btn-generar" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-3 rounded-full font-semibold hover:from-purple-600 hover:to-pink-600 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105">
            🎲 Generar Combinaciones Aleatorias
          </button>
        </div>

        <!-- Contenedor de combinaciones generadas aleatorias (dentro de la caja) -->
        <div id="combinaciones-container" class="mt-6">
          <!-- Contenido se genera dinámicamente aquí -->
        </div>
      </div>
    </div>

    <!-- Combinaciones sugeridas por IA -->
    <div id="prediccion-container" class="rounded-xl shadow-lg p-6 max-w-4xl mx-auto animate__animated animate__fadeInUp mb-8 cursor-pointer hover:shadow-xl transition-all duration-300 analisis-transparente" style="opacity: 0.5;" onclick="togglePrediccionIA()">
      <div class="text-center">
        <h2 class="text-xl font-semibold mb-4 text-white">🎯 <span id="titulo-sorteo">Combinaciones sugeridas por IA para TI para el sorteo "---"</span></h2>
        
        <!-- Indicador de expansión -->
        <div class="flex justify-center items-center">
          <span class="text-sm text-gray-300 mr-2">Haz clic para ver</span>
          <svg id="arrow-icon" class="w-5 h-5 text-gray-300 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </div>
      </div>
      
      <!-- Contenido expandible (oculto por defecto) -->
      <div id="contenido-predicciones" class="hidden mt-6">
        <p class="text-sm italic text-center mb-6 text-gray-300">Basado en tu perfil único, estadísticas históricas y patrones detectados</p>
        
        <!-- Predicciones por sorteo -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <!-- Melate -->
          <div class="text-center p-4 bg-blue-50 rounded-lg border-2 border-blue-200">
            <h3 class="font-bold text-blue-600 mb-2">🎲 Melate</h3>
            <p id="combinacion-melate" class="text-lg font-bold tracking-wider text-blue-800">-- -- -- -- -- --</p>
          </div>
          
          <!-- Revancha -->
          <div class="text-center p-4 bg-purple-50 rounded-lg border-2 border-purple-200">
            <h3 class="font-bold text-purple-600 mb-2">🎲 Revancha</h3>
            <p id="combinacion-revancha" class="text-lg font-bold tracking-wider text-purple-800">-- -- -- -- -- --</p>
          </div>
          
          <!-- Revanchita -->
          <div class="text-center p-4 bg-green-50 rounded-lg border-2 border-green-200">
            <h3 class="font-bold text-green-600 mb-2">🎲 Revanchita</h3>
            <p id="combinacion-revanchita" class="text-lg font-bold tracking-wider text-green-800">-- -- -- -- -- --</p>
          </div>
        </div>
        
        <!-- Mensaje de estado -->
        <div id="mensaje-estado" class="text-center text-sm text-gray-300 italic">
          Generando predicciones personalizadas...
        </div>
      </div>
    </div>

    <!-- Proyección basada en análisis estadístico -->
    <div id="analisis-container" class="rounded-xl shadow-lg p-6 max-w-4xl mx-auto animate__animated animate__fadeInUp mb-8 hover:shadow-xl transition-all duration-300 analisis-transparente" style="opacity: 0.8;">
      <div class="text-center cursor-pointer" onclick="toggleAnalisis()">
        <h2 class="text-xl font-semibold mb-4 text-white">📊 Proyección basada en los 4 tipos de análisis de los últimos sorteos</h2>
        
        <!-- Indicador de expansión -->
        <div class="flex justify-center items-center">
          <span class="text-sm text-gray-300 mr-2">Haz clic para ver</span>
          <svg id="arrow-icon-analisis" class="w-5 h-5 text-gray-300 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </div>
      </div>
      
      <!-- Contenido expandible (oculto por defecto) -->
      <div id="contenido-analisis" class="hidden mt-6">
        <p class="text-sm italic text-center mb-6 text-gray-300">Combinaciones generadas usando análisis de frecuencias, suma de números, balance pares/impares y distribución por décadas</p>
        
        <!-- Botón para generar nueva proyección -->
        <div class="text-center mb-6">
          <button id="btn-generar-analisis" class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-8 py-3 rounded-full font-semibold hover:from-orange-600 hover:to-red-600 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105">
            🧮 Generar Nueva Proyección
          </button>
        </div>
        
        <!-- Proyecciones por sorteo -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <!-- Melate -->
          <div class="text-center p-4 bg-orange-50 rounded-lg border-2 border-orange-200">
            <h3 class="font-bold text-orange-600 mb-2">📊 Melate</h3>
            <p id="proyeccion-melate" class="text-lg font-bold tracking-wider text-orange-800">-- -- -- -- -- --</p>
            <div class="text-xs text-gray-600 mt-2">
              <span id="detalle-melate">Generando análisis...</span>
            </div>
          </div>
          
          <!-- Revancha -->
          <div class="text-center p-4 bg-red-50 rounded-lg border-2 border-red-200">
            <h3 class="font-bold text-red-600 mb-2">📊 Revancha</h3>
            <p id="proyeccion-revancha" class="text-lg font-bold tracking-wider text-red-800">-- -- -- -- -- --</p>
            <div class="text-xs text-gray-600 mt-2">
              <span id="detalle-revancha">Generando análisis...</span>
            </div>
          </div>
          
          <!-- Revanchita -->
          <div class="text-center p-4 bg-yellow-50 rounded-lg border-2 border-yellow-200">
            <h3 class="font-bold text-yellow-600 mb-2">📊 Revanchita</h3>
            <p id="proyeccion-revanchita" class="text-lg font-bold tracking-wider text-yellow-800">-- -- -- -- -- --</p>
            <div class="text-xs text-gray-600 mt-2">
              <span id="detalle-revanchita">Generando análisis...</span>
            </div>
          </div>
        </div>
        
        <!-- Metodología utilizada -->
        <div class="bg-gray-800 bg-opacity-50 rounded-lg p-4 mt-4">
          <h4 class="text-white font-semibold mb-2 text-center">🔬 Metodología de Análisis</h4>
          <div class="grid grid-cols-2 md:grid-cols-5 gap-2 text-xs text-gray-300">
            <div class="text-center">
              <div class="text-yellow-400 font-bold">22%</div>
              <div>Frecuencias históricas</div>
            </div>
            <div class="text-center">
              <div class="text-blue-400 font-bold">22%</div>
              <div>Suma de números</div>
            </div>
            <div class="text-center">
              <div class="text-green-400 font-bold">22%</div>
              <div>Balance pares/impares</div>
            </div>
            <div class="text-center">
              <div class="text-purple-400 font-bold">22%</div>
              <div>Distribución por décadas</div>
            </div>
            <div class="text-center">
              <div class="text-red-400 font-bold">12%</div>
              <div>Factor aleatorio</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="mt-12 text-xs text-gray-400 max-w-4xl mx-auto">
      Este sistema genera números completamente al azar. No garantiza premios. Juega con responsabilidad.
    </footer>
  </div>

  <!-- Footer legal -->
  <div id="footer-container" class="w-full z-10 mt-8"></div>

  <!-- Scripts -->
  <script src="js/shared.js"></script>
  <script src="js/firebase-init.js" type="module"></script>
  <script src="js/dataParser.js" type="module"></script>
  <script src="js/mlPredictor.js" type="module"></script>
  <script>
    // Cargar footer legal en todas las páginas
    fetch("footer.html")
      .then(res => res.text())
      .then(data => {
        document.getElementById("footer-container").innerHTML = data;
      });
    
    // Definir togglePrediccionIA en el ámbito global para que esté disponible para el onclick
    window.togglePrediccionIA = function() {
      // Esta función se ejecutará mientras se carga el módulo y redirigirá a la función real cuando esté disponible
      console.log("Redirigiendo a la implementación del módulo...");
      if (window.togglePrediccionIAImpl) {
        window.togglePrediccionIAImpl();
      } else {
        console.error("La implementación de togglePrediccionIA no está lista aún");
      }
    };
  </script>
  <script type="module">
    import { cargarDatosHistoricos, generarCombinacionesAleatorias, analizarSumaNumeros, analizarParesImpares, analizarDecadaTerminacion, calcularFrecuencias } from './js/dataParser.js';
    import { generarPrediccionPersonalizada } from './js/mlPredictor.js';

    let cantidadSeleccionada = 1;
    let datosHistoricos = null;
    let prediccionesGeneradas = false;
    let usuarioActualID = null; // Variable para almacenar el ID del usuario actual
    let prediccionesAlmacenadas = {
      melate: null,
      revancha: null,
      revanchita: null
    };

    // Función para obtener el número de sorteo actual basado en el último sorteo de Melate
    function obtenerNumeroSorteoActual() {
      // Si tenemos datos históricos, obtenemos el último sorteo de Melate y le sumamos 1
      if (datosHistoricos && datosHistoricos.melate && datosHistoricos.melate.ultimoSorteo) {
        const ultimoSorteo = parseInt(datosHistoricos.melate.ultimoSorteo);
        if (!isNaN(ultimoSorteo)) {
          return ultimoSorteo + 1;
        }
      }
      
      // Fallback si no hay datos disponibles
      const fecha = new Date();
      const year = fecha.getFullYear();
      const month = fecha.getMonth() + 1;
      const day = fecha.getDate();
      
      const numeroSorteo = Math.floor(5000 + (month * 100) + day);
      return numeroSorteo;
    }

    // Función para actualizar el título con el número de sorteo
    function actualizarTituloSorteo() {
      const numeroSorteo = obtenerNumeroSorteoActual();
      const tituloElement = document.getElementById('titulo-sorteo');
      if (tituloElement) {
        tituloElement.textContent = `Combinaciones sugeridas por IA para TI para el sorteo ${numeroSorteo}`;
      }
    }

    // Función para toggle (expandir/colapsar) la predicción IA
    function togglePrediccionIA() {
      const contenido = document.getElementById('contenido-predicciones');
      const arrow = document.getElementById('arrow-icon');
      const container = document.getElementById('prediccion-container');
      
      if (!contenido || !arrow || !container) {
        console.error('❌ Elementos de UI no encontrados');
        return;
      }
      
      if (contenido.classList.contains('hidden')) {
        // Cerrar las otras cajas si están abiertas
        cerrarCajaAleatorias();
        cerrarCajaAnalisis();
        
        // Expandir esta caja
        contenido.classList.remove('hidden');
        arrow.style.transform = 'rotate(180deg)';
        container.style.opacity = '1';
        
        try {
          if (!prediccionesGeneradas) {
            console.log('🔄 Iniciando generación de predicciones...');
            generarPrediccionesPorSorteo()
              .then(() => {
                prediccionesGeneradas = true;
                console.log('✅ Predicciones generadas exitosamente');
              })
              .catch(error => {
                console.error('❌ Error generando predicciones:', error);
                const mensajeEstado = document.getElementById('mensaje-estado');
                if (mensajeEstado) {
                  mensajeEstado.textContent = 'Error al generar predicciones. Intente nuevamente.';
                }
              });
          }
        } catch (error) {
          console.error('❌ Error en togglePrediccionIA:', error);
        }
      } else {
        // Colapsar
        contenido.classList.add('hidden');
        arrow.style.transform = 'rotate(0deg)';
        container.style.opacity = '0.5';
      }
    }

    // Hacer la implementación disponible para el redireccionador global
    window.togglePrediccionIAImpl = togglePrediccionIA;

    // Función para toggle (expandir/colapsar) la sección de aleatorias
    function toggleAleatorias() {
      const contenido = document.getElementById('contenido-aleatorias');
      const arrow = document.getElementById('arrow-icon-aleatorias');
      
      if (!contenido || !arrow) {
        console.error('❌ Elementos de UI aleatorias no encontrados');
        return;
      }
      
      if (contenido.classList.contains('hidden')) {
        // Cerrar las otras cajas si están abiertas
        cerrarCajaPredicciones();
        cerrarCajaAnalisis();
        
        // Expandir esta caja
        contenido.classList.remove('hidden');
        arrow.style.transform = 'rotate(180deg)';
      } else {
        // Colapsar y limpiar resultados
        contenido.classList.add('hidden');
        arrow.style.transform = 'rotate(0deg)';
        
        // Limpiar las combinaciones generadas cuando se cierra
        limpiarCombinacionesAleatorias();
      }
    }

    // Función auxiliar para cerrar la caja de aleatorias
    function cerrarCajaAleatorias() {
      const contenido = document.getElementById('contenido-aleatorias');
      const arrow = document.getElementById('arrow-icon-aleatorias');
      
      if (contenido && !contenido.classList.contains('hidden')) {
        contenido.classList.add('hidden');
        if (arrow) arrow.style.transform = 'rotate(0deg)';
        
        // Limpiar las combinaciones generadas cuando se cierra
        limpiarCombinacionesAleatorias();
      }
    }

    // Función auxiliar para cerrar la caja de predicciones
    function cerrarCajaPredicciones() {
      const contenido = document.getElementById('contenido-predicciones');
      const arrow = document.getElementById('arrow-icon');
      const container = document.getElementById('prediccion-container');
      
      if (contenido && !contenido.classList.contains('hidden')) {
        contenido.classList.add('hidden');
        if (arrow) arrow.style.transform = 'rotate(0deg)';
        if (container) container.style.opacity = '0.5';
      }
    }

    // Función auxiliar para cerrar la caja de análisis
    function cerrarCajaAnalisis() {
      const contenido = document.getElementById('contenido-analisis');
      const arrow = document.getElementById('arrow-icon-analisis');
      
      if (contenido && !contenido.classList.contains('hidden')) {
        contenido.classList.add('hidden');
        if (arrow) arrow.style.transform = 'rotate(0deg)';
      }
    }

    // Función para limpiar las combinaciones aleatorias generadas
    function limpiarCombinacionesAleatorias() {
      const container = document.getElementById('combinaciones-container');
      if (container) {
        container.innerHTML = '';
        console.log('🧹 Combinaciones aleatorias limpiadas');
      }
    }

    // Función para toggle (expandir/colapsar) la sección de análisis
    function toggleAnalisis() {
      const contenido = document.getElementById('contenido-analisis');
      const arrow = document.getElementById('arrow-icon-analisis');
      
      if (!contenido || !arrow) {
        console.error('❌ Elementos de UI análisis no encontrados');
        return;
      }
      
      if (contenido.classList.contains('hidden')) {
        // Cerrar las otras cajas si están abiertas
        cerrarCajaAleatorias();
        cerrarCajaPredicciones();
        
        // Expandir esta caja
        contenido.classList.remove('hidden');
        arrow.style.transform = 'rotate(180deg)';
        
        // Generar proyecciones automáticamente al abrir
        setTimeout(() => {
          generarProyeccionesAnalisis();
        }, 300);
      } else {
        // Colapsar
        contenido.classList.add('hidden');
        arrow.style.transform = 'rotate(0deg)';
      }
    }

    // Hacer la función disponible globalmente
    window.toggleAnalisis = toggleAnalisis;

    // Hacer la función disponible globalmente
    window.toggleAleatorias = toggleAleatorias;

    // Botón de regreso
    document.getElementById('btn-back').addEventListener('click', () => {
      window.location.href = 'home.html';
    });

    // Manejo de botones de cantidad
    document.querySelectorAll('.cantidad-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.cantidad-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        cantidadSeleccionada = parseInt(btn.dataset.cantidad);
      });
    });

    // Botón para generar combinaciones aleatorias
    document.getElementById('btn-generar').addEventListener('click', async () => {
      console.log(`🎲 Generando ${cantidadSeleccionada} combinaciones aleatorias...`);
      
      const container = document.getElementById('combinaciones-container');
      container.innerHTML = `
        <div class="text-center py-8">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto mb-4"></div>
          <p class="text-white">Generando combinaciones...</p>
        </div>
      `;
      
      try {
        const combinaciones = generarCombinacionesAleatorias(cantidadSeleccionada);
        mostrarCombinaciones(combinaciones);
      } catch (error) {
        console.error('❌ Error generando combinaciones:', error);
        container.innerHTML = `
          <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
            <strong>Error:</strong> No se pudieron generar las combinaciones. ${error.message}
          </div>
        `;
      }
    });

    // Botón para generar nueva proyección de análisis
    document.getElementById('btn-generar-analisis').addEventListener('click', async () => {
      console.log('📊 Regenerando proyecciones de análisis...');
      await generarProyeccionesAnalisis();
    });

    // Función para mostrar combinaciones
    function mostrarCombinaciones(combinaciones) {
      const container = document.getElementById('combinaciones-container');
      
      const html = `
        <div class="bg-white bg-opacity-10 rounded-xl p-6 backdrop-blur-sm border border-white border-opacity-20">
          <h3 class="text-xl font-bold text-white mb-4 text-center">
            🎲 ${combinaciones.length} Combinación${combinaciones.length > 1 ? 'es' : ''} Aleatoria${combinaciones.length > 1 ? 's' : ''}
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            ${combinaciones.map((combo, index) => `
              <div class="bg-purple-500 bg-opacity-20 rounded-lg p-4 text-center border border-purple-300 border-opacity-30">
                <h4 class="text-lg font-semibold text-white mb-2">Combinación ${index + 1}</h4>
                <div class="flex justify-center space-x-2 mb-3">
                  ${combo.map(num => `
                    <span class="bg-white text-purple-600 font-bold py-1 px-2 rounded text-sm">
                      ${num}
                    </span>
                  `).join('')}
                </div>
                <button onclick="copiarCombinacion('${combo.join(', ')}')" class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-full transition-all duration-300">
                  📋 Copiar
                </button>
              </div>
            `).join('')}
          </div>
          <div class="text-center mt-6">
            <button id="btn-generar-nuevas" class="bg-gradient-to-r from-green-500 to-teal-500 text-white px-6 py-2 rounded-full font-semibold hover:from-green-600 hover:to-teal-600 transition-all duration-300 shadow-lg hover:shadow-xl">
              🔄 Generar Nuevas Combinaciones
            </button>
          </div>
        </div>
      `;
      
      container.innerHTML = html;
      
      // Agregar evento al botón de generar nuevas
      document.getElementById('btn-generar-nuevas').addEventListener('click', () => {
        generarYMostrarCombinaciones();
      });
    }

    // Función principal para generar y mostrar combinaciones
    function generarYMostrarCombinaciones() {
      console.log(`🎲 Generando ${cantidadSeleccionada} combinaciones aleatorias...`);
      
      const container = document.getElementById('combinaciones-container');
      container.innerHTML = `
        <div class="text-center py-8">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto mb-4"></div>
          <p class="text-white">Generando combinaciones...</p>
        </div>
      `;
      
      try {
        const combinaciones = generarCombinacionesAleatorias(cantidadSeleccionada);
        mostrarCombinaciones(combinaciones);
      } catch (error) {
        console.error('❌ Error generando combinaciones:', error);
        container.innerHTML = `
          <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
            <strong>Error:</strong> No se pudieron generar las combinaciones. ${error.message}
          </div>
        `;
      }
    }

    // === FUNCIONES PARA PROYECCIONES BASADAS EN ANÁLISIS ===
    
    // Función principal para generar proyecciones basadas en análisis
    async function generarProyeccionesAnalisis() {
      console.log('📊 Generando proyecciones basadas en análisis estadístico...');
      
      try {
        // Asegurar que tenemos datos históricos
        if (!datosHistoricos) {
          datosHistoricos = await cargarDatosHistoricos('todos');
        }
        
        const sorteos = ['melate', 'revancha', 'revanchita'];
        
        for (const sorteo of sorteos) {
          try {
            if (!datosHistoricos[sorteo] || !datosHistoricos[sorteo].numeros) {
              console.warn(`⚠️ No hay datos disponibles para ${sorteo}`);
              continue;
            }
            
            // Mostrar loading
            const elementoProyeccion = document.getElementById(`proyeccion-${sorteo}`);
            const elementoDetalle = document.getElementById(`detalle-${sorteo}`);
            if (elementoProyeccion) elementoProyeccion.textContent = '🔄 Analizando...';
            if (elementoDetalle) elementoDetalle.textContent = 'Procesando 4 tipos de análisis...';
            
            // Generar proyección
            const proyeccion = await generarProyeccionPorAnalisis(datosHistoricos[sorteo], sorteo);
            
            if (elementoProyeccion && proyeccion.numeros) {
              elementoProyeccion.textContent = proyeccion.numeros.join(' - ');
            }
            
            if (elementoDetalle && proyeccion.detalle) {
              elementoDetalle.textContent = proyeccion.detalle;
            }
            
            console.log(`✅ Proyección para ${sorteo}:`, proyeccion.numeros);
            
          } catch (error) {
            console.error(`❌ Error generando proyección para ${sorteo}:`, error);
            const elementoProyeccion = document.getElementById(`proyeccion-${sorteo}`);
            if (elementoProyeccion) elementoProyeccion.textContent = 'Error al generar';
          }
        }
        
      } catch (error) {
        console.error('❌ Error en el sistema de proyección:', error);
      }
    }
    
    // Función para generar una proyección específica por sorteo
    async function generarProyeccionPorAnalisis(datosSorteo, sorteo) {
      console.log(`🔍 Generando proyección para ${sorteo}...`);
      
      // Análisis 1: Frecuencias históricas (22%)
      const frecuencias = calcularFrecuencias(datosSorteo.numeros);
      const numerosPorFrecuencia = seleccionarPorFrecuencia(frecuencias);
      
      // Análisis 2: Suma de números (22%)
      const analisisSuma = analizarSumaNumeros({[sorteo]: datosSorteo});
      const numerosPorSuma = seleccionarPorSuma(analisisSuma[sorteo]);
      
      // Análisis 3: Balance pares/impares (22%)
      const analisisPares = analizarParesImpares({[sorteo]: datosSorteo});
      const numerosPorBalance = seleccionarPorBalance(analisisPares[sorteo]);
      
      // Análisis 4: Distribución por décadas (22%)
      const analisisDecadas = analizarDecadaTerminacion({[sorteo]: datosSorteo});
      const numerosPorDecadas = seleccionarPorDecadas(analisisDecadas[sorteo]);
      
      // Factor aleatorio (12%)
      const numerosAleatorios = generarNumerosAleatorios();
      
      // Combinar todos los análisis con sus pesos
      const combinacionFinal = combinarAnalisis({
        frecuencias: numerosPorFrecuencia,
        suma: numerosPorSuma,
        balance: numerosPorBalance,
        decadas: numerosPorDecadas,
        aleatorios: numerosAleatorios
      });
      
      const detalle = `F:${numerosPorFrecuencia.slice(0,2).join(',')} S:${numerosPorSuma.slice(0,2).join(',')} B:${numerosPorBalance.slice(0,2).join(',')} D:${numerosPorDecadas.slice(0,2).join(',')}`;
      
      return {
        numeros: combinacionFinal,
        detalle: detalle
      };
    }
    
    // Seleccionar números por frecuencia (más frecuentes tienen mayor probabilidad)
    function seleccionarPorFrecuencia(frecuencias) {
      const ordenados = Object.entries(frecuencias)
        .sort(([,a], [,b]) => b - a)
        .map(([num]) => parseInt(num));
      
      // Seleccionar los 20 más frecuentes con algo de variación
      const candidatos = ordenados.slice(0, 20);
      return mezclarArray(candidatos).slice(0, 8);
    }
    
    // Seleccionar números por suma (buscar números que sumen en el rango óptimo)
    function seleccionarPorSuma(analisisSuma) {
      const rangoOptimo = analisisSuma.rangoMasFrecuente[0]; // '150-199', etc.
      const [min, max] = rangoOptimo.split('-').map(n => parseInt(n) || 300);
      
      // Generar números que tiendan a sumar en ese rango
      const numeros = [];
      const targetSum = (min + max) / 2; // Suma objetivo
      const avgPerNumber = targetSum / 6; // Promedio por número
      
      for (let i = 0; i < 8; i++) {
        const variation = (Math.random() - 0.5) * 20; // Variación de ±10
        const numero = Math.max(1, Math.min(56, Math.round(avgPerNumber + variation)));
        numeros.push(numero);
      }
      
      return [...new Set(numeros)].slice(0, 8); // Eliminar duplicados
    }
    
    // Seleccionar números por balance pares/impares
    function seleccionarPorBalance(analisisPares) {
      const distribucionOptima = analisisPares.distribucionMasFrecuente[0]; // '3p-3i', etc.
      const [pares] = distribucionOptima.split('-').map(s => parseInt(s.replace('p', '')));
      
      const numerosPares = [];
      const numerosImpares = [];
      
      // Generar pares e impares según la distribución óptima
      for (let i = 2; i <= 56; i += 2) {
        if (numerosPares.length < 4) numerosPares.push(i);
      }
      
      for (let i = 1; i <= 56; i += 2) {
        if (numerosImpares.length < 4) numerosImpares.push(i);
      }
      
      const seleccionados = [];
      seleccionados.push(...mezclarArray(numerosPares).slice(0, Math.min(pares, 4)));
      seleccionados.push(...mezclarArray(numerosImpares).slice(0, Math.min(6-pares, 4)));
      
      return mezclarArray(seleccionados).slice(0, 8);
    }
    
    // Seleccionar números por décadas
    function seleccionarPorDecadas(analisisDecadas) {
      const decadaOptima = analisisDecadas.decadaMasFrecuente[0]; // '21-30', etc.
      const [min, max] = decadaOptima.split('-').map(n => parseInt(n));
      
      const numerosDeLaDecada = [];
      for (let i = min; i <= max; i++) {
        numerosDeLaDecada.push(i);
      }
      
      // Seleccionar algunos de la década óptima y algunos aleatorios
      const seleccionados = [];
      seleccionados.push(...mezclarArray(numerosDeLaDecada).slice(0, 4));
      
      // Agregar algunos números de otras décadas
      const otrosNumeros = [];
      for (let i = 1; i <= 56; i++) {
        if (i < min || i > max) otrosNumeros.push(i);
      }
      seleccionados.push(...mezclarArray(otrosNumeros).slice(0, 4));
      
      return mezclarArray(seleccionados).slice(0, 8);
    }
    
    // Generar números completamente aleatorios
    function generarNumerosAleatorios() {
      const numeros = [];
      while (numeros.length < 8) {
        const num = Math.floor(Math.random() * 56) + 1;
        if (!numeros.includes(num)) {
          numeros.push(num);
        }
      }
      return numeros;
    }
    
    // Combinar todos los análisis según los pesos especificados
    function combinarAnalisis(analisis) {
      const pool = [];
      
      // Agregar números según los pesos (22%, 22%, 22%, 22%, 12%)
      // Para 6 números finales, esto se traduce aproximadamente a:
      analisis.frecuencias.forEach(num => pool.push(num, num)); // 2 veces (peso alto)
      analisis.suma.forEach(num => pool.push(num, num)); // 2 veces
      analisis.balance.forEach(num => pool.push(num, num)); // 2 veces  
      analisis.decadas.forEach(num => pool.push(num, num)); // 2 veces
      analisis.aleatorios.forEach(num => pool.push(num)); // 1 vez (peso bajo)
      
      // Seleccionar 6 números únicos del pool
      const numerosUnicos = [...new Set(pool)];
      const combinacionFinal = mezclarArray(numerosUnicos).slice(0, 6).sort((a, b) => a - b);
      
      // Si no tenemos 6 números, completar con aleatorios
      while (combinacionFinal.length < 6) {
        const num = Math.floor(Math.random() * 56) + 1;
        if (!combinacionFinal.includes(num)) {
          combinacionFinal.push(num);
        }
      }
      
      return combinacionFinal.sort((a, b) => a - b);
    }
    
    // Función auxiliar para mezclar array
    function mezclarArray(array) {
      const arr = [...array];
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // Función para generar un conjunto de números aleatorios como fallback
    function generarCombinacionFallback() {
      const numeros = new Set();
      while (numeros.size < 6) {
        numeros.add(Math.floor(Math.random() * 56) + 1);
      }
      return Array.from(numeros).sort((a, b) => a - b);
    }
    
    // Función para generar predicciones por sorteo con análisis avanzado de IA
    async function generarPrediccionesPorSorteo() {
      console.log('🤖 Generando predicciones avanzadas con IA...');
      
      const mensajeEstado = document.getElementById('mensaje-estado');
      if (mensajeEstado) {
        mensajeEstado.textContent = 'Generando predicciones con métodos avanzados de análisis...';
      }
      
      // Establecer un timeout para garantizar que siempre tengamos una respuesta
      const timeoutPromise = new Promise(resolve => {
        setTimeout(() => {
          resolve('timeout');
        }, 10000); // 10 segundos de timeout
      });
      
      try {
        // Cargar datos históricos si no están cargados
        if (!datosHistoricos) {
          datosHistoricos = await Promise.race([cargarDatosHistoricos('todos'), timeoutPromise]);
          if (datosHistoricos === 'timeout') {
            throw new Error('Tiempo de espera agotado al cargar datos históricos');
          }
        }
        
        // Generar predicciones para cada sorteo usando el ID real del usuario
        const sorteos = ['melate', 'revancha', 'revanchita'];
        // Usar el ID real del usuario autenticado para predicciones personalizadas
        const userId = usuarioActualID || 'usuario-no-autenticado';
        
        // Intentar cargar predicciones almacenadas
        cargarPrediccionesAlmacenadas(userId);
        
        for (const sorteo of sorteos) {
          try {
            // Verificar que existan datos para este sorteo
            if (!datosHistoricos[sorteo] || !datosHistoricos[sorteo].numeros || datosHistoricos[sorteo].numeros.length === 0) {
              console.warn(`⚠️ No hay datos históricos disponibles para ${sorteo}`);
              const elementoCombo = document.getElementById(`combinacion-${sorteo}`);
              if (elementoCombo) {
                elementoCombo.textContent = 'Datos insuficientes';
              }
              continue;
            }
            
            // Verificar si tenemos una predicción almacenada para este usuario y sorteo
            const elementoCombo = document.getElementById(`combinacion-${sorteo}`);
            
            // Si ya tenemos una predicción almacenada y válida para este sorteo, usarla
            if (prediccionesAlmacenadas[sorteo] && 
                prediccionesAlmacenadas[sorteo].userId === userId && 
                prediccionesAlmacenadas[sorteo].ultimoSorteo === datosHistoricos[sorteo].ultimoSorteo) {
                
              console.log(`🔄 Usando predicción almacenada para ${sorteo}`);
              
              if (elementoCombo && prediccionesAlmacenadas[sorteo].prediccion) {
                elementoCombo.textContent = prediccionesAlmacenadas[sorteo].prediccion.join(' - ');
                console.log(`✅ Predicción almacenada para ${sorteo} cargada:`, prediccionesAlmacenadas[sorteo].prediccion);
              }
              continue;
            }
            
            // Si llegamos aquí, necesitamos generar una nueva predicción
            
            // Crear objeto de datos específico para este sorteo con metadatos adicionales
            const datosSorteo = {
              numeros: datosHistoricos[sorteo].numeros,
              datos: datosHistoricos[sorteo].sorteos,
              sorteo: sorteo, // Identificador clave para diferenciar cada juego
              ultimoSorteo: datosHistoricos[sorteo].ultimoSorteo,
              fechaGeneracion: new Date().toISOString()
            };
            
            // Log para depuración
            console.log(`🔍 Preparando predicción con IA para ${sorteo}:`, {
              tipoSorteo: sorteo,
              cantidadNumeros: datosHistoricos[sorteo].numeros.length,
              cantidadSorteos: datosHistoricos[sorteo].sorteos.length,
              ultimoSorteo: datosHistoricos[sorteo].ultimoSorteo
            });
            
            // Mostrar spinner mientras se procesa
            if (elementoCombo) {
              elementoCombo.innerHTML = '<span class="animate-pulse">Analizando datos...</span>';
            }
            
            // Generar predicción personalizada usando los 5 métodos de análisis
            // La función espera (userId, datos)
            const prediccion = await generarPrediccionPersonalizada(userId, datosSorteo);
            
            if (elementoCombo && prediccion && prediccion.length === 6) {
              elementoCombo.textContent = prediccion.join(' - ');
              console.log(`✅ Predicción IA para ${sorteo} generada:`, prediccion);
              
              // Almacenar la predicción para uso futuro
              prediccionesAlmacenadas[sorteo] = {
                userId: userId,
                prediccion: prediccion,
                ultimoSorteo: datosHistoricos[sorteo].ultimoSorteo,
                timestamp: new Date().getTime()
              };
              
              // Guardar en localStorage
              guardarPrediccionesAlmacenadas();
            }
          } catch (error) {
            console.error(`❌ Error generando predicción para ${sorteo}:`, error);
            const elementoCombo = document.getElementById(`combinacion-${sorteo}`);
            if (elementoCombo) {
              elementoCombo.textContent = 'Error al generar';
            }
          }
        }
        
        if (mensajeEstado) {
          mensajeEstado.textContent = 'Predicciones generadas con análisis completo de 5 métodos';
        }
        
      } catch (error) {
        console.error('❌ Error en el sistema de predicción:', error);
        if (mensajeEstado) {
          mensajeEstado.textContent = 'Error al generar predicciones';
        }
      }
    }
    
    // Función para guardar predicciones en localStorage
    function guardarPrediccionesAlmacenadas() {
      try {
        localStorage.setItem('ya-me-vi-predicciones', JSON.stringify(prediccionesAlmacenadas));
        console.log('💾 Predicciones guardadas en localStorage');
      } catch (error) {
        console.error('❌ Error guardando predicciones en localStorage:', error);
      }
    }
    
    // Función para cargar predicciones desde localStorage
    function cargarPrediccionesAlmacenadas(userId) {
      try {
        const datosGuardados = localStorage.getItem('ya-me-vi-predicciones');
        if (datosGuardados) {
          const prediccionesGuardadas = JSON.parse(datosGuardados);
          
          // Solo restaurar si el userId coincide
          for (const sorteo in prediccionesGuardadas) {
            if (prediccionesGuardadas[sorteo] && prediccionesGuardadas[sorteo].userId === userId) {
              prediccionesAlmacenadas[sorteo] = prediccionesGuardadas[sorteo];
            }
          }
          
          console.log('📂 Predicciones cargadas desde localStorage:', prediccionesAlmacenadas);
        }
      } catch (error) {
        console.error('❌ Error cargando predicciones desde localStorage:', error);
      }
    }

    // Inicializar con valor temporal
    actualizarTituloSorteo();
    
    // Cargar datos históricos al inicio
    cargarDatosHistoricos('todos').then(datos => {
      datosHistoricos = datos;
      console.log('✅ Datos históricos cargados en sugeridas.html');
      // Actualizar el título con el número real una vez que tenemos los datos
      actualizarTituloSorteo();
    }).catch(error => {
      console.error('❌ Error cargando datos históricos:', error);
    });

  </script>
  <script type="module">
    // Código de autenticación y verificación de usuario
    import { auth, onAuthStateChanged } from './js/firebase-init.js';
    import { cargarDatosHistoricos } from './js/dataParser.js';

    // Verificar autenticación y cargar datos
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "index.html";
      } else {
        usuarioActualID = user.uid; // Guardar el ID del usuario actual para usar en predicciones
        console.log('👤 Usuario autenticado:', usuarioActualID);
        
        // Actualizar título con número de sorteo
        actualizarTituloSorteo();
        
        try {
          datosHistoricos = await cargarDatosHistoricos('todos');
          console.log('📊 Datos históricos cargados para predicciones IA');
          
          // Cargar predicciones almacenadas para el usuario autenticado
          cargarPrediccionesAlmacenadas(usuarioActualID);
        } catch (error) {
          console.error('❌ Error cargando datos históricos:', error);
        }
      }
    });

    // Función para generar un número aleatorio entre min y max (inclusive)
    function numeroAleatorio(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    // Función para generar una combinación de 6 números únicos
    function generarCombinacion() {
      const numeros = new Set();
      
      while (numeros.size < 6) {
        numeros.add(numeroAleatorio(1, 56));
      }
      
      return Array.from(numeros).sort((a, b) => a - b);
    }

    // Función para generar múltiples combinaciones
    function generarCombinaciones(cantidad = cantidadSeleccionada) {
      const combinaciones = [];
      
      // Generar la cantidad seleccionada de combinaciones
      for (let i = 0; i < cantidad; i++) {
        combinaciones.push(generarCombinacion());
      }
      
      return combinaciones;
    }

    // Función para copiar combinación al portapapeles
    window.copiarCombinacion = function(combinacion) {
      navigator.clipboard.writeText(combinacion).then(() => {
        // Mostrar mensaje de éxito
        const mensaje = document.createElement('div');
        mensaje.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg z-50';
        mensaje.textContent = '✅ Combinación copiada';
        document.body.appendChild(mensaje);
        
        setTimeout(() => {
          mensaje.remove();
        }, 2000);
      }).catch(() => {
        // Fallback si no se puede copiar
        const mensaje = document.createElement('div');
        mensaje.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg z-50';
        mensaje.textContent = '❌ Error al copiar';
        document.body.appendChild(mensaje);
        
        setTimeout(() => {
          mensaje.remove();
        }, 2000);
      });
    };

  </script>

  <style>
    .analisis-transparente {
      background-color: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
    }
    
    .cantidad-btn {
      background-color: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .cantidad-btn:hover {
      background-color: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.5);
      transform: scale(1.05);
    }
    
    .cantidad-btn.active {
      background-color: rgba(147, 51, 234, 0.8);
      border-color: rgb(147, 51, 234);
      box-shadow: 0 0 20px rgba(147, 51, 234, 0.5);
    }
  </style>
</body>
</html>
