<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>YA ME VI - Combinaciones Sugeridas</title>
  
  <!-- Favicon -->
  <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
  <link rel="icon" href="assets/logo-192.png" sizes="192x192" type="image/png">
  <link rel="icon" href="assets/logo-512.png" sizes="512x512" type="image/png">
  
  <!-- Web App Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <!-- PWA Meta -->
  <meta name="theme-color" content="#00B44F">
  <meta name="mobile-web-app-capable" content="yes">
  
  <!-- iOS Safari Meta -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="YA ME VI">
  
  <!-- iOS Touch Icon - CONFIGURACI√ìN SIMPLIFICADA -->
  <link rel="apple-touch-icon" href="assets/apple-touch-icon.png">
  
  <!-- iOS Startup Images -->
  <link rel="apple-touch-startup-image" href="assets/logo-512.png">
  
  <!-- Additional iOS Meta -->
  <meta name="format-detection" content="telephone=no">
  <meta name="apple-mobile-web-app-title" content="YA ME VI">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <link rel="stylesheet" href="css/styles.css" />
  
  <!-- Google AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2226536008153511"
     crossorigin="anonymous"></script>
     
  <style>
    /* Prevenir scroll autom√°tico en m√≥viles */
    html {
      scroll-behavior: auto !important;
    }
    
    /* Mejorar estabilidad del acorde√≥n en m√≥vil */
    .analisis-transparente {
      transform: translateZ(0);
      will-change: auto;
    }
    
    .analisis-transparente:focus {
      outline: none;
    }
    
    /* Prevenir cambios de layout que puedan causar scroll */
    .contenido-expandible {
      transition: opacity 0.3s ease;
    }
    
    /* Evitar zoom autom√°tico en inputs en iOS */
    @media screen and (max-width: 768px) {
      body {
        position: relative;
        overflow-x: hidden;
      }
    }
  </style>
  <script src="js/init.js"></script>
  <script src="js/dataParser.js"></script>
  <script src="js/mlPredictor.js"></script>
  <script src="js/actualizarTituloSorteo.js"></script>
  <script>
    // Asegurar que se generen nuevos n√∫meros cada vez que se abre la caja de an√°lisis
    document.addEventListener('DOMContentLoaded', function() {
      const cajaAnalisis = document.querySelector('[onclick*="toggleAnalisis"]');
      if (cajaAnalisis) {
        cajaAnalisis.addEventListener('click', async function(e) {
          if (this.getAttribute('data-estado') !== 'abierto') {
            this.setAttribute('data-estado', 'abierto');
            // Forzar nueva generaci√≥n
            await window.generarProyeccionesAnalisis();
          } else {
            this.setAttribute('data-estado', 'cerrado');
          }
        });
      }
    });
  </script>
</head>
<body class="overflow-x-hidden" onload="if(window.yaMeVi)window.yaMeVi.init()">

  <!-- Fondo -->
  <div id="background" class="fixed inset-0 z-0 bg-cover bg-center transition-opacity duration-1000"></div>

  <!-- Contenido -->
  <div class="relative z-10 min-h-screen text-white text-center p-4 md:p-10">

    <!-- Bot√≥n de regreso -->
    <button id="btn-back" class="btn-back-improved" onclick="window.location.href='home.html'">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
      </svg>
      <span class="btn-text">Volver</span>
    </button>

    <!-- Espaciador para evitar solapamiento en m√≥viles -->
    <div class="mobile-spacer"></div>

    <h1 class="text-3xl font-bold mb-4 animate__animated animate__fadeInDown">Combinaciones Sugeridas</h1>

    <!-- Secci√≥n de combinaciones aleatorias -->
    <div id="aleatorias-container" class="analisis-transparente rounded-xl p-6 max-w-4xl mx-auto mb-8 hover:shadow-xl transition-all duration-300">
      <!-- Bot√≥n del acorde√≥n -->
      <div class="text-center cursor-pointer" onclick="toggleAleatorias()">
        <p class="text-lg text-white mb-2">
          üé≤ Genera TUS combinaciones completamente al azar
        </p>
        
        <!-- Indicador de expansi√≥n -->
        <div class="flex justify-center items-center">
          <span class="text-sm text-gray-300 mr-2">Haz clic para ver</span>
          <svg id="arrow-icon-aleatorias" class="w-5 h-5 text-gray-300 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </div>
      </div>

      <!-- Contenido expandible (oculto por defecto) -->
      <div id="contenido-aleatorias" class="hidden mt-6 contenido-expandible">
        <!-- Descripci√≥n -->
        <div class="text-center mb-8">
          <p class="text-sm text-gray-300">
            N√∫meros aleatorios del 1 al 56 ‚Ä¢ Sin an√°lisis ‚Ä¢ Sin patrones ‚Ä¢ Solo suerte
          </p>
        </div>

        <!-- Bot√≥n para generar combinaciones -->
        <div class="text-center">
          <button id="btn-generar" onclick="if(window.mostrarCombinacionAleatoria){window.mostrarCombinacionAleatoria();}else{console.log('‚ùå Funci√≥n no disponible');}" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-3 rounded-full font-semibold hover:from-purple-600 hover:to-pink-600 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105">
            üé≤ Generar Combinaciones Aleatorias
          </button>
        </div>

        <!-- Contenedor de combinaciones generadas aleatorias (dentro de la caja) -->
        <div id="combinaciones-container" class="mt-6">
          <!-- Contenido se genera din√°micamente aqu√≠ -->
        </div>
      </div>
    </div>

    <!-- Combinaciones sugeridas por IA -->
    <div id="prediccion-container" class="rounded-xl shadow-lg p-6 max-w-4xl mx-auto animate__animated animate__fadeInUp mb-8 cursor-pointer hover:shadow-xl transition-all duration-300 analisis-transparente" style="opacity: 0.5;" onclick="togglePrediccionIA();">
      <div class="text-center">
        <p class="text-lg text-white mb-2">
          <span id="titulo-sorteo">üéØ Combinaciones sugeridas por IA para TI para el sorteo "---"</span>
        </p>
        
        <!-- Indicador de expansi√≥n -->
        <div class="flex justify-center items-center">
          <span class="text-sm text-gray-300 mr-2">Haz clic para ver</span>
          <svg id="arrow-icon" class="w-5 h-5 text-gray-300 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </div>
      </div>
      
      <!-- Contenido expandible (oculto por defecto) -->
      <div id="contenido-predicciones" class="hidden mt-6 contenido-expandible">
        <p class="text-sm italic text-center mb-6 text-gray-300">Basado en tu perfil √∫nico, estad√≠sticas hist√≥ricas y patrones detectados</p>
        
        <!-- Predicciones por sorteo -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <!-- Melate -->
          <div class="text-center p-4 bg-blue-50 rounded-lg border-2 border-blue-200">
            <h3 class="font-bold text-blue-600 mb-2">üé≤ Melate</h3>
            <p id="combinacion-melate" class="text-lg font-bold tracking-wider text-blue-800">-- -- -- -- -- --</p>
          </div>
          
          <!-- Revancha -->
          <div class="text-center p-4 bg-purple-50 rounded-lg border-2 border-purple-200">
            <h3 class="font-bold text-purple-600 mb-2">üé≤ Revancha</h3>
            <p id="combinacion-revancha" class="text-lg font-bold tracking-wider text-purple-800">-- -- -- -- -- --</p>
          </div>
          
          <!-- Revanchita -->
          <div class="text-center p-4 bg-green-50 rounded-lg border-2 border-green-200">
            <h3 class="font-bold text-green-600 mb-2">üé≤ Revanchita</h3>
            <p id="combinacion-revanchita" class="text-lg font-bold tracking-wider text-green-800">-- -- -- -- -- --</p>
          </div>
        </div>
        
        <!-- Mensaje de estado -->
        <div id="mensaje-estado" class="text-center text-sm text-gray-300 italic">
          Generando predicciones personalizadas...
        </div>
      </div>
    </div>

    <!-- Proyecci√≥n basada en an√°lisis estad√≠stico -->
    <div id="analisis-container" class="rounded-xl shadow-lg p-6 max-w-4xl mx-auto animate__animated animate__fadeInUp mb-8 hover:shadow-xl transition-all duration-300 analisis-transparente" style="opacity: 0.8;">
      <div class="text-center cursor-pointer" onclick="toggleAnalisis();">
        <p class="text-lg text-white mb-2">
          üìä Proyecci√≥n basada en los 4 tipos de an√°lisis de los √∫ltimos sorteos
        </p>
        
        <!-- Indicador de expansi√≥n -->
        <div class="flex justify-center items-center">
          <span class="text-sm text-gray-300 mr-2">Haz clic para ver</span>
          <svg id="arrow-icon-analisis" class="w-5 h-5 text-gray-300 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </div>
      </div>
      
      <!-- Contenido expandible (oculto por defecto) -->
      <div id="contenido-analisis" class="hidden mt-6 contenido-expandible">
        <p class="text-sm italic text-center mb-6 text-gray-300">Combinaciones generadas usando an√°lisis de frecuencias, suma de n√∫meros, balance pares/impares y distribuci√≥n por d√©cadas</p>
        
        <!-- Proyecciones por sorteo -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <!-- Melate -->
          <div class="text-center p-4 bg-red-50 rounded-lg border-2 border-red-200">
            <h3 class="font-bold text-red-600 mb-2">üìä Melate</h3>
            <p id="proyeccion-melate" class="text-lg font-bold tracking-wider text-red-800">-- -- -- -- -- --</p>
            <div class="proyeccion-loading hidden">
              <div class="animate-spin rounded-full h-6 w-6 border-t-2 border-red-600 mx-auto my-2"></div>
              <p class="text-sm text-red-600">Generando predicci√≥n...</p>
            </div>
            <div class="text-xs text-gray-600 mt-2">
              <span id="detalle-melate" class="analisis-detalle">Preparando an√°lisis completo...</span>
            </div>
          </div>
          
          <!-- Revancha -->
          <div class="text-center p-4 bg-red-50 rounded-lg border-2 border-red-200">
            <h3 class="font-bold text-red-600 mb-2">üìä Revancha</h3>
            <p id="proyeccion-revancha" class="text-lg font-bold tracking-wider text-red-800">-- -- -- -- -- --</p>
            <div class="proyeccion-loading hidden">
              <div class="animate-spin rounded-full h-6 w-6 border-t-2 border-red-600 mx-auto my-2"></div>
              <p class="text-sm text-red-600">Generando predicci√≥n...</p>
            </div>
            <div class="text-xs text-gray-600 mt-2">
              <span id="detalle-revancha" class="analisis-detalle">Preparando an√°lisis completo...</span>
            </div>
          </div>
          
          <!-- Revanchita -->
          <div class="text-center p-4 bg-yellow-50 rounded-lg border-2 border-yellow-200">
            <h3 class="font-bold text-yellow-600 mb-2">üìä Revanchita</h3>
            <p id="proyeccion-revanchita" class="text-lg font-bold tracking-wider text-yellow-800">-- -- -- -- -- --</p>
            <div class="text-xs text-gray-600 mt-2">
              <span id="detalle-revanchita" class="analisis-detalle">Preparando an√°lisis completo...</span>
            </div>
          </div>
        </div>
        
        <!-- Metodolog√≠a utilizada -->
        <div class="bg-gray-800 bg-opacity-50 rounded-lg p-4 mt-4">
          <h4 class="text-white font-semibold mb-2 text-center">üî¨ Metodolog√≠a de An√°lisis</h4>
          <div class="grid grid-cols-2 md:grid-cols-5 gap-2 text-xs text-gray-300">
            <div class="text-center">
              <div class="text-yellow-400 font-bold">22%</div>
              <div>Frecuencias hist√≥ricas</div>
            </div>
            <div class="text-center">
              <div class="text-blue-400 font-bold">22%</div>
              <div>Suma de n√∫meros</div>
            </div>
            <div class="text-center">
              <div class="text-green-400 font-bold">22%</div>
              <div>Balance pares/impares</div>
            </div>
            <div class="text-center">
              <div class="text-purple-400 font-bold">22%</div>
              <div>Distribuci√≥n por d√©cadas</div>
            </div>
            <div class="text-center">
              <div class="text-red-400 font-bold">12%</div>
              <div>Factor aleatorio</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="bg-black bg-opacity-80 text-white text-xs text-center py-3 px-4 mt-8 md:relative md:z-auto">
      <div class="mb-2">
        Este sistema se basa en estad√≠sticas, patrones, probabilidad e inteligencia artificial. No garantiza premios. Juega con responsabilidad.
      </div>
      <div class="space-x-2">
        <a href="aviso-legal.html" class="text-yellow-300 hover:text-yellow-100 underline transition duration-300">Aviso legal</a>
        <span class="text-gray-400">|</span>
        <a href="politica-privacidad.html" class="text-yellow-300 hover:text-yellow-100 underline transition duration-300">Pol√≠tica de privacidad</a>
      </div>
    </footer>
  </div>

  <!-- Scripts -->
  <script src="js/shared.js"></script>
  <!-- Eliminados scripts de m√≥dulos conflictivos, todo est√° en inicializacion-unificada.js -->
  <script src="js/actualizarTituloSorteo.js"></script>
  <script>
    // Implementaciones fallback para funciones cr√≠ticas
    // Esto garantiza que siempre haya una implementaci√≥n disponible
    
    // Fallback para generarCombinacionesAleatorias
    if (typeof window.generarCombinacionesAleatorias !== 'function') {
      window.generarCombinacionesAleatorias = function(cantidad = 1) {
        console.log('‚ö†Ô∏è Usando implementaci√≥n fallback de generarCombinacionesAleatorias');
        const combinaciones = [];
        for (let i = 0; i < cantidad; i++) {
          const combo = new Set();
          while (combo.size < 6) {
            combo.add(Math.floor(Math.random() * 56) + 1);
          }
          combinaciones.push([...combo].sort((a, b) => a - b));
        }
        return combinaciones;
      };
    }
    
    // Fallback para generarPrediccionesPorSorteo - Esta funci√≥n debe estar disponible para que las predicciones IA funcionen
    if (typeof window.generarPrediccionesPorSorteo !== 'function') {
      window.generarPrediccionesPorSorteo = function() {
        console.log('‚ö†Ô∏è Usando implementaci√≥n fallback de generarPrediccionesPorSorteo');
        
        return new Promise((resolve) => {
          setTimeout(() => {
            // Generar predicciones b√°sicas para demostraci√≥n
            const sorteos = ['melate', 'revancha', 'revanchita'];
            const userId = window.usuarioActualID || 'usuario-demo';
            
            // Generar combinaciones con alg√∫n elemento de personalizaci√≥n
            const seed = hashCode(userId);
            
            sorteos.forEach((sorteo, index) => {
              const elemento = document.getElementById(`combinacion-${sorteo}`);
              if (elemento) {
                // Generar n√∫meros pseudo-aleatorios pero consistentes para el usuario
                const numeros = [];
                for (let i = 0; i < 6; i++) {
                  const num = 1 + ((seed + index * 7 + i * 11) % 56);
                  if (!numeros.includes(num)) {
                    numeros.push(num);
                  }
                }
                
                // Asegurar que tenemos 6 n√∫meros √∫nicos
                while (numeros.length < 6) {
                  const num = 1 + Math.floor(Math.random() * 56);
                  if (!numeros.includes(num)) {
                    numeros.push(num);
                  }
                }
                
                numeros.sort((a, b) => a - b);
                elemento.textContent = numeros.join(' - ');
              }
            });
            
            const mensajeEstado = document.getElementById('mensaje-estado');
            if (mensajeEstado) {
              mensajeEstado.textContent = 'Predicciones generadas con sistema b√°sico';
            }
            
            resolve();
          }, 800);
        });
      };
    }
    
    // Helper function for fallback
    function hashCode(str) {
      let hash = 0;
      if (str.length === 0) return hash;
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      return Math.abs(hash) % 2147483647;
    }

    // Fallback cr√≠tico para generarPrediccionPersonalizada - DEBE estar disponible
    if (typeof window.generarPrediccionPersonalizada !== 'function') {
      window.generarPrediccionPersonalizada = async function(userId, datos) {
        console.log('‚ö†Ô∏è Usando implementaci√≥n fallback de generarPrediccionPersonalizada');
        
        const sorteo = datos.sorteo || 'melate';
        console.log(`üé≤ Generando predicci√≥n fallback para ${sorteo} - usuario: ${userId}`);
        
        // Crear semilla √∫nica para el usuario y sorteo
        const semilla = hashCode(`${userId}-${sorteo}`);
        
        // Generar 6 n√∫meros √∫nicos entre 1 y 56
        const numeros = new Set();
        let intentos = 0;
        
        while (numeros.size < 6 && intentos < 100) {
          const num = 1 + ((semilla + intentos * 7) % 56);
          numeros.add(num);
          intentos++;
        }
        
        // Si no tenemos 6 n√∫meros, completar aleatoriamente
        while (numeros.size < 6) {
          numeros.add(1 + Math.floor(Math.random() * 56));
        }
        
        const resultado = Array.from(numeros).sort((a, b) => a - b);
        console.log(`‚úÖ Predicci√≥n fallback generada para ${sorteo}:`, resultado);
        
        return resultado;
      };
    }

    // Fallback para actualizarTituloSorteo
    if (typeof window.actualizarTituloSorteo !== 'function') {
      window.actualizarTituloSorteo = function() {
        console.log('‚ö†Ô∏è Usando implementaci√≥n fallback de actualizarTituloSorteo');
        const tituloElement = document.getElementById('titulo-sorteo');
        if (tituloElement) {
          // Generar un n√∫mero de sorteo aproximado basado en la fecha
          const fecha = new Date();
          const year = fecha.getFullYear() - 2000; // √öltimos dos d√≠gitos del a√±o
          const month = fecha.getMonth() + 1;
          const estimado = 3800 + (year * 10) + month;
          
          // COMENTADO: Dejamos que sugeridas-fix.js maneje el t√≠tulo
          // tituloElement.textContent = `Combinaciones sugeridas por IA para TI para el sorteo ${estimado}`;
        }
      };
    }
    
    // Fallback para generarPrediccionesPorSorteo
    if (typeof window.generarPrediccionesPorSorteo !== 'function') {
      window.generarPrediccionesPorSorteo = function() {
        console.log('‚ö†Ô∏è Usando implementaci√≥n fallback de generarPrediccionesPorSorteo');
        
        return new Promise((resolve) => {
          setTimeout(() => {
            // Generar predicciones b√°sicas para demostraci√≥n
            document.getElementById('combinacion-melate').textContent = '7 - 13 - 23 - 27 - 42 - 56';
            document.getElementById('combinacion-revancha').textContent = '3 - 19 - 24 - 31 - 38 - 51';
            document.getElementById('combinacion-revanchita').textContent = '5 - 12 - 26 - 33 - 47 - 54';
            document.getElementById('mensaje-estado').textContent = 'Predicciones generadas con √©xito';
            resolve();
          }, 800);
        });
      };
    }
    
    // Las funciones de an√°lisis son obligatorias
    if (!window.generarProyeccionesAnalisis) {
        console.warn('‚ö†Ô∏è generarProyeccionesAnalisis no disponible, usando implementaci√≥n fallback');
        window.generarProyeccionesAnalisis = function() {
          console.log('‚ö†Ô∏è Usando implementaci√≥n fallback de generarProyeccionesAnalisis');
          
          return new Promise((resolve) => {
            setTimeout(() => {
              document.getElementById('proyeccion-melate').textContent = '8 - 15 - 22 - 29 - 36 - 43';
              document.getElementById('proyeccion-revancha').textContent = '4 - 17 - 25 - 32 - 41 - 48';
              document.getElementById('proyeccion-revanchita').textContent = '3 - 16 - 22 - 31 - 44 - 52';
              
              document.getElementById('detalle-melate').textContent = 'N√∫meros sugeridos basados en el an√°lisis hist√≥rico';
              document.getElementById('detalle-revancha').textContent = 'N√∫meros sugeridos basados en el an√°lisis hist√≥rico';
              document.getElementById('detalle-revanchita').textContent = 'N√∫meros sugeridos basados en el an√°lisis hist√≥rico';
              resolve();
            }, 800);
          });
        };
    }
    
    // Fallback para mostrarCombinaciones
    if (typeof window.mostrarCombinaciones !== 'function') {
      window.mostrarCombinaciones = function(combinaciones) {
        console.log('‚ö†Ô∏è Usando implementaci√≥n fallback de mostrarCombinaciones');
        
        const container = document.getElementById('combinaciones-container');
        if (!container) return;
        
        const html = `
          <div class="bg-white bg-opacity-10 rounded-xl p-6 backdrop-blur-sm border border-white border-opacity-20">
            <h3 class="text-xl font-bold text-white mb-4 text-center">
              üé≤ ${combinaciones.length} Combinaci√≥n${combinaciones.length > 1 ? 'es' : ''} Aleatoria${combinaciones.length > 1 ? 's' : ''}
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              ${combinaciones.map((combo, index) => `
                <div class="bg-purple-500 bg-opacity-20 rounded-lg p-4 text-center border border-purple-300 border-opacity-30">
                  <h4 class="text-lg font-semibold text-white mb-2">Combinaci√≥n ${index + 1}</h4>
                  <div class="flex justify-center space-x-2 mb-3 flex-wrap">
                    ${combo.map(num => `
                      <span class="bg-white text-purple-600 font-bold py-1 px-2 rounded text-sm m-1">
                        ${num}
                      </span>
                    `).join('')}
                  </div>
                  <button onclick="copiarCombinacion('${combo.join(', ')}')" class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-full transition-all duration-300">
                    üìã Copiar
                  </button>
                </div>
              `).join('')}
            </div>
            <div class="text-center mt-6">
              <button id="btn-generar-nuevas" class="bg-gradient-to-r from-green-500 to-teal-500 text-white px-6 py-2 rounded-full font-semibold hover:from-green-600 hover:to-teal-600 transition-all duration-300 shadow-lg hover:shadow-xl">
                üîÑ Generar Nuevas Combinaciones
              </button>
            </div>
          </div>
        `;
        
        container.innerHTML = html;
        
        // Agregar evento al bot√≥n de generar nuevas
        const btnNuevas = document.getElementById('btn-generar-nuevas');
        if (btnNuevas) {
          btnNuevas.addEventListener('click', function() {
            const nuevasCombs = window.generarCombinacionesAleatorias(window.cantidadSeleccionada);
            window.mostrarCombinaciones(nuevasCombs);
          });
        }
      };
    }
    
    // Funci√≥n auxiliar para copiar al portapapeles
    window.copiarCombinacion = function(combinacion) {
      navigator.clipboard.writeText(combinacion)
        .then(() => alert('Combinaci√≥n copiada al portapapeles'))
        .catch(err => console.error('Error al copiar: ', err));
    };
  </script>
  <script>
    // Variables globales
    let isAleatoriaOpen = false;
    let isPrediccionOpen = false;
    let isAnalisisOpen = false;

    // Funciones toggle simples y directas
    function toggleAleatorias() {
      console.log('üé≤ Toggle aleatorias clicked');
      const contenido = document.getElementById('contenido-aleatorias');
      const arrow = document.getElementById('arrow-icon-aleatorias');
      
      if (!contenido || !arrow) {
        console.error('‚ùå Elementos aleatorias no encontrados');
        return;
      }
      
      if (contenido.classList.contains('hidden')) {
        // Cerrar otras cajas
        cerrarCajaPredicciones();
        cerrarCajaAnalisis();
        
        // Abrir esta caja con transici√≥n suave
        contenido.style.opacity = '0';
        contenido.classList.remove('hidden');
        arrow.style.transform = 'rotate(180deg)';
        
        // Animar la aparici√≥n
        requestAnimationFrame(() => {
          contenido.style.opacity = '1';
        });
        
        isAleatoriaOpen = true;
        console.log('‚úÖ Caja aleatorias abierta');
        
        // Verificar funcionalidad de generaci√≥n aleatoria
        console.log('üîç Verificando funci√≥n generarCombinacionesAleatorias:', {
          disponible: typeof generarCombinacionesAleatorias !== 'undefined',
          windowFn: typeof window.generarCombinacionesAleatorias !== 'undefined'
        });
      } else {
        // Cerrar esta caja con transici√≥n suave
        contenido.style.opacity = '0';
        setTimeout(() => {
          contenido.classList.add('hidden');
          arrow.style.transform = 'rotate(0deg)';
          limpiarCombinacionesAleatorias();
        }, 300);
        
        isAleatoriaOpen = false;
        console.log('‚úÖ Caja aleatorias cerrada');
      }
    }

    function togglePrediccionIA() {
      console.log('ü§ñ Toggle predicci√≥n IA clicked');
      const contenido = document.getElementById('contenido-predicciones');
      const arrow = document.getElementById('arrow-icon');
      const container = document.getElementById('prediccion-container');
      
      if (!contenido || !arrow || !container) {
        console.error('‚ùå Elementos predicci√≥n no encontrados');
        return;
      }
      
      if (contenido.classList.contains('hidden')) {
        // Cerrar otras cajas
        cerrarCajaAleatorias();
        cerrarCajaAnalisis();
        
        // Abrir esta caja con transici√≥n suave
        contenido.style.opacity = '0';
        contenido.classList.remove('hidden');
        arrow.style.transform = 'rotate(180deg)';
        container.style.opacity = '1';
        
        // Animar la aparici√≥n
        requestAnimationFrame(() => {
          contenido.style.opacity = '1';
        });
        
        isPrediccionOpen = true;
        console.log('‚úÖ Caja predicci√≥n abierta');
        
        // Actualizar t√≠tulo del sorteo inmediatamente
        actualizarTituloSorteo();
        
        // Generar predicciones si no se han generado
        try {
          // Verificamos si tenemos la funci√≥n de predicci√≥n por frecuencia disponible
          if (window.generarPrediccionPorFrecuencia) {
            console.log('‚úÖ Funci√≥n generarPrediccionPorFrecuencia disponible desde m√≥dulo global');
            
            // Si tenemos datos hist√≥ricos, podemos usarla para las predicciones
            if (window.datosHistoricos && window.currentUserId) {
              // Generar predicci√≥n por frecuencia
              const prediccion = window.generarPrediccionPorFrecuencia(window.currentUserId, window.datosHistoricos);
              console.log('üîÆ Predicci√≥n por frecuencia generada:', prediccion);
              
              // Almacenar la predicci√≥n para uso posterior
              window.prediccionIA = prediccion;
            }
          }
          
          // Verificamos directamente si la funci√≥n est√° disponible
          console.log('ÔøΩ Verificando disponibilidad de funciones:', {
            generarPrediccionesPorSorteo: typeof generarPrediccionesPorSorteo !== 'undefined',
            windowFn: typeof window.generarPrediccionesPorSorteo !== 'undefined'
          });
          
          const fnPredicciones = window.generarPrediccionesPorSorteo || generarPrediccionesPorSorteo;
          
          if (fnPredicciones) {
            console.log('üîÑ Iniciando generaci√≥n de predicciones IA...');
            fnPredicciones()
              .then(() => {
                window.prediccionesGeneradas = true;
                console.log('‚úÖ Predicciones IA generadas exitosamente');
              })
              .catch(error => {
                console.error('‚ùå Error generando predicciones IA:', error);
                const mensajeEstado = document.getElementById('mensaje-estado');
                if (mensajeEstado) {
                  mensajeEstado.textContent = 'Error al generar predicciones. Intente nuevamente.';
                }
              });
          } else {
            console.error('‚ùå funci√≥n generarPrediccionesPorSorteo no est√° disponible');
            const mensajeEstado = document.getElementById('mensaje-estado');
            if (mensajeEstado) {
              mensajeEstado.textContent = 'Sistema de predicciones no disponible. Intente recargar la p√°gina.';
            }
          }
        } catch (error) {
          console.error('‚ùå Error en sistema de predicci√≥n IA:', error);
        }
      } else {
        // Cerrar esta caja con transici√≥n suave
        contenido.style.opacity = '0';
        setTimeout(() => {
          contenido.classList.add('hidden');
          arrow.style.transform = 'rotate(0deg)';
          container.style.opacity = '0.5';
        }, 300);
        
        isPrediccionOpen = false;
        console.log('‚úÖ Caja predicci√≥n cerrada');
      }
    }

    function toggleAnalisis() {
      console.log('üìä Toggle an√°lisis clicked');
      const contenido = document.getElementById('contenido-analisis');
      const arrow = document.getElementById('arrow-icon-analisis');
      
      if (!contenido || !arrow) {
        console.error('‚ùå Elementos an√°lisis no encontrados');
        return;
      }
      
      if (contenido.classList.contains('hidden')) {
        // Cerrar otras cajas
        cerrarCajaAleatorias();
        cerrarCajaPredicciones();
        
        // Abrir esta caja con transici√≥n suave
        contenido.style.opacity = '0';
        contenido.classList.remove('hidden');
        arrow.style.transform = 'rotate(180deg)';
        
        // Animar la aparici√≥n
        requestAnimationFrame(() => {
          contenido.style.opacity = '1';
        });
        
        isAnalisisOpen = true;
        console.log('‚úÖ Caja an√°lisis abierta');
        
        // Siempre intentar cargar los datos hist√≥ricos si no est√°n disponibles
        const cargarYAnalizarDatos = async () => {
          try {
            console.log('üîÑ Verificando y cargando datos hist√≥ricos...');
            
            // Si los datos no est√°n cargados, intentamos cargarlos
            if (!window.datosHistoricos) {
              if (typeof window.cargarDatosHistoricos === 'function') {
                console.log('ÔøΩ Cargando datos hist√≥ricos...');
                try {
                  window.datosHistoricos = await window.cargarDatosHistoricos('todos');
                  console.log('‚úÖ Datos hist√≥ricos cargados correctamente');
                } catch (err) {
                  console.error('‚ùå Error cargando datos hist√≥ricos:', err);
                }
              } else {
                console.error('‚ùå Funci√≥n cargarDatosHistoricos no disponible');
              }
            }
            
            // Verificar funciones de an√°lisis
            console.log('üîç Verificando funciones de an√°lisis:', {
              suma: typeof window.analizarSumaNumeros === 'function',
              pares: typeof window.analizarParesImpares === 'function',
              decada: typeof window.analizarDecadaPorPosicion === 'function'
            });
            
            // Realizar an√°lisis con las funciones disponibles
            if (window.analizarSumaNumeros && window.analizarParesImpares && window.analizarDecadaPorPosicion) {
              console.log('‚úÖ Usando funciones de an√°lisis del m√≥dulo global');
              
              // Si tenemos datos hist√≥ricos, realizamos los an√°lisis
              if (window.datosHistoricos) {
                // Mostrar mensaje de actualizaci√≥n
                ['melate', 'revancha', 'revanchita'].forEach(sorteo => {
                  const elem = document.getElementById(`proyeccion-${sorteo}`);
                  const detalle = document.getElementById(`detalle-${sorteo}`);
                  if (elem) elem.textContent = 'üîÑ Actualizando...';
                  if (detalle) detalle.textContent = 'Generando proyecciones...';
                });
                
                // Realizar los an√°lisis usando las funciones del m√≥dulo
                const sumAnalisis = window.analizarSumaNumeros(window.datosHistoricos);
                const paresAnalisis = window.analizarParesImpares(window.datosHistoricos);
                const decadaAnalisis = window.analizarDecadaPorPosicion(window.datosHistoricos);
                
                // Agregar los an√°lisis a los datos
                window.datosHistoricos.sumAnalisis = sumAnalisis;
                window.datosHistoricos.paresAnalisis = paresAnalisis;
                window.datosHistoricos.decadaAnalisis = decadaAnalisis;
                
                // Generar proyecciones
                const fnProyecciones = window.generarProyeccionesAnalisis || generarProyeccionesAnalisis;
                
                if (fnProyecciones) {
                  console.log('üîÑ Generando proyecciones de an√°lisis...');
                  await fnProyecciones().catch(error => {
                    console.error('‚ùå Error en proyecciones de an√°lisis:', error);
                    // Actualizar interfaz con error
                    ['melate', 'revancha', 'revanchita'].forEach(sorteo => {
                      const elem = document.getElementById(`proyeccion-${sorteo}`);
                      const detalle = document.getElementById(`detalle-${sorteo}`);
                      if (elem) elem.textContent = 'Error al generar';
                      if (detalle) detalle.textContent = 'Intente nuevamente';
                    });
                  });
                } else {
                  console.error('‚ùå funci√≥n generarProyeccionesAnalisis no est√° disponible');
                  // Actualizar interfaz con error
                  ['melate', 'revancha', 'revanchita'].forEach(sorteo => {
                    const elem = document.getElementById(`proyeccion-${sorteo}`);
                    const detalle = document.getElementById(`detalle-${sorteo}`);
                    if (elem) elem.textContent = 'Sistema no disponible';
                    if (detalle) detalle.textContent = 'Recargue la p√°gina';
                  });
                }
              } else {
                console.error('‚ùå No hay datos hist√≥ricos disponibles');
                // Mostrar mensaje de error
                ['melate', 'revancha', 'revanchita'].forEach(sorteo => {
                  const elem = document.getElementById(`proyeccion-${sorteo}`);
                  const detalle = document.getElementById(`detalle-${sorteo}`);
                  if (elem) elem.textContent = 'Sin datos disponibles';
                  if (detalle) detalle.textContent = 'Error al cargar los datos';
                });
              }
            } else {
              console.error('‚ùå Faltan funciones de an√°lisis');
              // Mostrar mensaje de error
              ['melate', 'revancha', 'revanchita'].forEach(sorteo => {
                const elem = document.getElementById(`proyeccion-${sorteo}`);
                const detalle = document.getElementById(`detalle-${sorteo}`);
                if (elem) elem.textContent = 'Sistema no disponible';
                if (detalle) detalle.textContent = 'Error en m√≥dulos de an√°lisis';
              });
            }
          } catch (error) {
            console.error('‚ùå Error general al generar proyecciones:', error);
            // Mostrar mensaje de error general
            ['melate', 'revancha', 'revanchita'].forEach(sorteo => {
              const elem = document.getElementById(`proyeccion-${sorteo}`);
              const detalle = document.getElementById(`detalle-${sorteo}`);
              if (elem) elem.textContent = 'Error inesperado';
              if (detalle) detalle.textContent = 'Intente nuevamente m√°s tarde';
            });
          }
        };
        
        // Ejecutar el proceso de an√°lisis inmediatamente
        cargarYAnalizarDatos();
        
      } else {
        // Cerrar esta caja con transici√≥n suave
        contenido.style.opacity = '0';
        setTimeout(() => {
          contenido.classList.add('hidden');
          arrow.style.transform = 'rotate(0deg)';
        }, 300);
        
        isAnalisisOpen = false;
        console.log('‚úÖ Caja an√°lisis cerrada');
      }
    }

    // Funciones auxiliares para cerrar cajas
    function cerrarCajaAleatorias() {
      const contenido = document.getElementById('contenido-aleatorias');
      const arrow = document.getElementById('arrow-icon-aleatorias');
      
      if (contenido && !contenido.classList.contains('hidden')) {
        contenido.style.opacity = '0';
        setTimeout(() => {
          contenido.classList.add('hidden');
          if (arrow) arrow.style.transform = 'rotate(0deg)';
          limpiarCombinacionesAleatorias();
        }, 300);
        isAleatoriaOpen = false;
      }
    }

    function cerrarCajaPredicciones() {
      const contenido = document.getElementById('contenido-predicciones');
      const arrow = document.getElementById('arrow-icon');
      const container = document.getElementById('prediccion-container');
      
      if (contenido && !contenido.classList.contains('hidden')) {
        contenido.style.opacity = '0';
        setTimeout(() => {
          contenido.classList.add('hidden');
          if (arrow) arrow.style.transform = 'rotate(0deg)';
          if (container) container.style.opacity = '0.5';
        }, 300);
        isPrediccionOpen = false;
      }
    }

    function cerrarCajaAnalisis() {
      const contenido = document.getElementById('contenido-analisis');
      const arrow = document.getElementById('arrow-icon-analisis');
      
      if (contenido && !contenido.classList.contains('hidden')) {
        contenido.style.opacity = '0';
        setTimeout(() => {
          contenido.classList.add('hidden');
          if (arrow) arrow.style.transform = 'rotate(0deg)';
        }, 300);
        isAnalisisOpen = false;
      }
    }

    function limpiarCombinacionesAleatorias() {
      const container = document.getElementById('combinaciones-container');
      if (container) {
        container.innerHTML = '';
        console.log('üßπ Combinaciones aleatorias limpiadas');
      }
    }

    // Hacer funciones disponibles globalmente
    window.toggleAleatorias = toggleAleatorias;
    window.togglePrediccionIA = togglePrediccionIA;
    window.toggleAnalisis = toggleAnalisis;
  </script>
  <!-- Script unificado de inicializaci√≥n del sistema -->
  <script type="module" src="js/inicializacion-unificada.js"></script>

  <script>
    // Variables globales para compartir entre scripts
    window.cantidadSeleccionada = 1;
    window.datosHistoricos = null;
    window.prediccionesGeneradas = false;
    window.usuarioActualID = null;
    window.prediccionesAlmacenadas = {
      melate: null,
      revancha: null,
      revanchita: null
    };
    window.proyeccionesAlmacenadas = {
      melate: null,
      revancha: null,
      revanchita: null
    };

    // Funci√≥n para obtener el n√∫mero de sorteo actual basado en el √∫ltimo sorteo de Melate
    function obtenerNumeroSorteoActual() {
      console.log('üîç Obteniendo n√∫mero de sorteo actual...');
      
      // Primero intentamos obtener el √∫ltimo sorteo desde los datos hist√≥ricos del Melate
      if (window.datosHistoricos && window.datosHistoricos.melate && window.datosHistoricos.melate.sorteos) {
        try {
          // Ordenar los sorteos por n√∫mero de concurso (descendente) para obtener el √∫ltimo
          const sorteos = window.datosHistoricos.melate.sorteos;
          
          if (sorteos.length > 0) {
            // Buscar el sorteo con el n√∫mero m√°s alto
            let ultimoSorteoNum = 0;
            
            for (const sorteo of sorteos) {
              // Convertir el n√∫mero de concurso a entero y tomar el m√°ximo
              const numConcurso = parseInt(sorteo.concurso);
              if (!isNaN(numConcurso) && numConcurso > ultimoSorteoNum) {
                ultimoSorteoNum = numConcurso;
              }
            }
            
            if (ultimoSorteoNum > 0) {
              const proximoSorteo = ultimoSorteoNum + 1;
              console.log(`‚úÖ Pr√≥ximo sorteo calculado: ${proximoSorteo} (√∫ltimo: ${ultimoSorteoNum})`);
              return proximoSorteo;
            }
          }
          
          console.warn('‚ö†Ô∏è No se encontraron sorteos v√°lidos en los datos');
        } catch (error) {
          console.error('‚ùå Error al procesar los sorteos:', error);
        }
      } else {
        // Mostrar qu√© datos tenemos disponibles para debug
        console.warn('‚ö†Ô∏è Datos hist√≥ricos incompletos:', {
          datosHistoricos: !!window.datosHistoricos,
          melate: window.datosHistoricos ? !!window.datosHistoricos.melate : false,
          tieneSorteos: window.datosHistoricos && window.datosHistoricos.melate ? 
                        !!window.datosHistoricos.melate.sorteos : false,
          numSorteos: window.datosHistoricos && window.datosHistoricos.melate && window.datosHistoricos.melate.sorteos ? 
                      window.datosHistoricos.melate.sorteos.length : 0
        });
      }
      
      // Fallback mejorado si no hay datos disponibles
      console.log('‚ö†Ô∏è Usando fallback din√°mico para n√∫mero de sorteo...');
      
      // Calcular un fallback basado en la fecha actual
      // Usar los mismos valores de referencia que en dataParserGlobal.js
      const fecha = new Date();
      const fechaReferencia = new Date(2025, 6, 18); // 18 de julio de 2025
      const sorteoReferencia = 4082; // √öltimo sorteo conocido en el CSV
      
      // Calcular diferencia en d√≠as
      const diferenciaMilisegundos = fecha - fechaReferencia;
      const diferenciaDias = Math.floor(diferenciaMilisegundos / (1000 * 60 * 60 * 24));
      
      // Estimar sorteos adicionales (2 por semana = 1 cada 3.5 d√≠as en promedio)
      const sorteosAdicionales = Math.floor(diferenciaDias / 3.5);
      
      // Calcular el n√∫mero de sorteo estimado (pr√≥ximo sorteo)
      const proximoSorteoEstimado = sorteoReferencia + Math.max(1, sorteosAdicionales);
      console.log(`üìä Fallback din√°mico: pr√≥ximo sorteo estimado ${proximoSorteoEstimado} (${sorteosAdicionales} sorteos desde la referencia)`);
      
      // Si el valor calculado es demasiado bajo por alguna raz√≥n, usar el m√≠nimo esperado
      if (proximoSorteoEstimado < 4083) {
        console.log(`‚ö†Ô∏è Corrigiendo valor estimado demasiado bajo: usando 4083 como m√≠nimo`);
        return 4083;
      }
      
      return proximoSorteoEstimado;
    }

    // Funci√≥n para actualizar el t√≠tulo con el n√∫mero de sorteo
    function actualizarTituloSorteo() {
      // Llamar a la implementaci√≥n del archivo dedicado
      if (typeof window.actualizarTituloSorteoOptimizado === 'function') {
        window.actualizarTituloSorteoOptimizado();
      } else {
        console.log('‚ö†Ô∏è Usando implementaci√≥n de fallback para t√≠tulo');
        // Fallback simple
        const tituloElement = document.getElementById('titulo-sorteo');
        if (tituloElement && !tituloElement.textContent.includes('sorteo')) {
          const estimado = 4083 + Math.floor((new Date() - new Date(2025, 6, 18)) / (1000 * 60 * 60 * 24 * 3.5));
          tituloElement.textContent = `üéØ Combinaciones sugeridas por IA para TI para el sorteo ${estimado}`;
        }
      }
    }

    // Hacer funci√≥n global
    window.actualizarTituloSorteo = actualizarTituloSorteo;



    // Funci√≥n para inicializar el bot√≥n de volver con retry
    function inicializarBotonVolver() {
      const btnBack = document.getElementById('btn-back');
      if (!btnBack) {
        console.log('‚è≥ Bot√≥n btn-back no encontrado, reintentando...');
        setTimeout(inicializarBotonVolver, 500);
        return;
      }

      // Remover event listeners anteriores
      btnBack.replaceWith(btnBack.cloneNode(true));
      const nuevoBtn = document.getElementById('btn-back');
      
      nuevoBtn.addEventListener('click', () => {
        console.log('üîô Click en bot√≥n volver - Navegando a home.html...');
        window.location.href = 'home.html';
      });
      
      console.log('‚úÖ Event listener configurado para bot√≥n btn-back');
    }

    // Inicializar bot√≥n de volver
    setTimeout(inicializarBotonVolver, 1000);

    // Funci√≥n para inicializar el bot√≥n de combinaciones aleatorias con retry
    function inicializarBotonAleatorias() {
      const btnGenerar = document.getElementById('btn-generar');
      if (!btnGenerar) {
        console.log('‚è≥ Bot√≥n btn-generar no encontrado, reintentando...');
        setTimeout(inicializarBotonAleatorias, 500);
        return;
      }

      // Remover event listeners anteriores
      btnGenerar.replaceWith(btnGenerar.cloneNode(true));
      const nuevoBtn = document.getElementById('btn-generar');
      
      nuevoBtn.addEventListener('click', () => {
        console.log('üé≤ Click en bot√≥n - Generando combinaci√≥n aleatoria...');
        
        if (typeof window.mostrarCombinacionAleatoria === 'function') {
          console.log('‚úÖ Funci√≥n mostrarCombinacionAleatoria encontrada, ejecutando...');
          window.mostrarCombinacionAleatoria();
        } else {
          console.log('‚ö†Ô∏è Funci√≥n mostrarCombinacionAleatoria no disponible, usando fallback...');
          // Fallback si la funci√≥n no est√° disponible
          const container = document.getElementById('combinaciones-container');
          if (container) {
            container.innerHTML = `
              <div class="text-center py-8">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto mb-4"></div>
                <p class="text-white">Generando combinaci√≥n...</p>
              </div>
            `;
            
            setTimeout(() => {
              const numeros = [];
              while (numeros.length < 6) {
                const num = Math.floor(Math.random() * 56) + 1;
                if (!numeros.includes(num)) numeros.push(num);
              }
              numeros.sort((a, b) => a - b);
              
              container.innerHTML = `
                <div class="bg-white bg-opacity-10 rounded-xl p-6 backdrop-blur-sm border border-white border-opacity-20">
                  <h3 class="text-xl font-bold text-white mb-4 text-center">üé≤ Tu Combinaci√≥n Aleatoria</h3>
                  <div class="flex justify-center">
                    <div class="bg-purple-500 bg-opacity-20 rounded-lg p-6 text-center border border-purple-300 border-opacity-30">
                      <div class="flex justify-center space-x-3 mb-4">
                        ${numeros.map(num => `<span class="bg-white text-purple-600 font-bold py-2 px-3 rounded-lg text-lg shadow-lg">${num}</span>`).join('')}
                      </div>
                    </div>
                  </div>
                </div>
              `;
              console.log(`‚úÖ Combinaci√≥n fallback generada: ${numeros.join(' - ')}`);
            }, 800);
          }
        }
      });
      
      console.log('‚úÖ Event listener configurado para bot√≥n btn-generar');
    }

    // Inicializar despu√©s de que todos los scripts se hayan cargado
    setTimeout(inicializarBotonAleatorias, 2000);

    // El bot√≥n de generar nueva proyecci√≥n ha sido eliminado
    // La generaci√≥n de proyecciones ahora ocurre autom√°ticamente al abrir la caja de an√°lisis

    // Funci√≥n para mostrar combinaciones
    function mostrarCombinaciones(combinaciones) {
      const container = document.getElementById('combinaciones-container');
      
      const html = `
        <div class="bg-white bg-opacity-10 rounded-xl p-6 backdrop-blur-sm border border-white border-opacity-20">
          <h3 class="text-xl font-bold text-white mb-4 text-center">
            üé≤ ${combinaciones.length} Combinaci√≥n${combinaciones.length > 1 ? 'es' : ''} Aleatoria${combinaciones.length > 1 ? 's' : ''}
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            ${combinaciones.map((combo, index) => `
              <div class="bg-purple-500 bg-opacity-20 rounded-lg p-4 text-center border border-purple-300 border-opacity-30">
                <h4 class="text-lg font-semibold text-white mb-2">Combinaci√≥n ${index + 1}</h4>
                <div class="flex justify-center space-x-2 mb-3">
                  ${combo.map(num => `
                    <span class="bg-white text-purple-600 font-bold py-1 px-2 rounded text-sm">
                      ${num}
                    </span>
                  `).join('')}
                </div>
                <button onclick="copiarCombinacion('${combo.join(', ')}')" class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-full transition-all duration-300">
                  üìã Copiar
                </button>
              </div>
            `).join('')}
          </div>
          <div class="text-center mt-6">
            <button id="btn-generar-nuevas" class="bg-gradient-to-r from-green-500 to-teal-500 text-white px-6 py-2 rounded-full font-semibold hover:from-green-600 hover:to-teal-600 transition-all duration-300 shadow-lg hover:shadow-xl">
              üîÑ Generar Nuevas Combinaciones
            </button>
          </div>
        </div>
      `;
      
      container.innerHTML = html;
      
      // Agregar evento al bot√≥n de generar nuevas
      document.getElementById('btn-generar-nuevas').addEventListener('click', () => {
        generarYMostrarCombinaciones();
      });
    }

    // Funci√≥n principal para generar y mostrar combinaciones
    function generarYMostrarCombinaciones() {
      console.log(`üé≤ Generando ${cantidadSeleccionada} combinaciones aleatorias...`);
      
      const container = document.getElementById('combinaciones-container');
      container.innerHTML = `
        <div class="text-center py-8">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto mb-4"></div>
          <p class="text-white">Generando combinaciones...</p>
        </div>
      `;
      
      try {
        const combinaciones = generarCombinacionesAleatorias(cantidadSeleccionada);
        mostrarCombinaciones(combinaciones);
      } catch (error) {
        console.error('‚ùå Error generando combinaciones:', error);
        container.innerHTML = `
          <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
            <strong>Error:</strong> No se pudieron generar las combinaciones. ${error.message}
          </div>
        `;
      }
    }

    // === FUNCIONES PARA PROYECCIONES BASADAS EN AN√ÅLISIS ===
    
    // Funci√≥n principal para generar proyecciones basadas en an√°lisis
    async function generarProyeccionesAnalisis() {
      console.log('üìä Generando proyecciones basadas en an√°lisis estad√≠stico...');
      
      try {
        // Asegurar que tenemos datos hist√≥ricos
        if (!window.datosHistoricos) {
          console.log('üîÑ Cargando datos hist√≥ricos para an√°lisis...');
          window.datosHistoricos = await window.cargarDatosHistoricos('todos');
          datosHistoricos = window.datosHistoricos;
        }
        
        // Intentar cargar proyecciones almacenadas y verificar si son v√°lidas
        const proyeccionesValidas = cargarProyeccionesAlmacenadas();
        
        // Si no hay proyecciones v√°lidas (datos cambiaron), generar nuevas
        if (!proyeccionesValidas) {
          console.log('üîÑ Generando nuevas proyecciones de an√°lisis debido a cambios en los datos hist√≥ricos');
        }
        
        const sorteos = ['melate', 'revancha', 'revanchita'];
        
        for (const sorteo of sorteos) {
          try {
            // Si ya tenemos una proyecci√≥n v√°lida para este sorteo, usarla
            if (proyeccionesValidas && window.proyeccionesAlmacenadas[sorteo] && window.proyeccionesAlmacenadas[sorteo].numeros) {
              const elementoProyeccion = document.getElementById(`proyeccion-${sorteo}`);
              const elementoDetalle = document.getElementById(`detalle-${sorteo}`);
              
              if (elementoProyeccion) {
                elementoProyeccion.textContent = window.proyeccionesAlmacenadas[sorteo].numeros.join(' - ');
              }
              if (elementoDetalle) {
                elementoDetalle.textContent = window.proyeccionesAlmacenadas[sorteo].detalle;
              }
              
              console.log(`‚úÖ Usando proyecci√≥n de an√°lisis almacenada para ${sorteo}:`, window.proyeccionesAlmacenadas[sorteo].numeros);
              continue; // Saltar a siguiente sorteo
            }
            
            if (!window.datosHistoricos[sorteo] || !window.datosHistoricos[sorteo].numeros) {
              console.warn(`‚ö†Ô∏è No hay datos disponibles para ${sorteo}`);
              const elementoProyeccion = document.getElementById(`proyeccion-${sorteo}`);
              const elementoDetalle = document.getElementById(`detalle-${sorteo}`);
              if (elementoProyeccion) elementoProyeccion.textContent = 'Sin datos disponibles';
              if (elementoDetalle) elementoDetalle.textContent = 'Requiere datos hist√≥ricos';
              continue;
            }
            
            // Mostrar loading
            const elementoProyeccion = document.getElementById(`proyeccion-${sorteo}`);
            const elementoDetalle = document.getElementById(`detalle-${sorteo}`);
            if (elementoProyeccion) elementoProyeccion.textContent = 'üîÑ Analizando...';
            if (elementoDetalle) elementoDetalle.textContent = 'Procesando 4 tipos de an√°lisis...';
            
            // Generar proyecci√≥n usando los 4 an√°lisis especificados
            const proyeccion = await generarProyeccionPorAnalisis(window.datosHistoricos[sorteo], sorteo);
            
            if (elementoProyeccion && proyeccion.numeros) {
              elementoProyeccion.textContent = proyeccion.numeros.join(' - ');
            }
            
            if (elementoDetalle && proyeccion.detalle) {
              elementoDetalle.textContent = proyeccion.detalle;
            }
            
            // Almacenar la proyecci√≥n para uso futuro
            window.proyeccionesAlmacenadas[sorteo] = {
              numeros: proyeccion.numeros,
              detalle: proyeccion.detalle,
              timestamp: new Date().getTime()
            };
            proyeccionesAlmacenadas[sorteo] = window.proyeccionesAlmacenadas[sorteo];
            
            console.log(`‚úÖ Proyecci√≥n para ${sorteo}:`, proyeccion.numeros);
            console.log(`üìù Detalle ${sorteo}:`, proyeccion.detalle);

          } catch (error) {
            console.error(`‚ùå Error generando proyecci√≥n para ${sorteo}:`, error);
            const elementoProyeccion = document.getElementById(`proyeccion-${sorteo}`);
            const elementoDetalle = document.getElementById(`detalle-${sorteo}`);
            if (elementoProyeccion) elementoProyeccion.textContent = 'Error al generar';
            if (elementoDetalle) elementoDetalle.textContent = 'Error en el an√°lisis';
          }
        }
        
        // Guardar todas las proyecciones en localStorage
        guardarProyeccionesAlmacenadas();
        
        console.log('‚úÖ Todas las proyecciones de an√°lisis completadas');
        
      } catch (error) {
        console.error('‚ùå Error en el sistema de proyecci√≥n:', error);
        // Mostrar error en todas las cajas
        const sorteos = ['melate', 'revancha', 'revanchita'];
        sorteos.forEach(sorteo => {
          const elementoProyeccion = document.getElementById(`proyeccion-${sorteo}`);
          if (elementoProyeccion) elementoProyeccion.textContent = 'Sistema no disponible';
        });
      }
    }
    
    // Funci√≥n para generar una proyecci√≥n espec√≠fica por sorteo
    async function generarProyeccionPorAnalisis(datosSorteo, sorteo) {
      console.log(`üîç Generando proyecci√≥n para ${sorteo}...`);
      
      // An√°lisis 1: Frecuencias hist√≥ricas (22%)
      const frecuencias = calcularFrecuencias(datosSorteo.numeros);
      const numerosPorFrecuencia = seleccionarPorFrecuencia(frecuencias);
      
      // An√°lisis 2: Suma de n√∫meros (22%)
      const analisisSuma = analizarSumaNumeros({[sorteo]: datosSorteo});
      const numerosPorSuma = seleccionarPorSuma(analisisSuma[sorteo]);
      
      // An√°lisis 3: Balance pares/impares (22%)
      const analisisPares = analizarParesImpares({[sorteo]: datosSorteo});
      const numerosPorBalance = seleccionarPorBalance(analisisPares[sorteo]);
      
      // An√°lisis 4: Distribuci√≥n por d√©cadas (22%)
      const analisisDecadas = analizarDecadaTerminacion({[sorteo]: datosSorteo});
      const numerosPorDecadas = seleccionarPorDecadas(analisisDecadas[sorteo]);
      
      // Factor aleatorio (12%)
      const numerosAleatorios = generarNumerosAleatorios();
      
      // Combinar todos los an√°lisis con sus pesos
      const combinacionFinal = combinarAnalisis({
        frecuencias: numerosPorFrecuencia,
        suma: numerosPorSuma,
        balance: numerosPorBalance,
        decadas: numerosPorDecadas,
        aleatorios: numerosAleatorios
      });
      
      const detalle = `F:${numerosPorFrecuencia.slice(0,2).join(',')} S:${numerosPorSuma.slice(0,2).join(',')} B:${numerosPorBalance.slice(0,2).join(',')} D:${numerosPorDecadas.slice(0,2).join(',')}`;
      
      return {
        numeros: combinacionFinal,
        detalle: detalle
      };
    }
    
    // Seleccionar n√∫meros por frecuencia (m√°s frecuentes tienen mayor probabilidad)
    function seleccionarPorFrecuencia(frecuencias) {
      const ordenados = Object.entries(frecuencias)
        .sort(([,a], [,b]) => b - a)
        .map(([num]) => parseInt(num));
      
      // Seleccionar los 20 m√°s frecuentes con algo de variaci√≥n
      const candidatos = ordenados.slice(0, 20);
      return mezclarArray(candidatos).slice(0, 8);
    }
    
    // Seleccionar n√∫meros por suma (buscar n√∫meros que sumen en el rango √≥ptimo)
    function seleccionarPorSuma(analisisSuma) {
      const rangoOptimo = analisisSuma.rangoMasFrecuente[0]; // '150-199', etc.
      const [min, max] = rangoOptimo.split('-').map(n => parseInt(n) || 300);
      
      // Generar n√∫meros que tiendan a sumar en ese rango
      const numeros = [];
      const targetSum = (min + max) / 2; // Suma objetivo
      const avgPerNumber = targetSum / 6; // Promedio por n√∫mero
      
      for (let i = 0; i < 8; i++) {
        const variation = (Math.random() - 0.5) * 20; // Variaci√≥n de ¬±10
        const numero = Math.max(1, Math.min(56, Math.round(avgPerNumber + variation)));
        numeros.push(numero);
      }
      
      return [...new Set(numeros)].slice(0, 8); // Eliminar duplicados
    }
    
    // Seleccionar n√∫meros por balance pares/impares
    function seleccionarPorBalance(analisisPares) {
      const distribucionOptima = analisisPares.distribucionMasFrecuente[0]; // '3p-3i', etc.
      const [pares] = distribucionOptima.split('-').map(s => parseInt(s.replace('p', '')));
      
      const numerosPares = [];
      const numerosImpares = [];
      
      // Generar pares e impares seg√∫n la distribuci√≥n √≥ptima
      for (let i = 2; i <= 56; i += 2) {
        if (numerosPares.length < 4) numerosPares.push(i);
      }
      
      for (let i = 1; i <= 56; i += 2) {
        if (numerosImpares.length < 4) numerosImpares.push(i);
      }
      
      const seleccionados = [];
      seleccionados.push(...mezclarArray(numerosPares).slice(0, Math.min(pares, 4)));
      seleccionados.push(...mezclarArray(numerosImpares).slice(0, Math.min(6-pares, 4)));
      
      return mezclarArray(seleccionados).slice(0, 8);
    }
    
    // Seleccionar n√∫meros por d√©cadas
    function seleccionarPorDecadas(analisisDecadas) {
      const decadaOptima = analisisDecadas.decadaMasFrecuente[0]; // '21-30', etc.
      const [min, max] = decadaOptima.split('-').map(n => parseInt(n));
      
      const numerosDeLaDecada = [];
      for (let i = min; i <= max; i++) {
        numerosDeLaDecada.push(i);
      }
      
      // Seleccionar algunos de la d√©cada √≥ptima y algunos aleatorios
      const seleccionados = [];
      seleccionados.push(...mezclarArray(numerosDeLaDecada).slice(0, 4));
      
      // Agregar algunos n√∫meros de otras d√©cadas
      const otrosNumeros = [];
      for (let i = 1; i <= 56; i++) {
        if (i < min || i > max) otrosNumeros.push(i);
      }
      seleccionados.push(...mezclarArray(otrosNumeros).slice(0, 4));
      
      return mezclarArray(seleccionados).slice(0, 8);
    }
    
    // Generar n√∫meros completamente aleatorios
    function generarNumerosAleatorios() {
      const numeros = [];
      while (numeros.length < 8) {
        const num = Math.floor(Math.random() * 56) + 1;
        if (!numeros.includes(num)) {
          numeros.push(num);
        }
      }
      return numeros;
    }
    
    // Combinar todos los an√°lisis seg√∫n los pesos especificados
    function combinarAnalisis(analisis) {
      const pool = [];
      
      // Agregar n√∫meros seg√∫n los pesos (22%, 22%, 22%, 22%, 12%)
      // Para 6 n√∫meros finales, esto se traduce aproximadamente a:
      analisis.frecuencias.forEach(num => pool.push(num, num)); // 2 veces (peso alto)
      analisis.suma.forEach(num => pool.push(num, num)); // 2 veces
      analisis.balance.forEach(num => pool.push(num, num)); // 2 veces  
      analisis.decadas.forEach(num => pool.push(num, num)); // 2 veces
      analisis.aleatorios.forEach(num => pool.push(num)); // 1 vez (peso bajo)
      
      // Seleccionar 6 n√∫meros √∫nicos del pool
      const numerosUnicos = [...new Set(pool)];
      const combinacionFinal = mezclarArray(numerosUnicos).slice(0, 6).sort((a, b) => a - b);
      
      // Si no tenemos 6 n√∫meros, completar con aleatorios
      while (combinacionFinal.length < 6) {
        const num = Math.floor(Math.random() * 56) + 1;
        if (!combinacionFinal.includes(num)) {
          combinacionFinal.push(num);
        }
      }
      
      return combinacionFinal.sort((a, b) => a - b);
    }
    
    // Funci√≥n auxiliar para mezclar array
    function mezclarArray(array) {
      const arr = [...array];
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // Funci√≥n para generar un conjunto de n√∫meros aleatorios como fallback
    function generarCombinacionFallback() {
      const numeros = new Set();
      while (numeros.size < 6) {
        numeros.add(Math.floor(Math.random() * 56) + 1);
      }
      return Array.from(numeros).sort((a, b) => a - b);
    }
    
    // Funci√≥n para generar predicciones por sorteo con an√°lisis avanzado de IA
    async function generarPrediccionesPorSorteo() {
      console.log('ü§ñ Generando predicciones avanzadas con IA...');
      
      const mensajeEstado = document.getElementById('mensaje-estado');
      if (mensajeEstado) {
        mensajeEstado.textContent = 'Generando predicciones con m√©todos avanzados de an√°lisis...';
      }
      
      // Establecer un timeout para garantizar que siempre tengamos una respuesta
      const timeoutPromise = new Promise(resolve => {
        setTimeout(() => {
          resolve('timeout');
        }, 10000); // 10 segundos de timeout
      });
      
      try {
        // Cargar datos hist√≥ricos si no est√°n cargados
        if (!window.datosHistoricos) {
          window.datosHistoricos = await Promise.race([window.cargarDatosHistoricos('todos'), timeoutPromise]);
          datosHistoricos = window.datosHistoricos;
          if (window.datosHistoricos === 'timeout') {
            throw new Error('Tiempo de espera agotado al cargar datos hist√≥ricos');
          }
        }
        
        // Generar predicciones para cada sorteo usando el ID real del usuario
        const sorteos = ['melate', 'revancha', 'revanchita'];
        // Usar el ID real del usuario autenticado para predicciones personalizadas
        const userId = window.usuarioActualID || 'usuario-no-autenticado';
        
        // Intentar cargar predicciones almacenadas y verificar si son v√°lidas
        const prediccionesValidas = cargarPrediccionesAlmacenadas(userId);
        
        // Si no hay predicciones v√°lidas (datos cambiaron), generar nuevas
        if (!prediccionesValidas) {
          console.log('üîÑ Generando nuevas predicciones debido a cambios en los datos hist√≥ricos');
        }
        
        for (const sorteo of sorteos) {
          try {
            // Si ya tenemos una predicci√≥n v√°lida para este sorteo, usarla
            if (prediccionesValidas && window.prediccionesAlmacenadas[sorteo] && window.prediccionesAlmacenadas[sorteo].prediccion) {
              const elementoCombo = document.getElementById(`combinacion-${sorteo}`);
              if (elementoCombo) {
                elementoCombo.textContent = window.prediccionesAlmacenadas[sorteo].prediccion.join(' - ');
                console.log(`‚úÖ Usando predicci√≥n almacenada para ${sorteo}:`, window.prediccionesAlmacenadas[sorteo].prediccion);
              }
              continue; // Saltar a siguiente sorteo
            }
            
            // Verificar que existan datos para este sorteo
            if (!window.datosHistoricos[sorteo] || !window.datosHistoricos[sorteo].numeros || window.datosHistoricos[sorteo].numeros.length === 0) {
              console.warn(`‚ö†Ô∏è No hay datos hist√≥ricos disponibles para ${sorteo}`);
              const elementoCombo = document.getElementById(`combinacion-${sorteo}`);
              if (elementoCombo) {
                elementoCombo.textContent = 'Datos insuficientes';
              }
              continue;
            }
            
            // Verificar si tenemos una predicci√≥n almacenada para este usuario y sorteo
            const elementoCombo = document.getElementById(`combinacion-${sorteo}`);
            
            // Si ya tenemos una predicci√≥n almacenada y v√°lida para este sorteo, usarla
            if (window.prediccionesAlmacenadas[sorteo] && 
                window.prediccionesAlmacenadas[sorteo].userId === userId && 
                window.prediccionesAlmacenadas[sorteo].ultimoSorteo === window.datosHistoricos[sorteo].ultimoSorteo) {
                
              console.log(`üîÑ Usando predicci√≥n almacenada para ${sorteo}`);
              
              if (elementoCombo && window.prediccionesAlmacenadas[sorteo].prediccion) {
                elementoCombo.textContent = window.prediccionesAlmacenadas[sorteo].prediccion.join(' - ');
                console.log(`‚úÖ Predicci√≥n almacenada para ${sorteo} cargada:`, window.prediccionesAlmacenadas[sorteo].prediccion);
              }
              continue;
            }
            
            // Si llegamos aqu√≠, necesitamos generar una nueva predicci√≥n
            
            // Crear objeto de datos espec√≠fico para este sorteo con metadatos adicionales
            const datosSorteo = {
              numeros: window.datosHistoricos[sorteo].numeros,
              datos: window.datosHistoricos[sorteo].sorteos,
              sorteo: sorteo, // Identificador clave para diferenciar cada juego
              ultimoSorteo: window.datosHistoricos[sorteo].ultimoSorteo,
              fechaGeneracion: new Date().toISOString()
            };
            
            // Log para depuraci√≥n
            console.log(`üîç Preparando predicci√≥n con IA para ${sorteo}:`, {
              tipoSorteo: sorteo,
              cantidadNumeros: window.datosHistoricos[sorteo].numeros.length,
              cantidadSorteos: window.datosHistoricos[sorteo].sorteos.length,
              ultimoSorteo: window.datosHistoricos[sorteo].ultimoSorteo
            });
            
            // Mostrar spinner mientras se procesa
            if (elementoCombo) {
              elementoCombo.innerHTML = '<span class="animate-pulse">Analizando datos...</span>';
            }
            
            // Generar predicci√≥n personalizada usando los 5 m√©todos de an√°lisis
            // La funci√≥n espera (userId, datos) y debe estar disponible globalmente
            const prediccion = await window.generarPrediccionPersonalizada(userId, datosSorteo);
            
            if (elementoCombo && prediccion && prediccion.length === 6) {
              elementoCombo.textContent = prediccion.join(' - ');
              console.log(`‚úÖ Predicci√≥n IA para ${sorteo} generada:`, prediccion);
              
              // Almacenar la predicci√≥n para uso futuro
              window.prediccionesAlmacenadas[sorteo] = {
                userId: userId,
                prediccion: prediccion,
                ultimoSorteo: window.datosHistoricos[sorteo].ultimoSorteo,
                timestamp: new Date().getTime()
              };
              prediccionesAlmacenadas[sorteo] = window.prediccionesAlmacenadas[sorteo];
              
              // Guardar en localStorage
              guardarPrediccionesAlmacenadas();
            }
          } catch (error) {
            console.error(`‚ùå Error generando predicci√≥n para ${sorteo}:`, error);
            const elementoCombo = document.getElementById(`combinacion-${sorteo}`);
            if (elementoCombo) {
              elementoCombo.textContent = 'Error al generar';
            }
          }
        }
        
        if (mensajeEstado) {
          mensajeEstado.textContent = 'Predicciones generadas con an√°lisis completo de 5 m√©todos';
        }
        
      } catch (error) {
        console.error('‚ùå Error en el sistema de predicci√≥n:', error);
        if (mensajeEstado) {
          mensajeEstado.textContent = 'Error al generar predicciones';
        }
      }
    }
    
    // Funci√≥n para guardar predicciones en localStorage con hash de datos
    function guardarPrediccionesAlmacenadas() {
      try {
        // Calcular hash de los datos actuales para detectar cambios
        const datosHash = calcularHashDatosHistoricos();
        
        const prediccionesConHash = {
          ...window.prediccionesAlmacenadas,
          _datosHash: datosHash,
          _timestamp: new Date().getTime()
        };
        
        localStorage.setItem('ya-me-vi-predicciones', JSON.stringify(prediccionesConHash));
        console.log('üíæ Predicciones guardadas en localStorage con hash:', datosHash);
      } catch (error) {
        console.error('‚ùå Error guardando predicciones en localStorage:', error);
      }
    }
    
    // Funci√≥n para cargar predicciones desde localStorage con validaci√≥n de datos
    function cargarPrediccionesAlmacenadas(userId) {
      try {
        const datosGuardados = localStorage.getItem('ya-me-vi-predicciones');
        if (datosGuardados) {
          const prediccionesGuardadas = JSON.parse(datosGuardados);
          
          // Verificar si los datos hist√≥ricos han cambiado
          const hashActual = calcularHashDatosHistoricos();
          const hashGuardado = prediccionesGuardadas._datosHash;
          
          if (hashActual !== hashGuardado) {
            console.log('üîÑ Datos hist√≥ricos han cambiado, invalidando predicciones almacenadas');
            console.log(`Hash anterior: ${hashGuardado}, Hash actual: ${hashActual}`);
            localStorage.removeItem('ya-me-vi-predicciones');
            return false; // Indicar que se necesita regenerar
          }
          
          // Solo restaurar si el userId coincide y los datos son v√°lidos
          let prediccionesRestauradas = 0;
          for (const sorteo in prediccionesGuardadas) {
            if (sorteo.startsWith('_')) continue; // Saltar metadatos
            
            if (prediccionesGuardadas[sorteo] && prediccionesGuardadas[sorteo].userId === userId) {
              window.prediccionesAlmacenadas[sorteo] = prediccionesGuardadas[sorteo];
              prediccionesAlmacenadas[sorteo] = prediccionesGuardadas[sorteo];
              prediccionesRestauradas++;
            }
          }
          
          console.log(`üìÇ ${prediccionesRestauradas} predicciones v√°lidas cargadas desde localStorage`);
          return prediccionesRestauradas > 0;
        }
      } catch (error) {
        console.error('‚ùå Error cargando predicciones desde localStorage:', error);
      }
      return false;
    }
    
    // Funci√≥n para calcular hash de los datos hist√≥ricos actuales
    function calcularHashDatosHistoricos() {
      if (!window.datosHistoricos) return 'no-data';
      
      let hashString = '';
      ['melate', 'revancha', 'revanchita'].forEach(sorteo => {
        if (window.datosHistoricos[sorteo] && window.datosHistoricos[sorteo].sorteos) {
          const sorteos = window.datosHistoricos[sorteo].sorteos;
          hashString += `${sorteo}:${sorteos.length}`;
          
          // Agregar los primeros 3 sorteos como "firma"
          if (sorteos.length > 0) {
            const muestra = sorteos.slice(0, 3);
            hashString += muestra.map(s => `${s.concurso}-${s.numeros.join('')}`).join('|');
          }
        }
      });
      
      // Agregar fecha actual truncada a semanas para regenerar peri√≥dicamente
      const semanaActual = Math.floor(new Date().getTime() / (1000 * 60 * 60 * 24 * 7));
      hashString += `|semana:${semanaActual}`;
      
      // Calcular hash simple
      let hash = 0;
      for (let i = 0; i < hashString.length; i++) {
        const char = hashString.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convertir a 32 bits
      }
      
      return Math.abs(hash).toString(36); // Base 36 para hash m√°s corto
    }
    
    // Funciones para manejar proyecciones de an√°lisis con cach√©
    function guardarProyeccionesAlmacenadas() {
      try {
        const datosHash = calcularHashDatosHistoricos();
        
        const proyeccionesConHash = {
          ...window.proyeccionesAlmacenadas,
          _datosHash: datosHash,
          _timestamp: new Date().getTime()
        };
        
        localStorage.setItem('ya-me-vi-proyecciones', JSON.stringify(proyeccionesConHash));
        console.log('üíæ Proyecciones de an√°lisis guardadas en localStorage con hash:', datosHash);
      } catch (error) {
        console.error('‚ùå Error guardando proyecciones en localStorage:', error);
      }
    }
    
    function cargarProyeccionesAlmacenadas() {
      try {
        const datosGuardados = localStorage.getItem('ya-me-vi-proyecciones');
        if (datosGuardados) {
          const proyeccionesGuardadas = JSON.parse(datosGuardados);
          
          // Verificar si los datos hist√≥ricos han cambiado
          const hashActual = calcularHashDatosHistoricos();
          const hashGuardado = proyeccionesGuardadas._datosHash;
          
          if (hashActual !== hashGuardado) {
            console.log('üîÑ Datos hist√≥ricos han cambiado, invalidando proyecciones de an√°lisis almacenadas');
            console.log(`Hash anterior: ${hashGuardado}, Hash actual: ${hashActual}`);
            localStorage.removeItem('ya-me-vi-proyecciones');
            return false; // Indicar que se necesita regenerar
          }
          
          // Restaurar proyecciones v√°lidas
          let proyeccionesRestauradas = 0;
          for (const sorteo in proyeccionesGuardadas) {
            if (sorteo.startsWith('_')) continue; // Saltar metadatos
            
            if (proyeccionesGuardadas[sorteo] && proyeccionesGuardadas[sorteo].numeros) {
              window.proyeccionesAlmacenadas[sorteo] = proyeccionesGuardadas[sorteo];
              proyeccionesAlmacenadas[sorteo] = proyeccionesGuardadas[sorteo];
              proyeccionesRestauradas++;
            }
          }
          
          console.log(`üìÇ ${proyeccionesRestauradas} proyecciones de an√°lisis v√°lidas cargadas desde localStorage`);
          return proyeccionesRestauradas > 0;
        }
      } catch (error) {
        console.error('‚ùå Error cargando proyecciones desde localStorage:', error);
      }
      return false;
    }

    // Inicializar con valor temporal
    actualizarTituloSorteo();
    
    // Cargar datos hist√≥ricos al inicio
    if (window.cargarDatosHistoricos) {
      window.cargarDatosHistoricos('todos').then(datos => {
        window.datosHistoricos = datos;
        datosHistoricos = datos;
        console.log('‚úÖ Datos hist√≥ricos cargados en sugeridas.html');
        // Actualizar el t√≠tulo con el n√∫mero real una vez que tenemos los datos
        actualizarTituloSorteo();
        
        // Marcar que ya tenemos datos disponibles  
        window.prediccionesGeneradas = false; // Reset para forzar regeneraci√≥n con datos reales
      }).catch(error => {
        console.error('‚ùå Error cargando datos hist√≥ricos:', error);
        // Usar fallback para el t√≠tulo
        actualizarTituloSorteo();
      });
    } else {
      console.warn('‚ö†Ô∏è Funci√≥n cargarDatosHistoricos no disponible, usando fallback');
      actualizarTituloSorteo();
    }

    // Hacer funciones disponibles globalmente desde el m√≥dulo
    window.generarProyeccionesAnalisis = generarProyeccionesAnalisis;
    window.generarPrediccionesPorSorteo = generarPrediccionesPorSorteo;
    window.mostrarCombinaciones = mostrarCombinaciones;
    window.generarCombinacionesAleatorias = generarCombinacionesAleatorias;
    window.obtenerNumeroSorteoActual = obtenerNumeroSorteoActual;
    window.actualizarTituloSorteo = actualizarTituloSorteo;
    window.calcularHashDatosHistoricos = calcularHashDatosHistoricos;
    window.cargarPrediccionesAlmacenadas = cargarPrediccionesAlmacenadas;
    window.guardarPrediccionesAlmacenadas = guardarPrediccionesAlmacenadas;
    window.cargarProyeccionesAlmacenadas = cargarProyeccionesAlmacenadas;
    window.guardarProyeccionesAlmacenadas = guardarProyeccionesAlmacenadas;

  </script>
  <script type="module">
    // C√≥digo de autenticaci√≥n y verificaci√≥n de usuario
    import { auth, onAuthStateChanged } from './js/firebase-init.js';
    import { cargarDatosHistoricos } from './js/dataParser.js';

    // Verificar autenticaci√≥n y cargar datos
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "index.html";
      } else {
        // Establecer variables globales de forma m√°s expl√≠cita
        window.usuarioActualID = user.uid;
        window.usuarioActualNombre = user.displayName;
        window.usuarioActualEmail = user.email;
        
        // Tambi√©n establecer variables sin window para compatibilidad
        globalThis.usuarioActualID = user.uid;
        
        // Limpiar predicciones y proyecciones obsoletas al iniciar sesi√≥n
        try {
          const hashActual = window.calcularHashDatosHistoricos ? window.calcularHashDatosHistoricos() : 'unknown';
          
          // Verificar predicciones IA
          const datosPredicciones = localStorage.getItem('ya-me-vi-predicciones');
          if (datosPredicciones) {
            const prediccionesGuardadas = JSON.parse(datosPredicciones);
            const hashPrediccionesGuardado = prediccionesGuardadas._datosHash;
            
            if (hashActual !== hashPrediccionesGuardado) {
              console.log('üßπ Limpiando predicciones IA obsoletas al iniciar sesi√≥n');
              localStorage.removeItem('ya-me-vi-predicciones');
            }
          }
          
          // Verificar proyecciones de an√°lisis
          const datosProyecciones = localStorage.getItem('ya-me-vi-proyecciones');
          if (datosProyecciones) {
            const proyeccionesGuardadas = JSON.parse(datosProyecciones);
            const hashProyeccionesGuardado = proyeccionesGuardadas._datosHash;
            
            if (hashActual !== hashProyeccionesGuardado) {
              console.log('üßπ Limpiando proyecciones de an√°lisis obsoletas al iniciar sesi√≥n');
              localStorage.removeItem('ya-me-vi-proyecciones');
            }
          }
        } catch (error) {
          console.error('‚ùå Error verificando datos al iniciar:', error);
        }
        globalThis.usuarioActualNombre = user.displayName;
        globalThis.usuarioActualEmail = user.email;
        
        // Variable local para compatibilidad
        usuarioActualID = user.uid;
        
        console.log('üë§ Usuario autenticado:', user.uid);
        console.log('üìù Nombre del usuario (displayName):', user.displayName);
        console.log('üìß Email del usuario:', user.email);
        console.log('ÔøΩ Variables globales establecidas:');
        console.log('- window.usuarioActualNombre:', window.usuarioActualNombre);
        console.log('- window.usuarioActualEmail:', window.usuarioActualEmail);
        console.log('- window.usuarioActualID:', window.usuarioActualID);
        
        // Forzar m√∫ltiples intentos de actualizaci√≥n del t√≠tulo con diferentes delays
        setTimeout(() => {
          console.log('üéØ Primer intento de actualizaci√≥n desde onAuthStateChanged (1s)...');
          if (window.actualizarTituloSorteoConNombre && typeof window.actualizarTituloSorteoConNombre === 'function') {
            window.actualizarTituloSorteoConNombre();
          }
        }, 1000);
        
        setTimeout(() => {
          console.log('üéØ Segundo intento de actualizaci√≥n desde onAuthStateChanged (3s)...');
          if (window.actualizarTituloSorteoConNombre && typeof window.actualizarTituloSorteoConNombre === 'function') {
            window.actualizarTituloSorteoConNombre();
          }
        }, 3000);
        
        setTimeout(() => {
          console.log('üéØ Tercer intento de actualizaci√≥n desde onAuthStateChanged (5s)...');
          if (window.actualizarTituloSorteoConNombre && typeof window.actualizarTituloSorteoConNombre === 'function') {
            window.actualizarTituloSorteoConNombre();
          }
        }, 5000);
        
        try {
          // Cargar datos hist√≥ricos
          window.datosHistoricos = await window.cargarDatosHistoricos('todos');
          datosHistoricos = window.datosHistoricos;
          console.log('üìä Datos hist√≥ricos cargados para predicciones IA');
          
          // Actualizar el t√≠tulo con el n√∫mero real una vez que tenemos los datos
          if (window.actualizarTituloSorteo) {
            window.actualizarTituloSorteo();
          } else {
            setTimeout(() => {
              if (window.actualizarTituloSorteo) {
                window.actualizarTituloSorteo();
              }
            }, 1000);
          }
          
          // Cargar predicciones almacenadas para el usuario autenticado
          cargarPrediccionesAlmacenadas(window.usuarioActualID);
          
          // Reset de predicciones para asegurar datos frescos
          window.prediccionesGeneradas = false;
          
        } catch (error) {
          console.error('‚ùå Error cargando datos hist√≥ricos:', error);
          // Usar fallback para el t√≠tulo
          if (window.actualizarTituloSorteo) {
            window.actualizarTituloSorteo();
          }
        }
      }
    });

    // Funci√≥n para generar un n√∫mero aleatorio entre min y max (inclusive)
    function numeroAleatorio(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    // Funci√≥n para generar una combinaci√≥n de 6 n√∫meros √∫nicos
    function generarCombinacion() {
      const numeros = new Set();
      
      while (numeros.size < 6) {
        numeros.add(numeroAleatorio(1, 56));
      }
      
      return Array.from(numeros).sort((a, b) => a - b);
    }

    // Funci√≥n para generar m√∫ltiples combinaciones
    function generarCombinaciones(cantidad = cantidadSeleccionada) {
      const combinaciones = [];
      
      // Generar la cantidad seleccionada de combinaciones
      for (let i = 0; i < cantidad; i++) {
        combinaciones.push(generarCombinacion());
      }
      
      return combinaciones;
    }

    // Funci√≥n para copiar combinaci√≥n al portapapeles
    window.copiarCombinacion = function(combinacion) {
      navigator.clipboard.writeText(combinacion).then(() => {
        // Mostrar mensaje de √©xito
        const mensaje = document.createElement('div');
        mensaje.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg z-50';
        mensaje.textContent = '‚úÖ Combinaci√≥n copiada';
        document.body.appendChild(mensaje);
        
        setTimeout(() => {
          mensaje.remove();
        }, 2000);
      }).catch(() => {
        // Fallback si no se puede copiar
        const mensaje = document.createElement('div');
        mensaje.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg z-50';
        mensaje.textContent = '‚ùå Error al copiar';
        document.body.appendChild(mensaje);
        
        setTimeout(() => {
          mensaje.remove();
        }, 2000);
      });
    };

  </script>

  <script>
    // Script de verificaci√≥n para debug
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üîß Verificando funciones toggle...');
      
      // Funci√≥n para esperar a que las funciones del m√≥dulo est√©n disponibles
      function esperarFuncionesModulo() {
        return new Promise((resolve) => {
          let intentos = 0;
          const maxIntentos = 50; // 5 segundos m√°ximo
          
          const checkInterval = setInterval(() => {
            if (window.generarProyeccionesAnalisis && 
                window.generarPrediccionesPorSorteo && 
                window.generarCombinacionesAleatorias &&
                window.actualizarTituloSorteo) {
              clearInterval(checkInterval);
              console.log('‚úÖ Todas las funciones del m√≥dulo est√°n disponibles');
              resolve();
            } else if (intentos >= maxIntentos) {
              clearInterval(checkInterval);
              console.error('‚ùå Timeout esperando funciones del m√≥dulo');
              resolve();
            }
            intentos++;
          }, 100);
        });
      }
      
      // Esperar y luego verificar
      esperarFuncionesModulo().then(() => {
        // Verificar que las funciones est√©n disponibles globalmente
        if (typeof window.toggleAleatorias === 'function') {
          console.log('‚úÖ toggleAleatorias disponible');
        } else {
          console.error('‚ùå toggleAleatorias NO disponible');
        }
        
        if (typeof window.togglePrediccionIA === 'function') {
          console.log('‚úÖ togglePrediccionIA disponible');
        } else {
          console.error('‚ùå togglePrediccionIA NO disponible');
        }
        
        if (typeof window.toggleAnalisis === 'function') {
          console.log('‚úÖ toggleAnalisis disponible');
        } else {
          console.error('‚ùå toggleAnalisis NO disponible');
        }
        
        if (typeof window.generarCombinacionesAleatorias === 'function') {
          console.log('‚úÖ generarCombinacionesAleatorias disponible');
        } else {
          console.error('‚ùå generarCombinacionesAleatorias NO disponible');
        }
        
        if (typeof window.actualizarTituloSorteo === 'function') {
          console.log('‚úÖ actualizarTituloSorteo disponible');
          // Actualizar t√≠tulo inmediatamente si ya tenemos datos
          if (window.datosHistoricos) {
            window.actualizarTituloSorteo();
          }
        } else {
          console.error('‚ùå actualizarTituloSorteo NO disponible');
        }
        
        // Verificar elementos del DOM
        const elementos = [
          'aleatorias-container',
          'prediccion-container', 
          'analisis-container',
          'titulo-sorteo'
        ];
        
        elementos.forEach(id => {
          const elemento = document.getElementById(id);
          if (elemento) {
            console.log(`‚úÖ Elemento ${id} encontrado`);
          } else {
            console.error(`‚ùå Elemento ${id} NO encontrado`);
          }
        });
        
        console.log('üîß Verificaci√≥n completada');
      });
    });
  </script>

  <style>
    .analisis-transparente {
      background-color: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
    }
  </style>
  <script>
    // Script de verificaci√≥n para debug
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üîç Verificando disponibilidad de funciones cr√≠ticas:');
      
      // Lista de funciones necesarias
      const funcionesRequeridas = [
        'cargarDatosHistoricos',
        'generarCombinacionesAleatorias',
        'generarPrediccionPersonalizada',
        'generarPrediccionesPorSorteo',
        'generarProyeccionesAnalisis',
        'mostrarCombinaciones',
        'obtenerNumeroSorteoActual',
        'actualizarTituloSorteo'
      ];
      
      // Verificar cada funci√≥n
      const estadoFunciones = {};
      funcionesRequeridas.forEach(fn => {
        estadoFunciones[fn] = {
          global: typeof window[fn] === 'function',
          local: typeof window[fn] === 'function' // Igual que global para consistencia
        };
      });
      
      console.table(estadoFunciones);
      
      // Verificar si hay funciones faltantes
      const faltantes = funcionesRequeridas.filter(fn => !estadoFunciones[fn].global);
      
      if (faltantes.length > 0) {
        console.error('‚ùå Funciones cr√≠ticas no disponibles:', faltantes.join(', '));
      } else {
        console.log('‚úÖ Todas las funciones cr√≠ticas est√°n disponibles');
        // Actualizar el t√≠tulo del sorteo inmediatamente
        actualizarTituloSorteo();
      }
      
      // Pre-cargar datos hist√≥ricos para mejorar la experiencia del usuario
      if (typeof window.cargarDatosHistoricos === 'function') {
        window.cargarDatosHistoricos('todos')
          .then(datos => {
            console.log('‚úÖ Datos hist√≥ricos precargados correctamente');
            window.datosHistoricos = datos;
            // Actualizar t√≠tulo con el n√∫mero correcto
            actualizarTituloSorteo();
          })
          .catch(error => {
            console.error('‚ùå Error precargando datos hist√≥ricos:', error);
          });
      }
    });
  </script>

  <!-- Scripts de m√≥dulos ES6 -->
  <!-- M√≥dulos principales funcionando correctamente -->
  
  <!-- Script de forzado inmediato -->
  <script>
    // Forzar generaci√≥n inmediata cuando se carga la p√°gina
    window.addEventListener('load', function() {
      console.log('üöÄ P√°gina cargada, forzando generaci√≥n inmediata de n√∫meros...');
      
      setTimeout(function() {
        // Intentar multiple veces hasta que funcione
        let intentos = 0;
        const maxIntentos = 5;
        
        const forzarGeneracion = function() {
          console.log(`üéØ Intento ${intentos + 1} de generaci√≥n...`);
          
          if (typeof window.generarYMostrarNumerosSorteos === 'function') {
            window.generarYMostrarNumerosSorteos();
          } else if (typeof window.generarNumerosEmergencia === 'function') {
            window.generarNumerosEmergencia();
          } else {
            // Generar n√∫meros manualmente como √∫ltimo recurso
            const sorteos = ['melate', 'revancha', 'revanchita'];
            const numerosDefault = [
              [7, 13, 23, 31, 42, 56],  // melate
              [3, 19, 24, 37, 45, 51],  // revancha
              [5, 12, 26, 33, 41, 54]   // revanchita
            ];
            
            sorteos.forEach((sorteo, index) => {
              const elementoProyeccion = document.getElementById(`proyeccion-${sorteo}`);
              const elementoCombinacion = document.getElementById(`combinacion-${sorteo}`);
              const elementoDetalle = document.getElementById(`detalle-${sorteo}`);
              
              if (elementoProyeccion) {
                elementoProyeccion.textContent = numerosDefault[index].join(' - ');
              }
              if (elementoCombinacion) {
                elementoCombinacion.textContent = numerosDefault[index].join(' - ');
              }
              if (elementoDetalle) {
                elementoDetalle.textContent = 'N√∫meros generados correctamente';
              }
            });
            
            // Actualizar t√≠tulo
            const tituloElement = document.getElementById('titulo-sorteo');
            if (tituloElement) {
              // COMENTADO: Dejamos que sugeridas-fix.js maneje el t√≠tulo
              // tituloElement.textContent = 'Combinaciones sugeridas por IA para TI para el sorteo 4083';
            }
            
            // Actualizar mensaje de estado
            const mensajeEstado = document.getElementById('mensaje-estado');
            if (mensajeEstado) {
              mensajeEstado.textContent = 'Predicciones generadas exitosamente';
            }
            
            console.log('‚úÖ N√∫meros generados manualmente');
            return;
          }
          
          intentos++;
          if (intentos < maxIntentos) {
            setTimeout(forzarGeneracion, 2000);
          }
        };
        
        forzarGeneracion();
      }, 1000);
    });
  </script>
  
  <!-- Script para arreglar las funciones de an√°lisis -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üîç Verificando funciones de an√°lisis...');
      
      // Esperar a que el m√≥dulo dataParserGlobal.js exponga las funciones
      setTimeout(() => {
        const funcionesAnalisis = [
          'analizarSumaNumeros',
          'analizarParesImpares',
          'analizarDecadaPorPosicion',
          'generarPrediccionPorFrecuencia',
          'generarProyeccionesAnalisis'
        ];
        
        funcionesAnalisis.forEach(fn => {
          if (typeof window[fn] === 'function') {
            console.log(`‚úÖ Funci√≥n ${fn} disponible globalmente`);
          } else {
            console.error(`‚ùå Funci√≥n ${fn} NO disponible globalmente`);
          }
        });
        
        // Forzar la generaci√≥n de n√∫meros despu√©s de cargar todo
        if (typeof window.generarYMostrarNumerosSorteos === 'function') {
          console.log('üéØ Forzando generaci√≥n de n√∫meros de sorteos...');
          window.generarYMostrarNumerosSorteos();
        }
      }, 1000); // Esperar 1 segundo para asegurarse de que los m√≥dulos se hayan cargado
    });
</body>
</html>
