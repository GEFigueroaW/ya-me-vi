<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Administración - YA ME VI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="assets/apple-touch-icon.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2226536008153511"
     crossorigin="anonymous"></script>

  <style>
    body {
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #1e40af 100%);
      min-height: 100vh;
    }
    
    .admin-card {
      backdrop-filter: blur(10px);
      background: rgba(31, 41, 55, 0.8);
      border: 1px solid rgba(156, 163, 175, 0.2);
      transition: all 0.3s ease;
    }
    
    .admin-card:hover {
      background: rgba(31, 41, 55, 0.9);
      border-color: rgba(156, 163, 175, 0.4);
    }
    
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
      animation: pulse 2s infinite;
    }
    
    .status-online { background-color: #10b981; }
    .status-offline { background-color: #ef4444; }
    .status-warning { background-color: #f59e0b; }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body class="text-white">
  <div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
      <div>
        <h1 class="text-4xl font-bold text-white mb-2">📊 Panel de Administración</h1>
        <p class="text-blue-200">YA ME VI - Sistema de Control</p>
      </div>
      <div class="flex items-center space-x-4">
        <div class="flex items-center">
          <span class="status-indicator status-warning" id="connection-indicator"></span>
          <div id="admin-status" class="text-yellow-400 font-medium">🔄 Verificando...</div>
        </div>
        <button onclick="window.location.href='index.html'" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg">
          🏠 Home
        </button>
      </div>
    </div>

    <!-- System Status -->
    <div class="admin-card p-4 rounded-lg mb-8">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <span class="status-indicator status-warning" id="system-status-indicator"></span>
          <span id="system-status" class="text-blue-200">🔄 Inicializando...</span>
        </div>
        <div id="last-update" class="text-gray-400 text-sm">--</div>
      </div>
    </div>

    <!-- Metrics Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <!-- Total Users -->
      <div class="admin-card p-6 rounded-lg">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-400 text-sm">Usuarios Activos</p>
            <p id="total-users" class="text-3xl font-bold text-green-400">0</p>
          </div>
          <div class="bg-green-500 p-3 rounded-full">
            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path>
            </svg>
          </div>
        </div>
      </div>

      <!-- Daily Queries -->
      <div class="admin-card p-6 rounded-lg">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-400 text-sm">Consultas Hoy</p>
            <p id="daily-queries" class="text-3xl font-bold text-blue-400">0</p>
          </div>
          <div class="bg-blue-500 p-3 rounded-full">
            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
        </div>
      </div>

      <!-- Total Analysis -->
      <div class="admin-card p-6 rounded-lg">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-400 text-sm">Análisis Total</p>
            <p id="total-analysis" class="text-3xl font-bold text-yellow-400">0</p>
          </div>
          <div class="bg-yellow-500 p-3 rounded-full">
            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
              <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"></path>
            </svg>
          </div>
        </div>
      </div>

      <!-- Database Records -->
      <div class="admin-card p-6 rounded-lg">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-400 text-sm">Registros en DB</p>
            <p id="db-records" class="text-3xl font-bold text-purple-400">0</p>
          </div>
          <div class="bg-purple-500 p-3 rounded-full">
            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
              <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"></path>
            </svg>
          </div>
        </div>
      </div>
    </div>

    <!-- Notifications Section -->
    <div class="admin-card p-6 rounded-lg mb-8">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold">🔔 Sistema de Notificaciones</h3>
        <span class="text-sm text-gray-400">Inicializando...</span>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-400 text-sm">Push Enviadas</p>
              <p id="push-sent" class="text-2xl font-bold text-blue-400">0</p>
            </div>
            <div class="text-blue-400">📧</div>
          </div>
        </div>
        
        <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-400 text-sm">In-App Activas</p>
              <p id="inapp-active" class="text-2xl font-bold text-green-400">0</p>
            </div>
            <div class="text-green-400">📱</div>
          </div>
        </div>
        
        <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-400 text-sm">Emails Enviados</p>
              <p id="emails-sent" class="text-2xl font-bold text-yellow-400">0</p>
            </div>
            <div class="text-yellow-400">✉️</div>
          </div>
        </div>
      </div>
      
      <!-- Notification Creation -->
      <div class="border-t border-gray-600 pt-6">
        <h4 class="text-lg font-medium mb-4">✏️ Crear Nueva Notificación</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-400 mb-2">Título</label>
            <input type="text" id="notification-title" placeholder="Nuevas Predicciones Disponibles" 
                   class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:border-blue-500 focus:outline-none">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-400 mb-2">Tipo</label>
            <select id="notification-type" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:border-blue-500 focus:outline-none">
              <option value="general">🔔 General</option>
              <option value="prediction">🎯 Predicción</option>
              <option value="maintenance">⚙️ Mantenimiento</option>
            </select>
          </div>
        </div>
        <div class="mt-4">
          <label class="block text-sm font-medium text-gray-400 mb-2">Mensaje</label>
          <textarea id="notification-message" rows="3" placeholder="Escribe el mensaje..."
                    class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:border-blue-500 focus:outline-none"></textarea>
        </div>
        <div class="mt-4 flex justify-end">
          <button onclick="sendNotification()" class="bg-green-600 hover:bg-green-700 px-6 py-2 rounded-lg transition-colors">
            📤 Enviar Notificación
          </button>
        </div>
      </div>
    </div>

    <!-- Users Table -->
    <div class="admin-card p-6 rounded-lg mb-8">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-semibold">👥 Usuarios Recientes</h3>
        <div class="text-sm text-gray-400">
          <span id="users-count">0</span> usuarios registrados
        </div>
      </div>
      
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-gray-600">
              <th class="text-left py-3 px-4 font-medium text-gray-300">Email</th>
              <th class="text-left py-3 px-4 font-medium text-gray-300">Nombre</th>
              <th class="text-left py-3 px-4 font-medium text-gray-300">Registro</th>
              <th class="text-left py-3 px-4 font-medium text-gray-300">Estado</th>
            </tr>
          </thead>
          <tbody id="users-table-body">
            <tr>
              <td colspan="4" class="text-center py-8 text-gray-400">
                🔄 Cargando usuarios...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="admin-card p-6 rounded-lg">
      <h3 class="text-xl font-semibold mb-6">⚡ Acciones Rápidas</h3>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <button onclick="refreshAllData()" class="bg-blue-600 hover:bg-blue-700 p-4 rounded-lg transition-colors text-center">
          <div class="text-2xl mb-2">🔄</div>
          <div class="font-medium">Actualizar</div>
        </button>
        
        <button onclick="exportData()" class="bg-green-600 hover:bg-green-700 p-4 rounded-lg transition-colors text-center">
          <div class="text-2xl mb-2">📊</div>
          <div class="font-medium">Exportar</div>
        </button>
        
        <button onclick="viewLogs()" class="bg-orange-600 hover:bg-orange-700 p-4 rounded-lg transition-colors text-center">
          <div class="text-2xl mb-2">📋</div>
          <div class="font-medium">Ver Logs</div>
        </button>
        
        <button onclick="manageDB()" class="bg-purple-600 hover:bg-purple-700 p-4 rounded-lg transition-colors text-center">
          <div class="text-2xl mb-2">🗄️</div>
          <div class="font-medium">Gestionar DB</div>
        </button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module">
    // Firebase imports
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
    import { getFirestore, collection, getDocs, doc, getDoc, query, orderBy, limit, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDn3WCVaGl3lXPUIKJR0JrVi9nMbIkE0WM",
      authDomain: "yamevi-com-mx.firebaseapp.com",
      projectId: "yamevi-com-mx",
      storageBucket: "yamevi-com-mx.appspot.com",
      messagingSenderId: "461992870458",
      appId: "1:461992870458:web:5fb2b5c3e6b9b4a6d06b9c"
    };

    // Initialize
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let isUserAdmin = false;
    let currentUser = null;

    console.log('🚀 Panel de administración iniciando...');

    // Utility functions
    function updateIndicator(id, status) {
      const indicator = document.getElementById(id);
      if (indicator) {
        indicator.className = `status-indicator status-${status}`;
      }
    }

    function formatDate(timestamp) {
      if (!timestamp) return 'N/A';
      try {
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        return date.toLocaleDateString('es-MX', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (error) {
        return 'N/A';
      }
    }

    // Auth listener
    onAuthStateChanged(auth, async (user) => {
      const statusElement = document.getElementById('admin-status');
      
      if (user) {
        currentUser = user;
        console.log('👤 Usuario:', user.email);
        
        // Check admin
        const adminEmails = ['gfigueroa.w@gmail.com', 'admin@yamevi.com.mx', 'eugenfw@gmail.com'];
        isUserAdmin = adminEmails.includes(user.email);
        
        console.log('🔍 Es admin?', isUserAdmin);
        
        // Additional Firestore check
        if (!isUserAdmin) {
          try {
            const userDoc = await getDoc(doc(db, 'users', user.uid));
            if (userDoc.exists()) {
              isUserAdmin = userDoc.data().isAdmin === true;
            }
          } catch (error) {
            console.log('⚠️ Error Firestore:', error);
          }
        }
        
        if (isUserAdmin) {
          statusElement.textContent = `✅ Admin: ${user.email}`;
          statusElement.className = 'text-green-400 font-medium';
          updateIndicator('connection-indicator', 'online');
          
          console.log('👑 Admin verificado');
          await loadAdminData();
          startAutoRefresh();
          
        } else {
          statusElement.textContent = `❌ Sin permisos: ${user.email}`;
          statusElement.className = 'text-red-400 font-medium';
          updateIndicator('connection-indicator', 'offline');
          
          setTimeout(() => {
            alert(`❌ Sin permisos de administrador\n\nUsuario: ${user.email}\nAdmins: eugenfw@gmail.com, gfigueroa.w@gmail.com`);
            window.location.href = 'index.html';
          }, 2000);
        }
        
      } else {
        console.log('❌ No autenticado');
        statusElement.textContent = '🔒 No autenticado';
        statusElement.className = 'text-yellow-400 font-medium';
        updateIndicator('connection-indicator', 'warning');
        
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 3000);
      }
    });

    // Load admin data
    async function loadAdminData() {
      console.log('📊 Cargando datos...');
      
      try {
        await loadUsers();
        await loadStats();
        
        document.getElementById('system-status').textContent = '✅ Conectado - Firebase operativo';
        updateIndicator('system-status-indicator', 'online');
        
        const now = new Date().toLocaleString('es-MX');
        document.getElementById('last-update').textContent = `Actualizado: ${now}`;
        
        console.log('✅ Datos cargados');
        
      } catch (error) {
        console.error('❌ Error:', error);
        document.getElementById('system-status').textContent = '❌ Error de conexión';
        updateIndicator('system-status-indicator', 'offline');
      }
    }

    // Load users
    async function loadUsers() {
      try {
        const usersQuery = query(collection(db, 'users'), orderBy('createdAt', 'desc'), limit(50));
        const snapshot = await getDocs(usersQuery);
        
        document.getElementById('total-users').textContent = snapshot.size;
        document.getElementById('users-count').textContent = snapshot.size;
        
        const tbody = document.getElementById('users-table-body');
        tbody.innerHTML = '';
        
        if (snapshot.empty) {
          tbody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-gray-400">No hay usuarios registrados</td></tr>';
        } else {
          snapshot.forEach((doc) => {
            const data = doc.data();
            const row = document.createElement('tr');
            row.className = 'border-b border-gray-700 hover:bg-gray-800';
            
            const isAdmin = data.isAdmin ? ' <span class="ml-2 px-2 py-1 bg-yellow-600 text-xs rounded">ADMIN</span>' : '';
            
            row.innerHTML = `
              <td class="py-3 px-4">
                <div class="flex items-center">
                  <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm mr-3">
                    ${data.email.charAt(0).toUpperCase()}
                  </div>
                  <div>
                    <div class="font-medium">${data.email}${isAdmin}</div>
                    <div class="text-xs text-gray-400">${doc.id.substring(0, 8)}...</div>
                  </div>
                </div>
              </td>
              <td class="py-3 px-4">${data.displayName || 'N/A'}</td>
              <td class="py-3 px-4">${formatDate(data.createdAt)}</td>
              <td class="py-3 px-4">
                <span class="px-2 py-1 rounded-full text-xs bg-green-600">Activo</span>
              </td>
            `;
            
            tbody.appendChild(row);
          });
        }
        
        console.log(`✅ ${snapshot.size} usuarios cargados`);
        
      } catch (error) {
        console.error('❌ Error usuarios:', error);
        document.getElementById('total-users').textContent = 'Error';
        document.getElementById('users-table-body').innerHTML = '<tr><td colspan="4" class="text-center py-8 text-red-400">Error cargando usuarios</td></tr>';
      }
    }

    // Load statistics
    async function loadStats() {
      try {
        // Queries
        try {
          const queries = await getDocs(collection(db, 'queries'));
          document.getElementById('daily-queries').textContent = queries.size;
        } catch (e) {
          document.getElementById('daily-queries').textContent = '0';
        }
        
        // Analysis
        try {
          const analysis = await getDocs(collection(db, 'analysis'));
          document.getElementById('total-analysis').textContent = analysis.size;
        } catch (e) {
          document.getElementById('total-analysis').textContent = '0';
        }
        
        // DB records
        try {
          const users = await getDocs(collection(db, 'users'));
          document.getElementById('db-records').textContent = users.size;
        } catch (e) {
          document.getElementById('db-records').textContent = '0';
        }
        
        // Notifications
        try {
          const push = await getDocs(collection(db, 'pushNotifications'));
          document.getElementById('push-sent').textContent = push.size;
        } catch (e) {
          document.getElementById('push-sent').textContent = '0';
        }
        
        try {
          const inapp = await getDocs(collection(db, 'inAppNotifications'));
          document.getElementById('inapp-active').textContent = inapp.size;
        } catch (e) {
          document.getElementById('inapp-active').textContent = '0';
        }
        
        try {
          const emails = await getDocs(collection(db, 'emailNotifications'));
          document.getElementById('emails-sent').textContent = emails.size;
        } catch (e) {
          document.getElementById('emails-sent').textContent = '0';
        }
        
      } catch (error) {
        console.error('❌ Error stats:', error);
      }
    }

    // Auto refresh
    function startAutoRefresh() {
      setInterval(() => {
        if (isUserAdmin && currentUser) {
          console.log('🔄 Auto-refresh...');
          loadAdminData();
        }
      }, 30000);
    }

    // Global functions
    window.refreshAllData = async function() {
      if (!isUserAdmin) return;
      console.log('🔄 Refresh manual');
      await loadAdminData();
      alert('✅ Datos actualizados');
    };

    window.sendNotification = async function() {
      if (!isUserAdmin) return;
      
      const title = document.getElementById('notification-title').value.trim();
      const type = document.getElementById('notification-type').value;
      const message = document.getElementById('notification-message').value.trim();
      
      if (!title || !message) {
        alert('⚠️ Completa título y mensaje');
        return;
      }
      
      try {
        await addDoc(collection(db, 'notifications'), {
          title,
          message,
          type,
          createdAt: serverTimestamp(),
          createdBy: currentUser.email,
          status: 'sent'
        });
        
        document.getElementById('notification-title').value = '';
        document.getElementById('notification-message').value = '';
        alert('✅ Notificación enviada');
        
      } catch (error) {
        console.error('❌ Error notificación:', error);
        alert('❌ Error enviando notificación');
      }
    };

    window.exportData = function() {
      alert('🚧 Exportación en desarrollo');
    };

    window.viewLogs = function() {
      alert('🚧 Logs en desarrollo');
    };

    window.manageDB = function() {
      alert('🚧 Gestor DB en desarrollo');
    };

  </script>
</body>
</html>
