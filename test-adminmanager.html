<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test AdminDataManager - L√≠nea por L√≠nea</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: white; }
        .step { background: #333; padding: 10px; margin: 5px 0; border-radius: 4px; }
        .success { background: #0f5132; }
        .error { background: #842029; }
        .warning { background: #664d03; }
        pre { background: #000; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 11px; }
        button { padding: 8px 12px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .progress { background: #2a2a2a; padding: 15px; border-radius: 8px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üî¨ Test AdminDataManager - An√°lisis L√≠nea por L√≠nea</h1>
    
    <div class="progress">
        <h3>üéØ Objetivo: Verificar que AdminDataManager funciona correctamente</h3>
        <p>Vamos a probar cada funci√≥n paso a paso para encontrar exactamente d√≥nde falla.</p>
    </div>
    
    <button onclick="runFullTest()">‚ñ∂Ô∏è Ejecutar Test Completo</button>
    <button onclick="clearResults()">üóëÔ∏è Limpiar</button>
    
    <div id="results"></div>
    
    <script type="module">
        let testResults = [];
        
        window.runFullTest = runFullTest;
        window.clearResults = clearResults;
        
        function log(message, type = 'info') {
            console.log(message);
            const div = document.createElement('div');
            div.className = `step ${type}`;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            document.getElementById('results').appendChild(div);
            
            // Auto scroll
            div.scrollIntoView({ behavior: 'smooth' });
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
            testResults = [];
        }
        
        async function runFullTest() {
            clearResults();
            log('üöÄ INICIANDO TEST COMPLETO DE ADMIN DATA MANAGER', 'info');
            
            try {
                // Test 1: Cargar m√≥dulos
                log('üì¶ Test 1: Cargando m√≥dulos Firebase y AdminDataManager...', 'info');
                
                const firebase = await import('./js/firebase-init.js');
                log('‚úÖ Firebase importado correctamente', 'success');
                
                const adminModule = await import('./js/adminDataManager.js');
                log('‚úÖ AdminDataManager importado correctamente', 'success');
                
                const AdminDataManager = adminModule.AdminDataManager;
                if (!AdminDataManager) {
                    throw new Error('AdminDataManager no encontrado en el m√≥dulo');
                }
                log('‚úÖ Clase AdminDataManager encontrada', 'success');
                
                // Test 2: Verificar m√©todos disponibles
                log('üîç Test 2: Verificando m√©todos disponibles...', 'info');
                const methods = ['getUserStats', 'getQueryStats', 'getAllStats'];
                
                for (const method of methods) {
                    if (typeof AdminDataManager[method] === 'function') {
                        log(`‚úÖ M√©todo ${method} encontrado`, 'success');
                    } else {
                        log(`‚ùå M√©todo ${method} NO encontrado`, 'error');
                    }
                }
                
                // Test 3: Verificar autenticaci√≥n
                log('üîê Test 3: Verificando estado de autenticaci√≥n...', 'info');
                const currentUser = firebase.auth.currentUser;
                
                if (currentUser) {
                    log(`‚úÖ Usuario autenticado: ${currentUser.email}`, 'success');
                    
                    // Test de cada m√©todo individualmente
                    await testIndividualMethods(AdminDataManager, currentUser);
                    
                } else {
                    log('‚ö†Ô∏è No hay usuario autenticado. Creando usuario de prueba...', 'warning');
                    
                    // Intentar login autom√°tico para pruebas
                    try {
                        const { signInWithEmailAndPassword } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js");
                        
                        // Intenta con credenciales de prueba
                        log('üîë Intentando login autom√°tico...', 'info');
                        const userCredential = await signInWithEmailAndPassword(firebase.auth, 'gfigueroa.w@gmail.com', 'test123');
                        log(`‚úÖ Login autom√°tico exitoso: ${userCredential.user.email}`, 'success');
                        
                        await testIndividualMethods(AdminDataManager, userCredential.user);
                        
                    } catch (authError) {
                        log(`‚ùå Login autom√°tico fall√≥: ${authError.message}`, 'error');
                        log('üí° Necesitas hacer login manual para continuar', 'warning');
                    }
                }
                
            } catch (error) {
                log(`‚ùå ERROR FATAL EN TEST INICIAL:<pre>${error.message}\n${error.stack}</pre>`, 'error');
            }
        }
        
        async function testIndividualMethods(AdminDataManager, user) {
            log('üß™ Test 4: Probando m√©todos individuales...', 'info');
            
            // Test getUserStats
            try {
                log('üìä Probando getUserStats()...', 'info');
                const startTime = Date.now();
                const userStats = await AdminDataManager.getUserStats();
                const duration = Date.now() - startTime;
                
                log(`‚úÖ getUserStats() completado en ${duration}ms:<pre>${JSON.stringify(userStats, null, 2)}</pre>`, 'success');
                
            } catch (error) {
                log(`‚ùå getUserStats() fall√≥:<pre>${error.message}\n${error.stack}</pre>`, 'error');
            }
            
            // Test getQueryStats
            try {
                log('üìà Probando getQueryStats()...', 'info');
                const startTime = Date.now();
                const queryStats = await AdminDataManager.getQueryStats();
                const duration = Date.now() - startTime;
                
                log(`‚úÖ getQueryStats() completado en ${duration}ms:<pre>${JSON.stringify(queryStats, null, 2)}</pre>`, 'success');
                
            } catch (error) {
                log(`‚ùå getQueryStats() fall√≥:<pre>${error.message}\n${error.stack}</pre>`, 'error');
            }
            
            // Test getAllStats (el m√©todo completo)
            try {
                log('üéØ Probando getAllStats() - M√âTODO PRINCIPAL...', 'info');
                const startTime = Date.now();
                const allStats = await AdminDataManager.getAllStats();
                const duration = Date.now() - startTime;
                
                log(`‚úÖ getAllStats() completado en ${duration}ms:<pre>${JSON.stringify(allStats, null, 2)}</pre>`, 'success');
                
                // Verificar estructura esperada
                const expectedKeys = ['users', 'queries'];
                for (const key of expectedKeys) {
                    if (allStats[key]) {
                        log(`‚úÖ Secci√≥n '${key}' presente en resultado`, 'success');
                    } else {
                        log(`‚ö†Ô∏è Secci√≥n '${key}' faltante en resultado`, 'warning');
                    }
                }
                
            } catch (error) {
                log(`‚ùå getAllStats() fall√≥:<pre>${error.message}\n${error.stack}</pre>`, 'error');
            }
            
            log('üèÅ TEST COMPLETADO - Revisa los resultados arriba', 'info');
        }
        
        // Auto-ejecutar al cargar
        setTimeout(() => {
            log('‚è≥ Test se ejecutar√° autom√°ticamente en 2 segundos...', 'info');
            setTimeout(runFullTest, 2000);
        }, 1000);
    </script>
</body>
</html>
