<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Administración - YA ME VI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="assets/apple-touch-icon.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  
  <!-- Google AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2226536008153511"
     crossorigin="anonymous"></script>

  <style>
    body {
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #1e40af 100%);
      min-height: 100vh;
      position: relative;
    }
    
    .glass-effect {
      backdrop-filter: blur(10px);
      background: rgba(31, 41, 55, 0.8);
      border: 1px solid rgba(156, 163, 175, 0.2);
    }
    
    .admin-card {
      backdrop-filter: blur(10px);
      background: rgba(31, 41, 55, 0.8);
      border: 1px solid rgba(156, 163, 175, 0.2);
      transition: all 0.3s ease;
    }
    
    .admin-card:hover {
      background: rgba(31, 41, 55, 0.9);
      border-color: rgba(156, 163, 175, 0.4);
    }
    
    .metric-card {
      transition: transform 0.2s ease-in-out;
    }
    
    .metric-card:hover {
      transform: translateY(-2px);
    }
    
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
      animation: pulse 2s infinite;
    }
    
    .status-online {
      background-color: #10b981;
    }
    
    .status-offline {
      background-color: #ef4444;
    }
    
    .status-warning {
      background-color: #f59e0b;
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }
    
    .loading-skeleton {
      background: linear-gradient(90deg, #374151 25%, #4b5563 50%, #374151 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }
    
    @keyframes loading {
      0% {
        background-position: 200% 0;
      }
      100% {
        background-position: -200% 0;
      }
    }

    .notification-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #ef4444;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }
  </style>
</head>
<body class="text-white">
  <div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-8 space-y-4 lg:space-y-0">
      <div>
        <h1 class="text-4xl font-bold text-white mb-2 animate__animated animate__fadeInDown">
          📊 Panel de Administración
        </h1>
        <p class="text-blue-200 text-lg">YA ME VI - Sistema de Control Administrativo</p>
      </div>
      
      <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4">
        <div class="flex items-center">
          <span class="status-indicator status-warning" id="connection-indicator"></span>
          <div id="admin-status" class="text-yellow-400 font-medium">🔄 Verificando permisos...</div>
        </div>
        
        <div class="flex space-x-2">
          <button onclick="refreshAllData()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg transition-all duration-200 hover:scale-105 flex items-center space-x-2">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path>
            </svg>
            <span>Actualizar</span>
          </button>
          
          <button onclick="window.location.href='index.html'" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg transition-all duration-200 hover:scale-105 flex items-center space-x-2">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
            </svg>
            <span>Home</span>
          </button>
        </div>
      </div>
    </div>

    <!-- System Status Banner -->
    <div class="glass-effect p-4 rounded-lg mb-8 animate__animated animate__fadeInUp">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <div class="flex items-center">
            <span class="status-indicator status-warning" id="system-status-indicator"></span>
            <span id="system-status" class="text-blue-200 font-medium">🔄 Inicializando conexión con Firebase...</span>
          </div>
          <div class="text-gray-400 text-sm">
            Solo se muestran datos reales de Firebase.
          </div>
        </div>
        <div id="last-update" class="text-gray-400 text-sm">
          --
        </div>
      </div>
    </div>

    <!-- Metrics Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <!-- Total Users -->
      <div class="admin-card metric-card p-6 rounded-lg animate__animated animate__fadeInUp" style="animation-delay: 0.1s;">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-400 text-sm font-medium">Usuarios Activos</p>
            <p id="total-users" class="text-3xl font-bold text-green-400 loading-skeleton h-8 w-12 rounded mt-1">0</p>
            <p class="text-xs text-gray-500 mt-2">Total registrados</p>
          </div>
          <div class="bg-green-500 p-3 rounded-full relative">
            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path>
            </svg>
          </div>
        </div>
      </div>

      <!-- Daily Queries -->
      <div class="admin-card metric-card p-6 rounded-lg animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-400 text-sm font-medium">Consultas Hoy</p>
            <p id="daily-queries" class="text-3xl font-bold text-blue-400 loading-skeleton h-8 w-12 rounded mt-1">0</p>
            <p class="text-xs text-gray-500 mt-2">Últimas 24 horas</p>
          </div>
          <div class="bg-blue-500 p-3 rounded-full">
            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
        </div>
      </div>

      <!-- Total Analysis -->
      <div class="admin-card metric-card p-6 rounded-lg animate__animated animate__fadeInUp" style="animation-delay: 0.3s;">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-400 text-sm font-medium">Análisis Total</p>
            <p id="total-analysis" class="text-3xl font-bold text-yellow-400 loading-skeleton h-8 w-12 rounded mt-1">0</p>
            <p class="text-xs text-gray-500 mt-2">Evaluaciones realizadas</p>
          </div>
          <div class="bg-yellow-500 p-3 rounded-full">
            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
              <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"></path>
            </svg>
          </div>
        </div>
      </div>

      <!-- Database Records -->
      <div class="admin-card metric-card p-6 rounded-lg animate__animated animate__fadeInUp" style="animation-delay: 0.4s;">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-400 text-sm font-medium">Registros en DB</p>
            <p id="db-records" class="text-3xl font-bold text-purple-400 loading-skeleton h-8 w-12 rounded mt-1">0</p>
            <p class="text-xs text-gray-500 mt-2">Total en Firestore</p>
          </div>
          <div class="bg-purple-500 p-3 rounded-full">
            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
              <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"></path>
            </svg>
          </div>
        </div>
      </div>
    </div>

    <!-- Users Table -->
    <div class="admin-card p-6 rounded-lg mb-8 animate__animated animate__fadeInUp" style="animation-delay: 0.6s;">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-semibold">👥 Usuarios Recientes</h3>
        <div class="flex items-center space-x-4">
          <div class="text-sm text-gray-400">
            <span id="users-count">0</span> usuarios registrados
          </div>
          <button onclick="exportUsers()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-sm transition-colors">
            📊 Exportar
          </button>
        </div>
      </div>
      
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-gray-600">
              <th class="text-left py-3 px-4 font-medium text-gray-300">Email</th>
              <th class="text-left py-3 px-4 font-medium text-gray-300">Nombre</th>
              <th class="text-left py-3 px-4 font-medium text-gray-300">Registro</th>
              <th class="text-left py-3 px-4 font-medium text-gray-300">Estado</th>
            </tr>
          </thead>
          <tbody id="users-table-body">
            <tr>
              <td colspan="4" class="text-center py-8 text-gray-400">
                <div class="flex items-center justify-center space-x-2">
                  <svg class="animate-spin h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  <span>Cargando usuarios...</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Quick Actions Panel -->
    <div class="admin-card p-6 rounded-lg animate__animated animate__fadeInUp" style="animation-delay: 0.7s;">
      <h3 class="text-xl font-semibold mb-6">⚡ Acciones Rápidas</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <button onclick="refreshAllData()" class="bg-blue-600 hover:bg-blue-700 p-4 rounded-lg transition-all duration-200 hover:scale-105 flex flex-col items-center space-y-2">
          <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path>
          </svg>
          <span class="font-medium">Actualizar Todo</span>
        </button>
        
        <button onclick="exportAllData()" class="bg-green-600 hover:bg-green-700 p-4 rounded-lg transition-all duration-200 hover:scale-105 flex flex-col items-center space-y-2">
          <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
          </svg>
          <span class="font-medium">Exportar Datos</span>
        </button>
        
        <button onclick="viewSystemLogs()" class="bg-orange-600 hover:bg-orange-700 p-4 rounded-lg transition-all duration-200 hover:scale-105 flex flex-col items-center space-y-2">
          <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
          </svg>
          <span class="font-medium">Ver Logs</span>
        </button>
        
        <button onclick="manageDatabase()" class="bg-purple-600 hover:bg-purple-700 p-4 rounded-lg transition-all duration-200 hover:scale-105 flex flex-col items-center space-y-2">
          <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
            <path d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1z"></path>
          </svg>
          <span class="font-medium">Gestionar DB</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Loading Modal -->
  <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="glass-effect p-8 rounded-lg text-center">
      <svg class="animate-spin h-12 w-12 text-blue-400 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <p class="text-white text-lg font-medium" id="loading-text">Procesando...</p>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { 
      getAuth, 
      onAuthStateChanged
    } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
    import { 
      getFirestore, 
      collection, 
      getDocs, 
      doc, 
      getDoc, 
      query, 
      orderBy, 
      limit
    } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDn3WCVaGl3lXPUIKJR0JrVi9nMbIkE0WM",
      authDomain: "yamevi-com-mx.firebaseapp.com", 
      projectId: "yamevi-com-mx",
      storageBucket: "yamevi-com-mx.appspot.com",
      messagingSenderId: "461992870458",
      appId: "1:461992870458:web:5fb2b5c3e6b9b4a6d06b9c"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Global variables
    let isUserAdmin = false;
    let authCheckComplete = false;
    let currentUser = null;

    console.log('🚀 Inicializando panel de administración completamente reparado...');

    // Utility functions
    function showLoading(text = 'Procesando...') {
      document.getElementById('loading-text').textContent = text;
      document.getElementById('loading-modal').classList.remove('hidden');
    }

    function hideLoading() {
      document.getElementById('loading-modal').classList.add('hidden');
    }

    function updateStatusIndicator(elementId, status) {
      const indicator = document.getElementById(elementId);
      if (indicator) {
        indicator.className = `status-indicator status-${status}`;
      }
    }

    function formatDate(timestamp) {
      if (!timestamp) return 'N/A';
      
      try {
        let date;
        if (timestamp.toDate) {
          date = timestamp.toDate();
        } else if (timestamp instanceof Date) {
          date = timestamp;
        } else {
          date = new Date(timestamp);
        }
        
        return date.toLocaleDateString('es-MX', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (error) {
        console.error('Error formatting date:', error);
        return 'N/A';
      }
    }

    function removeLoadingSkeleton(elementId) {
      const element = document.getElementById(elementId);
      if (element) {
        element.classList.remove('loading-skeleton', 'h-8', 'w-12', 'rounded');
      }
    }

    // Authentication state listener
    onAuthStateChanged(auth, async (user) => {
      const statusElement = document.getElementById('admin-status');
      
      if (user) {
        currentUser = user;
        console.log('👤 Usuario autenticado:', user.email);
        
        // Check admin permissions
        const adminEmails = ['gfigueroa.w@gmail.com', 'admin@yamevi.com.mx', 'eugenfw@gmail.com'];
        isUserAdmin = adminEmails.includes(user.email);
        
        console.log('🔍 Verificando permisos de admin para:', user.email);
        console.log('✅ Lista de admins:', adminEmails);
        console.log('✅ Es admin por email?', isUserAdmin);
        
        // Additional Firestore check if needed
        if (!isUserAdmin) {
          try {
            const userDocRef = doc(db, 'users', user.uid);
            const userDoc = await getDoc(userDocRef);
            if (userDoc.exists()) {
              const userData = userDoc.data();
              isUserAdmin = userData.isAdmin === true;
              console.log('✅ Es admin por Firestore?', isUserAdmin, userData);
            }
          } catch (error) {
            console.log('⚠️ Error verificando admin en Firestore:', error);
          }
        }
        
        if (isUserAdmin) {
          statusElement.textContent = `✅ Admin autorizado: ${user.email}`;
          statusElement.className = 'text-green-400 font-medium';
          updateStatusIndicator('connection-indicator', 'online');
          
          console.log('👑 Usuario admin verificado correctamente:', user.email);
          
          // Load admin data
          await loadAdminData();
          
          // Initialize real-time updates
          startRealTimeUpdates();
          
        } else {
          statusElement.textContent = `❌ Sin permisos: ${user.email}`;
          statusElement.className = 'text-red-400 font-medium';
          updateStatusIndicator('connection-indicator', 'offline');
          
          console.log('⚠️ Usuario sin permisos de admin:', {
            email: user.email,
            uid: user.uid,
            adminEmails: adminEmails
          });
          
          setTimeout(() => {
            alert(`❌ No tienes permisos de administrador para esta sección.

Usuario actual: ${user.email}
Usuarios admin autorizados:
• gfigueroa.w@gmail.com
• eugenfw@gmail.com  
• admin@yamevi.com.mx

Si deberías tener acceso, contacta al administrador del sistema.`);
            window.location.href = 'index.html';
          }, 2000);
        }
        
        authCheckComplete = true;
      } else {
        console.log('❌ Usuario no autenticado');
        statusElement.textContent = '🔒 No autenticado - Redirigiendo al login...';
        statusElement.className = 'text-yellow-400 font-medium';
        updateStatusIndicator('connection-indicator', 'warning');
        
        setTimeout(() => {
          if (!authCheckComplete) {
            window.location.href = 'login.html';
          }
        }, 3000);
      }
    });

    // Main data loading function
    async function loadAdminData() {
      console.log('📊 Cargando datos de administración...');
      showLoading('Cargando datos del panel...');
      
      try {
        // Load users data
        await loadUsersData();
        
        // Load statistics
        await loadStatistics();
        
        // Update system status
        document.getElementById('system-status').textContent = '✅ Conectado - Firebase operativo';
        updateStatusIndicator('system-status-indicator', 'online');
        
        // Update last update time
        const now = new Date().toLocaleString('es-MX', {
          year: 'numeric',
          month: 'short', 
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
        document.getElementById('last-update').textContent = `Última actualización: ${now}`;
        
        console.log('✅ Panel de administración cargado completamente');
        
      } catch (error) {
        console.error('❌ Error cargando datos de administración:', error);
        document.getElementById('system-status').textContent = '❌ Error de conexión con Firebase';
        updateStatusIndicator('system-status-indicator', 'offline');
        showErrorState();
      } finally {
        hideLoading();
      }
    }

    // Load users data
    async function loadUsersData() {
      console.log('👥 Cargando datos de usuarios...');
      
      try {
        const usersQuery = query(
          collection(db, 'users'), 
          orderBy('createdAt', 'desc'), 
          limit(50)
        );
        const usersSnapshot = await getDocs(usersQuery);
        
        const totalUsers = usersSnapshot.size;
        const usersElement = document.getElementById('total-users');
        removeLoadingSkeleton('total-users');
        usersElement.textContent = totalUsers;
        
        document.getElementById('users-count').textContent = totalUsers;
        
        // Update users table
        const tableBody = document.getElementById('users-table-body');
        tableBody.innerHTML = '';
        
        if (usersSnapshot.empty) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="4" class="text-center py-8 text-gray-400">
                <div class="flex flex-col items-center space-y-2">
                  <svg class="w-12 h-12 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path>
                  </svg>
                  <p>No hay usuarios registrados</p>
                  <p class="text-sm text-gray-500">Los usuarios aparecerán aquí cuando se registren</p>
                </div>
              </td>
            </tr>
          `;
        } else {
          usersSnapshot.forEach((doc) => {
            const userData = doc.data();
            const row = document.createElement('tr');
            row.className = 'border-b border-gray-700 hover:bg-gray-800 transition-colors';
            
            const isAdmin = userData.isAdmin ? ' <span class="ml-2 px-2 py-1 bg-yellow-600 text-xs rounded font-bold">ADMIN</span>' : '';
            const createdAt = formatDate(userData.createdAt);
            
            row.innerHTML = `
              <td class="py-3 px-4">
                <div class="flex items-center">
                  <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm mr-3">
                    ${userData.email.charAt(0).toUpperCase()}
                  </div>
                  <div>
                    <div class="font-medium">${userData.email}${isAdmin}</div>
                    <div class="text-xs text-gray-400">ID: ${doc.id.substring(0, 8)}...</div>
                  </div>
                </div>
              </td>
              <td class="py-3 px-4">
                <div class="font-medium">${userData.displayName || 'N/A'}</div>
                <div class="text-xs text-gray-400">${userData.photoURL ? 'Con foto' : 'Sin foto'}</div>
              </td>
              <td class="py-3 px-4">
                <div class="text-sm">${createdAt}</div>
              </td>
              <td class="py-3 px-4">
                <span class="px-2 py-1 rounded-full text-xs font-medium bg-green-600 text-green-100">
                  Activo
                </span>
              </td>
            `;
            
            tableBody.appendChild(row);
          });
        }
        
        console.log(`✅ ${totalUsers} usuarios cargados en la tabla`);
        
      } catch (error) {
        console.error('❌ Error cargando usuarios:', error);
        const usersElement = document.getElementById('total-users');
        removeLoadingSkeleton('total-users');
        usersElement.textContent = 'Error';
        
        document.getElementById('users-table-body').innerHTML = `
          <tr>
            <td colspan="4" class="text-center py-8 text-red-400">
              ❌ Error cargando usuarios: ${error.message}
            </td>
          </tr>
        `;
      }
    }

    // Load statistics
    async function loadStatistics() {
      console.log('📈 Cargando estadísticas...');
      
      try {
        // Load queries statistics
        try {
          const queriesSnapshot = await getDocs(collection(db, 'queries'));
          const dailyQueriesElement = document.getElementById('daily-queries');
          removeLoadingSkeleton('daily-queries');
          dailyQueriesElement.textContent = queriesSnapshot.size;
          console.log(`📊 ${queriesSnapshot.size} consultas encontradas`);
        } catch (error) {
          console.log('⚠️ Colección queries no existe:', error.message);
          const dailyQueriesElement = document.getElementById('daily-queries');
          removeLoadingSkeleton('daily-queries');
          dailyQueriesElement.textContent = '0';
        }
        
        // Load analysis statistics
        try {
          const analysisSnapshot = await getDocs(collection(db, 'analysis'));
          const totalAnalysisElement = document.getElementById('total-analysis');
          removeLoadingSkeleton('total-analysis');
          totalAnalysisElement.textContent = analysisSnapshot.size;
          console.log(`📊 ${analysisSnapshot.size} análisis encontrados`);
        } catch (error) {
          console.log('⚠️ Colección analysis no existe:', error.message);
          const totalAnalysisElement = document.getElementById('total-analysis');
          removeLoadingSkeleton('total-analysis');
          totalAnalysisElement.textContent = '0';
        }
        
        // Load database records count
        try {
          const usersSnapshot = await getDocs(collection(db, 'users'));
          const dbRecordsElement = document.getElementById('db-records');
          removeLoadingSkeleton('db-records');
          dbRecordsElement.textContent = usersSnapshot.size;
          console.log(`📊 ${usersSnapshot.size} registros en DB`);
        } catch (error) {
          console.log('⚠️ Error contando registros DB:', error.message);
          const dbRecordsElement = document.getElementById('db-records');
          removeLoadingSkeleton('db-records');
          dbRecordsElement.textContent = '0';
        }
        
        console.log('✅ Estadísticas cargadas correctamente');
        
      } catch (error) {
        console.error('❌ Error cargando estadísticas:', error);
      }
    }

    // Show error state
    function showErrorState() {
      const elements = ['total-users', 'daily-queries', 'total-analysis', 'db-records'];
      elements.forEach(id => {
        const element = document.getElementById(id);
        removeLoadingSkeleton(id);
        element.textContent = 'Error';
        element.className = element.className.replace(/text-\w+-400/, 'text-red-400');
      });
    }

    // Start real-time updates
    function startRealTimeUpdates() {
      console.log('🔄 Iniciando actualizaciones automáticas...');
      
      // Update every 30 seconds
      setInterval(async () => {
        if (isUserAdmin && currentUser) {
          console.log('🔄 Actualizando datos automáticamente...');
          try {
            await loadUsersData();
            await loadStatistics();
            
            // Update timestamp
            const now = new Date().toLocaleString('es-MX', {
              year: 'numeric',
              month: 'short',
              day: 'numeric', 
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit'
            });
            document.getElementById('last-update').textContent = `Última actualización: ${now}`;
            
          } catch (error) {
            console.error('❌ Error en actualización automática:', error);
          }
        }
      }, 30000);
      
      console.log('✅ Actualizaciones automáticas configuradas (cada 30s)');
    }

    // Global functions for UI interactions
    window.refreshAllData = async function() {
      if (!isUserAdmin) {
        alert('❌ No tienes permisos para esta acción');
        return;
      }
      
      console.log('🔄 Actualizando todos los datos manualmente...');
      await loadAdminData();
      
      // Show success message
      const originalText = document.getElementById('system-status').textContent;
      document.getElementById('system-status').textContent = '✅ Datos actualizados correctamente';
      setTimeout(() => {
        document.getElementById('system-status').textContent = originalText;
      }, 3000);
    };

    window.exportAllData = function() {
      console.log('📊 Exportando todos los datos...');
      alert('🚧 Función de exportación en desarrollo\n\nPróximamente podrás exportar:\n• Lista de usuarios\n• Estadísticas de uso\n• Logs del sistema\n• Datos de Firebase');
    };

    window.exportUsers = function() {
      console.log('👥 Exportando usuarios...');
      alert('🚧 Exportación de usuarios en desarrollo\n\nPermitirá exportar en formato:\n• CSV\n• Excel\n• JSON');
    };

    window.viewSystemLogs = function() {
      console.log('📋 Viendo logs del sistema...');
      alert('🚧 Visualizador de logs en desarrollo\n\nMostrará:\n• Errores del sistema\n• Actividad de usuarios\n• Rendimiento\n• Logs de autenticación');
    };

    window.manageDatabase = function() {
      console.log('🗄️ Gestionando base de datos...');
      alert('🚧 Gestor de base de datos en desarrollo\n\nFuncionalidades:\n• Backup automático\n• Limpieza de datos\n• Optimización\n• Migración de esquemas');
    };

    // Initialize admin panel
    console.log('🎯 Panel de administración completamente reparado y listo');

  </script>
</body>
</html>
