<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Diagn√≥stico Completo Firebase - YA ME VI</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
</head>
<body class="bg-gray-100 p-4">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-center">üîç Diagn√≥stico Completo Firebase</h1>
        
        <div class="grid md:grid-cols-2 gap-6">
            <!-- Estado de Firebase -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4">üîß Estado Firebase</h2>
                <div id="firebase-status" class="space-y-2">
                    <div id="config-status">‚è≥ Verificando configuraci√≥n...</div>
                    <div id="auth-status">‚è≥ Verificando autenticaci√≥n...</div>
                    <div id="firestore-status">‚è≥ Verificando Firestore...</div>
                </div>
            </div>
            
            <!-- Usuario Actual -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4">üë§ Usuario Actual</h2>
                <div id="user-info">
                    <div id="user-status">‚è≥ Verificando usuario...</div>
                    <div id="user-details" class="mt-2 text-sm"></div>
                </div>
            </div>
        </div>
        
        <!-- Pruebas de Registro -->
        <div class="bg-white rounded-lg shadow-lg p-6 mt-6">
            <h2 class="text-xl font-semibold mb-4">üß™ Pruebas de Registro</h2>
            
            <!-- Registro con Email -->
            <div class="mb-6">
                <h3 class="font-semibold mb-2">üìß Registro con Email</h3>
                <div class="flex gap-4 mb-2">
                    <input type="email" id="test-email" placeholder="test@example.com" 
                           class="border px-3 py-2 rounded flex-1" value="test@example.com">
                    <input type="password" id="test-password" placeholder="password" 
                           class="border px-3 py-2 rounded flex-1" value="test123456">
                    <button id="test-email-register" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        Probar
                    </button>
                </div>
                <div id="email-test-result" class="text-sm"></div>
            </div>
            
            <!-- Registro con Google -->
            <div class="mb-6">
                <h3 class="font-semibold mb-2">üî¥ Registro con Google</h3>
                <button id="test-google-register" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                    Probar Google Auth
                </button>
                <div id="google-test-result" class="text-sm mt-2"></div>
            </div>
            
            <!-- Prueba de Guardado en Firestore -->
            <div class="mb-6">
                <h3 class="font-semibold mb-2">üíæ Prueba de Guardado</h3>
                <button id="test-firestore-write" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    Probar Escritura en Firestore
                </button>
                <div id="firestore-test-result" class="text-sm mt-2"></div>
            </div>
        </div>
        
        <!-- Log de Actividad -->
        <div class="bg-white rounded-lg shadow-lg p-6 mt-6">
            <h2 class="text-xl font-semibold mb-4">üìã Log de Actividad</h2>
            <div id="activity-log" class="bg-gray-50 p-4 rounded max-h-96 overflow-y-auto text-sm font-mono"></div>
            <button id="clear-log" class="mt-2 bg-gray-500 text-white px-4 py-2 rounded text-sm">
                Limpiar Log
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        // Configuraci√≥n Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB4bCGyyPuQo-3-ONMPFKtqPEJDFl8Cb54",
            authDomain: "ya-me-vi.firebaseapp.com",
            projectId: "ya-me-vi",
            storageBucket: "ya-me-vi.firebasestorage.app",
            messagingSenderId: "748876890843",
            appId: "1:748876890843:web:070d1eb476d38594d002fe",
            measurementId: "G-D7R797S5BC"
        };

        let app, auth, db;
        
        function log(message, type = 'info') {
            const now = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('activity-log');
            const color = type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-blue-600';
            logDiv.innerHTML += `<div class="${color}">[${now}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            const icon = status === 'success' ? '‚úÖ' : status === 'error' ? '‚ùå' : '‚è≥';
            const color = status === 'success' ? 'text-green-600' : status === 'error' ? 'text-red-600' : 'text-yellow-600';
            element.innerHTML = `<span class="${color}">${icon} ${message}</span>`;
        }

        // Inicializar Firebase
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            updateStatus('config-status', 'success', 'Configuraci√≥n OK');
            updateStatus('auth-status', 'success', 'Auth inicializado');
            updateStatus('firestore-status', 'success', 'Firestore inicializado');
            
            log('‚úÖ Firebase inicializado correctamente', 'success');
        } catch (error) {
            updateStatus('config-status', 'error', `Error: ${error.message}`);
            log(`‚ùå Error inicializando Firebase: ${error.message}`, 'error');
        }

        // Monitor de usuario
        onAuthStateChanged(auth, (user) => {
            if (user) {
                updateStatus('user-status', 'success', `Autenticado: ${user.email || 'Sin email'}`);
                document.getElementById('user-details').innerHTML = `
                    <div><strong>UID:</strong> ${user.uid}</div>
                    <div><strong>Email:</strong> ${user.email || 'No disponible'}</div>
                    <div><strong>Nombre:</strong> ${user.displayName || 'Sin nombre'}</div>
                    <div><strong>Proveedor:</strong> ${user.providerData[0]?.providerId || 'Desconocido'}</div>
                    <div><strong>Verificado:</strong> ${user.emailVerified ? 'S√≠' : 'No'}</div>
                `;
                log(`üë§ Usuario autenticado: ${user.email || user.uid}`, 'success');
            } else {
                updateStatus('user-status', 'error', 'No autenticado');
                document.getElementById('user-details').innerHTML = '<div class="text-gray-500">No hay usuario conectado</div>';
                log('üë§ No hay usuario autenticado', 'info');
            }
        });

        // Prueba de registro con email
        document.getElementById('test-email-register').addEventListener('click', async () => {
            const email = document.getElementById('test-email').value;
            const password = document.getElementById('test-password').value;
            
            if (!email || !password) {
                document.getElementById('email-test-result').innerHTML = '<span class="text-red-600">‚ùå Email y contrase√±a requeridos</span>';
                return;
            }
            
            log(`üß™ Probando registro con email: ${email}`, 'info');
            
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                document.getElementById('email-test-result').innerHTML = '<span class="text-green-600">‚úÖ Registro exitoso</span>';
                log(`‚úÖ Registro exitoso: ${userCredential.user.email}`, 'success');
                
                // Limpiar usuario de prueba
                setTimeout(async () => {
                    try {
                        await userCredential.user.delete();
                        log('‚úÖ Usuario de prueba eliminado', 'success');
                    } catch (deleteError) {
                        log(`‚ö†Ô∏è Error eliminando usuario de prueba: ${deleteError.message}`, 'error');
                    }
                }, 2000);
                
            } catch (error) {
                document.getElementById('email-test-result').innerHTML = `<span class="text-red-600">‚ùå ${error.message}</span>`;
                log(`‚ùå Error en registro: ${error.code} - ${error.message}`, 'error');
            }
        });

        // Prueba de Google Auth
        document.getElementById('test-google-register').addEventListener('click', async () => {
            log('üß™ Probando Google Auth...', 'info');
            
            try {
                const provider = new GoogleAuthProvider();
                provider.setCustomParameters({
                    prompt: 'select_account'
                });
                
                const result = await signInWithPopup(auth, provider);
                document.getElementById('google-test-result').innerHTML = '<span class="text-green-600">‚úÖ Google Auth exitoso</span>';
                log(`‚úÖ Google Auth exitoso: ${result.user.email}`, 'success');
                
                // No cerrar sesi√≥n para poder ver los datos del usuario
                
            } catch (error) {
                document.getElementById('google-test-result').innerHTML = `<span class="text-red-600">‚ùå ${error.message}</span>`;
                log(`‚ùå Error en Google Auth: ${error.code} - ${error.message}`, 'error');
            }
        });

        // Prueba de escritura en Firestore
        document.getElementById('test-firestore-write').addEventListener('click', async () => {
            if (!auth.currentUser) {
                document.getElementById('firestore-test-result').innerHTML = '<span class="text-red-600">‚ùå Necesitas estar autenticado</span>';
                return;
            }
            
            log('üß™ Probando escritura en Firestore...', 'info');
            
            try {
                const testData = {
                    test: true,
                    timestamp: new Date().toISOString(),
                    userId: auth.currentUser.uid
                };
                
                await setDoc(doc(db, 'test', 'diagnostic'), testData);
                document.getElementById('firestore-test-result').innerHTML = '<span class="text-green-600">‚úÖ Escritura exitosa</span>';
                log('‚úÖ Escritura en Firestore exitosa', 'success');
                
                // Probar lectura
                const docSnap = await getDoc(doc(db, 'test', 'diagnostic'));
                if (docSnap.exists()) {
                    log('‚úÖ Lectura de Firestore exitosa', 'success');
                } else {
                    log('‚ö†Ô∏è Documento no encontrado despu√©s de escribir', 'error');
                }
                
            } catch (error) {
                document.getElementById('firestore-test-result').innerHTML = `<span class="text-red-600">‚ùå ${error.message}</span>`;
                log(`‚ùå Error en Firestore: ${error.code} - ${error.message}`, 'error');
            }
        });

        // Limpiar log
        document.getElementById('clear-log').addEventListener('click', () => {
            document.getElementById('activity-log').innerHTML = '';
        });
    </script>
</body>
</html>
