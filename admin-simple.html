<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel de Administración - YA ME VI</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <link rel="stylesheet" href="css/styles.css" />
</head>
<body class="overflow-x-hidden">

  <!-- Fondo -->
  <div id="background" class="fixed inset-0 z-0 bg-cover bg-center transition-opacity duration-1000"></div>

  <!-- Contenido -->
  <div class="relative z-10 min-h-screen text-white text-center p-4 md:p-10">

    <!-- Encabezado -->
    <div class="flex items-center justify-between mb-8">
      <div class="flex items-center">
        <button id="btn-back" class="mr-4 bg-gray-800 bg-opacity-70 p-2 rounded-lg hover:bg-opacity-90 transition-all">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </button>
        <h1 class="text-2xl md:text-4xl font-bold">🛡️ Panel de Control Admin</h1>
      </div>
      <div class="text-right">
        <div id="admin-status" class="text-lg font-medium text-yellow-400">🔄 Verificando...</div>
        <div id="current-time" class="text-sm text-gray-300"></div>
      </div>
    </div>

    <!-- Estado de conexión -->
    <div class="mb-6 text-center">
      <div id="connection-status" class="inline-block px-4 py-2 bg-gray-800 bg-opacity-70 rounded-lg">
        <span class="text-yellow-400">🔄 Conectando...</span>
      </div>
    </div>

    <!-- Métricas principales -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      <!-- Usuarios Activos -->
      <div class="bg-gray-800 bg-opacity-70 p-6 rounded-lg">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-300">Usuarios Totales</p>
            <p id="total-users" class="text-2xl font-bold text-green-400">
              <span class="animate-pulse">...</span>
            </p>
          </div>
          <div class="text-green-400">👥</div>
        </div>
      </div>

      <!-- Total Consultas -->
      <div class="bg-gray-800 bg-opacity-70 p-6 rounded-lg">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-300">Consultas Hoy</p>
            <p id="daily-queries" class="text-2xl font-bold text-blue-400">
              <span class="animate-pulse">...</span>
            </p>
          </div>
          <div class="text-blue-400">📊</div>
        </div>
      </div>

      <!-- Análisis Totales -->
      <div class="bg-gray-800 bg-opacity-70 p-6 rounded-lg">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-300">Análisis Total</p>
            <p id="total-analysis" class="text-2xl font-bold text-yellow-400">
              <span class="animate-pulse">...</span>
            </p>
          </div>
          <div class="text-yellow-400">🔮</div>
        </div>
      </div>

      <!-- Registros en DB -->
      <div class="bg-gray-800 bg-opacity-70 p-6 rounded-lg">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-300">Registros DB</p>
            <p id="database-size" class="text-2xl font-bold text-purple-400">
              <span class="animate-pulse">...</span>
            </p>
          </div>
          <div class="text-purple-400">💾</div>
        </div>
      </div>
    </div>

    <!-- Debug Panel -->
    <div class="bg-gray-800 bg-opacity-70 p-6 rounded-lg mb-8">
      <h2 class="text-xl font-bold mb-4">🔍 Estado del Sistema</h2>
      <div id="debug-info" class="text-left text-sm">
        <div>🔄 Inicializando...</div>
      </div>
    </div>

  </div>

  <!-- Scripts -->
  <script type="module" src="js/init.js"></script>
  <script type="module">
    console.log('🚀 Iniciando panel admin simplificado...');
    
    let authUser = null;
    let isAdmin = false;
    
    // Función para actualizar debug info
    function updateDebugInfo(message) {
      const debugDiv = document.getElementById('debug-info');
      const timestamp = new Date().toLocaleTimeString();
      debugDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
      debugDiv.scrollTop = debugDiv.scrollHeight;
    }
    
    // Función para actualizar hora
    function updateTime() {
      const now = new Date();
      const timeString = now.toLocaleString('es-MX', {
        year: 'numeric', month: 'short', day: 'numeric',
        hour: '2-digit', minute: '2-digit', second: '2-digit'
      });
      document.getElementById('current-time').textContent = timeString;
    }
    
    // Función para mostrar datos
    function showData(data) {
      console.log('📊 Mostrando datos:', data);
      
      // Quitar animaciones de loading
      document.querySelectorAll('.animate-pulse').forEach(el => {
        el.classList.remove('animate-pulse');
      });
      
      // Actualizar valores
      document.getElementById('total-users').textContent = data.totalUsers || 0;
      document.getElementById('daily-queries').textContent = data.dailyQueries || 0;
      document.getElementById('total-analysis').textContent = data.totalAnalysis || 0;
      document.getElementById('database-size').textContent = data.databaseSize || 0;
      
      updateDebugInfo(`✅ Datos actualizados: ${JSON.stringify(data)}`);
    }
    
    // Función para mostrar error
    function showError(message) {
      console.error('❌ Error:', message);
      
      // Quitar animaciones y mostrar 0
      document.querySelectorAll('.animate-pulse').forEach(el => {
        el.classList.remove('animate-pulse');
        el.textContent = '0';
      });
      
      updateDebugInfo(`❌ Error: ${message}`);
      
      // Actualizar estado de conexión
      document.getElementById('connection-status').innerHTML = 
        '<span class="text-red-400">🔴 Error de conexión</span>';
    }

    // Configurar botón de volver
    document.getElementById('btn-back').addEventListener('click', () => {
      window.location.href = '/home.html';
    });
    
    // Inicializar
    updateTime();
    setInterval(updateTime, 1000);
    updateDebugInfo('🔄 Iniciando verificaciones...');

    try {
      // Importar Firebase
      updateDebugInfo('📦 Importando Firebase...');
      const { auth, db, onAuthStateChanged } = await import('./js/firebase-init.js');
      updateDebugInfo('✅ Firebase importado correctamente');
      
      // Importar AdminDataManager
      updateDebugInfo('📦 Importando AdminDataManager...');
      const { AdminDataManager } = await import('./js/adminDataManager.js');
      updateDebugInfo('✅ AdminDataManager importado correctamente');
      
      // Verificar autenticación
      updateDebugInfo('🔐 Configurando listener de autenticación...');
      
      onAuthStateChanged(auth, async (user) => {
        const statusElement = document.getElementById('admin-status');
        
        if (user) {
          authUser = user;
          updateDebugInfo(`👤 Usuario autenticado: ${user.email}`);
          
          // Verificar admin
          const adminEmails = ['gfigueroa.w@gmail.com', 'admin@yamevi.com.mx', 'eugenfw@gmail.com'];
          isAdmin = adminEmails.includes(user.email);
          
          updateDebugInfo(`🔍 Verificando admin: ${user.email} -> ${isAdmin ? 'SÍ' : 'NO'}`);
          
          if (isAdmin) {
            statusElement.innerHTML = `✅ Admin: ${user.email}`;
            statusElement.className = 'text-lg font-medium text-green-400';
            
            document.getElementById('connection-status').innerHTML = 
              '<span class="text-green-400">🟢 Conectado como Admin</span>';
              
            updateDebugInfo('🎯 Cargando datos de administración...');
            
            try {
              // Cargar datos con timeout
              const timeoutPromise = new Promise((_, reject) => 
                setTimeout(() => reject(new Error('Timeout después de 10s')), 10000)
              );
              
              const dataPromise = AdminDataManager.getAllStats();
              const data = await Promise.race([dataPromise, timeoutPromise]);
              
              updateDebugInfo('✅ Datos cargados exitosamente');
              
              if (data && data.summary) {
                showData(data.summary);
              } else if (data) {
                // Crear summary manualmente
                const summary = {
                  totalUsers: data.users?.totalUsers || data.totalUsers || 0,
                  dailyQueries: data.queries?.dailyQueries || data.dailyQueries || 0,
                  totalAnalysis: data.queries?.totalAnalysis || data.totalAnalysis || 0,
                  databaseSize: data.database?.totalSize || data.database?.totalRecords || 0
                };
                showData(summary);
              } else {
                throw new Error('Datos en formato inesperado');
              }
              
            } catch (dataError) {
              updateDebugInfo(`❌ Error cargando datos: ${dataError.message}`);
              showError(dataError.message);
            }
            
          } else {
            statusElement.innerHTML = `❌ Sin permisos: ${user.email}`;
            statusElement.className = 'text-lg font-medium text-red-400';
            
            document.getElementById('connection-status').innerHTML = 
              '<span class="text-red-400">🔴 Sin permisos de admin</span>';
              
            updateDebugInfo(`❌ Usuario sin permisos de admin: ${user.email}`);
            showError('Usuario sin permisos de administrador');
          }
          
        } else {
          updateDebugInfo('❌ Usuario no autenticado');
          statusElement.innerHTML = '🔒 No autenticado';
          statusElement.className = 'text-lg font-medium text-yellow-400';
          
          document.getElementById('connection-status').innerHTML = 
            '<span class="text-yellow-400">🟡 Esperando autenticación</span>';
            
          showError('Usuario no autenticado');
        }
      });
      
    } catch (error) {
      console.error('❌ Error fatal:', error);
      updateDebugInfo(`💥 Error fatal: ${error.message}`);
      showError(`Error fatal: ${error.message}`);
    }
  </script>
</body>
</html>
