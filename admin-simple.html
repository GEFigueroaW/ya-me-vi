<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel de AdministraciÃ³n - YA ME VI</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <link rel="stylesheet" href="css/styles.css" />
</head>
<body class="overflow-x-hidden">

  <!-- Fondo -->
  <div id="background" class="fixed inset-0 z-0 bg-cover bg-center transition-opacity duration-1000"></div>

  <!-- Contenido -->
  <div class="relative z-10 min-h-screen text-white text-center p-4 md:p-10">

    <!-- Encabezado -->
    <div class="flex items-center justify-between mb-8">
      <div class="flex items-center">
        <button id="btn-back" class="mr-4 bg-gray-800 bg-opacity-70 p-2 rounded-lg hover:bg-opacity-90 transition-all">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </button>
        <h1 class="text-2xl md:text-4xl font-bold">ğŸ›¡ï¸ Panel de Control Admin</h1>
      </div>
      <div class="text-right">
        <div id="admin-status" class="text-lg font-medium text-yellow-400">ğŸ”„ Verificando...</div>
        <div id="current-time" class="text-sm text-gray-300"></div>
      </div>
    </div>

    <!-- Estado de conexiÃ³n -->
    <div class="mb-6 text-center">
      <div id="connection-status" class="inline-block px-4 py-2 bg-gray-800 bg-opacity-70 rounded-lg">
        <span class="text-yellow-400">ğŸ”„ Conectando...</span>
      </div>
    </div>

    <!-- MÃ©tricas principales -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      <!-- Usuarios Activos -->
      <div class="bg-gray-800 bg-opacity-70 p-6 rounded-lg">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-300">Usuarios Totales</p>
            <p id="total-users" class="text-2xl font-bold text-green-400">
              <span class="animate-pulse">...</span>
            </p>
          </div>
          <div class="text-green-400">ğŸ‘¥</div>
        </div>
      </div>

      <!-- Total Consultas -->
      <div class="bg-gray-800 bg-opacity-70 p-6 rounded-lg">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-300">Consultas Hoy</p>
            <p id="daily-queries" class="text-2xl font-bold text-blue-400">
              <span class="animate-pulse">...</span>
            </p>
          </div>
          <div class="text-blue-400">ğŸ“Š</div>
        </div>
      </div>

      <!-- AnÃ¡lisis Totales -->
      <div class="bg-gray-800 bg-opacity-70 p-6 rounded-lg">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-300">AnÃ¡lisis Total</p>
            <p id="total-analysis" class="text-2xl font-bold text-yellow-400">
              <span class="animate-pulse">...</span>
            </p>
          </div>
          <div class="text-yellow-400">ğŸ”®</div>
        </div>
      </div>

      <!-- Registros en DB -->
      <div class="bg-gray-800 bg-opacity-70 p-6 rounded-lg">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-300">Registros DB</p>
            <p id="database-size" class="text-2xl font-bold text-purple-400">
              <span class="animate-pulse">...</span>
            </p>
          </div>
          <div class="text-purple-400">ğŸ’¾</div>
        </div>
      </div>
    </div>

    <!-- Debug Panel -->
    <div class="bg-gray-800 bg-opacity-70 p-6 rounded-lg mb-8">
      <h2 class="text-xl font-bold mb-4">ğŸ” Estado del Sistema</h2>
      <div id="debug-info" class="text-left text-sm">
        <div>ğŸ”„ Inicializando...</div>
      </div>
    </div>

  </div>

  <!-- Scripts -->
  <script type="module" src="js/init.js"></script>
  <script type="module">
    console.log('ğŸš€ Iniciando panel admin simplificado...');
    
    let authUser = null;
    let isAdmin = false;
    
    // FunciÃ³n para actualizar debug info
    function updateDebugInfo(message) {
      const debugDiv = document.getElementById('debug-info');
      const timestamp = new Date().toLocaleTimeString();
      debugDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
      debugDiv.scrollTop = debugDiv.scrollHeight;
    }
    
    // FunciÃ³n para actualizar hora
    function updateTime() {
      const now = new Date();
      const timeString = now.toLocaleString('es-MX', {
        year: 'numeric', month: 'short', day: 'numeric',
        hour: '2-digit', minute: '2-digit', second: '2-digit'
      });
      document.getElementById('current-time').textContent = timeString;
    }
    
    // FunciÃ³n para mostrar datos
    function showData(data) {
      console.log('ğŸ“Š Mostrando datos:', data);
      
      // Quitar animaciones de loading
      document.querySelectorAll('.animate-pulse').forEach(el => {
        el.classList.remove('animate-pulse');
      });
      
      // Actualizar valores
      document.getElementById('total-users').textContent = data.totalUsers || 0;
      document.getElementById('daily-queries').textContent = data.dailyQueries || 0;
      document.getElementById('total-analysis').textContent = data.totalAnalysis || 0;
      document.getElementById('database-size').textContent = data.databaseSize || 0;
      
      updateDebugInfo(`âœ… Datos actualizados: ${JSON.stringify(data)}`);
    }
    
    // FunciÃ³n para mostrar error
    function showError(message) {
      console.error('âŒ Error:', message);
      
      // Quitar animaciones y mostrar 0
      document.querySelectorAll('.animate-pulse').forEach(el => {
        el.classList.remove('animate-pulse');
        el.textContent = '0';
      });
      
      updateDebugInfo(`âŒ Error: ${message}`);
      
      // Actualizar estado de conexiÃ³n
      document.getElementById('connection-status').innerHTML = 
        '<span class="text-red-400">ğŸ”´ Error de conexiÃ³n</span>';
    }

    // Configurar botÃ³n de volver
    document.getElementById('btn-back').addEventListener('click', () => {
      window.location.href = '/home.html';
    });
    
    // Inicializar
    updateTime();
    setInterval(updateTime, 1000);
    updateDebugInfo('ğŸ”„ Iniciando verificaciones...');

    try {
      // Importar Firebase
      updateDebugInfo('ğŸ“¦ Importando Firebase...');
      const { auth, db, onAuthStateChanged } = await import('./js/firebase-init.js');
      updateDebugInfo('âœ… Firebase importado correctamente');
      
      // Importar AdminDataManager
      updateDebugInfo('ğŸ“¦ Importando AdminDataManager...');
      const { AdminDataManager } = await import('./js/adminDataManager.js');
      updateDebugInfo('âœ… AdminDataManager importado correctamente');
      
      // Verificar autenticaciÃ³n
      updateDebugInfo('ğŸ” Configurando listener de autenticaciÃ³n...');
      
      onAuthStateChanged(auth, async (user) => {
        const statusElement = document.getElementById('admin-status');
        
        if (user) {
          authUser = user;
          updateDebugInfo(`ğŸ‘¤ Usuario autenticado: ${user.email}`);
          
          // Verificar admin
          const adminEmails = ['gfigueroa.w@gmail.com', 'admin@yamevi.com.mx', 'eugenfw@gmail.com'];
          isAdmin = adminEmails.includes(user.email);
          
          updateDebugInfo(`ğŸ” Verificando admin: ${user.email} -> ${isAdmin ? 'SÃ' : 'NO'}`);
          
          if (isAdmin) {
            statusElement.innerHTML = `âœ… Admin: ${user.email}`;
            statusElement.className = 'text-lg font-medium text-green-400';
            
            document.getElementById('connection-status').innerHTML = 
              '<span class="text-green-400">ğŸŸ¢ Conectado como Admin</span>';
              
            updateDebugInfo('ğŸ¯ Cargando datos de administraciÃ³n...');
            
            try {
              // Cargar datos con timeout
              const timeoutPromise = new Promise((_, reject) => 
                setTimeout(() => reject(new Error('Timeout despuÃ©s de 10s')), 10000)
              );
              
              const dataPromise = AdminDataManager.getAllStats();
              const data = await Promise.race([dataPromise, timeoutPromise]);
              
              updateDebugInfo('âœ… Datos cargados exitosamente');
              
              if (data && data.summary) {
                showData(data.summary);
              } else if (data) {
                // Crear summary manualmente
                const summary = {
                  totalUsers: data.users?.totalUsers || data.totalUsers || 0,
                  dailyQueries: data.queries?.dailyQueries || data.dailyQueries || 0,
                  totalAnalysis: data.queries?.totalAnalysis || data.totalAnalysis || 0,
                  databaseSize: data.database?.totalSize || data.database?.totalRecords || 0
                };
                showData(summary);
              } else {
                throw new Error('Datos en formato inesperado');
              }
              
            } catch (dataError) {
              updateDebugInfo(`âŒ Error cargando datos: ${dataError.message}`);
              showError(dataError.message);
            }
            
          } else {
            statusElement.innerHTML = `âŒ Sin permisos: ${user.email}`;
            statusElement.className = 'text-lg font-medium text-red-400';
            
            document.getElementById('connection-status').innerHTML = 
              '<span class="text-red-400">ğŸ”´ Sin permisos de admin</span>';
              
            updateDebugInfo(`âŒ Usuario sin permisos de admin: ${user.email}`);
            showError('Usuario sin permisos de administrador');
          }
          
        } else {
          updateDebugInfo('âŒ Usuario no autenticado');
          statusElement.innerHTML = 'ğŸ”’ No autenticado';
          statusElement.className = 'text-lg font-medium text-yellow-400';
          
          document.getElementById('connection-status').innerHTML = 
            '<span class="text-yellow-400">ğŸŸ¡ Esperando autenticaciÃ³n</span>';
            
          showError('Usuario no autenticado');
        }
      });
      
    } catch (error) {
      console.error('âŒ Error fatal:', error);
      updateDebugInfo(`ğŸ’¥ Error fatal: ${error.message}`);
      showError(`Error fatal: ${error.message}`);
    }
  </script>
</body>
</html>
